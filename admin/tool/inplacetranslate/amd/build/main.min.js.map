{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Javascript main event handler.\r\n *\r\n * @module     tool/inplacetranslate\r\n * @copyright  2024 Devlionco <info@devlion.co>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      4.1\r\n */\r\n\r\nimport {call as fetchMany} from 'core/ajax';\r\nimport {exception as displayException} from 'core/notification';\r\nimport Templates from 'core/templates';\r\nimport {debounce} from 'core/utils';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport ModalEvents from 'core/modal_events';\r\nimport {get_string as getString} from 'core/str';\r\n\r\nconst DEBOUNCE_TIMER = 500;\r\n\r\nlet oldTranslate;\r\n\r\nconst Selectors = {\r\n    targets: {\r\n        menu: 'inplacetranslate_menu',\r\n        menuToggler: 'inplacetranslate_menu_toggler',\r\n        search: 'inplacetranslate_search',\r\n        clearSearchBtn: 'inplacetranslate_clear_search_btn',\r\n        items: 'inplacetranslate-item',\r\n        translatesForm: 'translates_form',\r\n        pageFooter: 'page-footer'\r\n    },\r\n    elements: {}\r\n};\r\n\r\n/**\r\n * Initialize selectors.\r\n */\r\nconst initSelectors = () => {\r\n    Selectors.elements.menu = document.getElementById(Selectors.targets.menu);\r\n    Selectors.elements.menuToggler = document.getElementById(Selectors.targets.menuToggler);\r\n    Selectors.elements.search = document.getElementById(Selectors.targets.search);\r\n    Selectors.elements.clearSearchBtn = document.getElementById(Selectors.targets.clearSearchBtn);\r\n    Selectors.elements.items = document.querySelectorAll('.' + Selectors.targets.items);\r\n};\r\n\r\n/**\r\n * Get translate.\r\n * @param {string} query Search query.\r\n * @returns {any} strings data.\r\n */\r\nconst getTranslate = (query) => fetchMany([{\r\n    methodname: 'tool_inplacetranslate_get_translated_string',\r\n    args: {\r\n        query: query\r\n    }\r\n}])[0];\r\n\r\n/**\r\n * Save translate strings.\r\n * @param {string} identifier Translated string.\r\n * @param {string} translateJson JSON example {string: 'some text', lang: 'en'}.\r\n * @returns {any} strings data.\r\n */\r\n\r\nconst setTranslate = (identifier, translateJson) => fetchMany([{\r\n    methodname: 'tool_inplacetranslate_set_translated_string',\r\n    args: {\r\n        identifier: identifier,\r\n        translateJson: translateJson\r\n    }\r\n}])[0];\r\n\r\nconst clearSearch = () => {\r\n    Selectors.elements.search.value = '';\r\n    Selectors.elements.items.forEach((element) => {\r\n        element.closest('li').classList.add('d-flex');\r\n        element.closest('li').classList.remove('d-none');\r\n    });\r\n};\r\n\r\nconst showClearSearchBtn = () => {\r\n    Selectors.elements.clearSearchBtn.classList.remove('d-none');\r\n};\r\n\r\nconst hideClearSearchBtn = () => {\r\n    Selectors.elements.clearSearchBtn.classList.add('d-none');\r\n};\r\n\r\nconst showSearchResult = (searchQuery) => {\r\n    const htmlRegex = /(<([^>]+)>)/gi;\r\n    Selectors.elements.items.forEach((element) => {\r\n        const text = element.innerHTML.replace(htmlRegex, ' ').trim().toLowerCase();\r\n        const dataset = element.dataset.translate.replace(htmlRegex, ' ').trim().toLowerCase();\r\n        if (text.includes(searchQuery) || dataset.includes(searchQuery)) {\r\n            element.closest('li').classList.add('d-flex');\r\n            element.closest('li').classList.remove('d-none');\r\n        } else {\r\n            element.closest('li').classList.remove('d-flex');\r\n            element.closest('li').classList.add('d-none');\r\n        }\r\n    });\r\n};\r\n\r\nconst addToggleMenuBtn = () => {\r\n    return Templates.renderForPromise('tool_inplacetranslate/togglemenulink', {})\r\n        .then(({html, js}) => {\r\n            const target = document.querySelector('.footer-link') ? '#page-footer .footer-links' : Selectors.elements.pageFooter;\r\n            Templates.prependNodeContents(target, html, js);\r\n            initSelectors();\r\n\r\n            if (Selectors.elements.clearSearchBtn !== null) {\r\n                Selectors.elements.clearSearchBtn.onclick = () => {\r\n                    clearSearch();\r\n                    hideClearSearchBtn();\r\n                };\r\n            }\r\n\r\n            if (Selectors.elements.menuToggler !== null) {\r\n                Selectors.elements.menuToggler.onclick = () => {\r\n                    if (Selectors.elements.menuToggler.classList.contains('shown')) {\r\n                        Selectors.elements.menuToggler.classList.remove('shown');\r\n                        document.body.classList.add('inplacetranslate-menu-shown');\r\n                    } else {\r\n                        Selectors.elements.menuToggler.classList.add('shown');\r\n                        document.body.classList.remove('inplacetranslate-menu-shown');\r\n                    }\r\n                };\r\n            }\r\n\r\n            if (Selectors.elements.search !== null) {\r\n                Selectors.elements.search.addEventListener('keyup', debounce((event) => {\r\n                    event.preventDefault();\r\n                    const searchQuery = event.target.value.toString().toLowerCase().trim();\r\n                    showSearchResult(searchQuery);\r\n                    showClearSearchBtn();\r\n                }, DEBOUNCE_TIMER));\r\n            }\r\n        });\r\n};\r\n\r\nexport const init = () => {\r\n    addToggleMenuBtn();\r\n    document.onclick = (event) => {\r\n        if (event.target.closest('.inplacetranslate-item')) {\r\n            const element = event.target.closest('.inplacetranslate-item');\r\n            const identifier = element.dataset.id.toString();\r\n            oldTranslate = event.target.closest('.inplacetranslate-item').dataset.translate;\r\n            // ActiveString = element.querySelector('.translate').innerText;\r\n            getTranslate(identifier).then(result => showModal(result)).catch((error) => displayException(error));\r\n        }\r\n    };\r\n};\r\n\r\nconst showAlert = () => {\r\n    getString('stringwasupdated', 'tool_inplacetranslate', oldTranslate)\r\n        .then((str) => {\r\n            const alertElement = document.createElement('div');\r\n            alertElement.classList.add('position-fixed', 'alert', 'alert-success', 'alert-dismissible', 'p-3', 'fade', 'show');\r\n            alertElement.setAttribute('role', 'alert');\r\n            alertElement.setAttribute('style', 'top: 15vh; left: 32vw;position: fixed; z-index: 100;');\r\n\r\n\r\n            // Create the close button element\r\n            const closeButton = document.createElement('button');\r\n            closeButton.classList.add('close');\r\n            closeButton.setAttribute('type', 'button');\r\n            closeButton.setAttribute('data-dismiss', 'alert');\r\n\r\n            // Create the span element inside the close button\r\n            const closeSpan = document.createElement('span');\r\n            closeSpan.setAttribute('aria-hidden', 'true');\r\n            closeSpan.textContent = 'Ã—';\r\n\r\n            // Append the elements\r\n            closeButton.appendChild(closeSpan);\r\n            alertElement.appendChild(document.createTextNode(str));\r\n            alertElement.appendChild(closeButton);\r\n\r\n            // Append the alert element to the body\r\n            return document.body.appendChild(alertElement);\r\n        }).catch((error) => displayException(error));\r\n\r\n};\r\n\r\n/* Const findElementsWithText = (result) => {\r\n    const lowercaseQuery = oldTranslate.toLowerCase();\r\n\r\n    const treeWalker = document.createTreeWalker(\r\n        document.body,\r\n        NodeFilter.SHOW_TEXT,\r\n    );\r\n\r\n\r\n    let currentNode = treeWalker.nextNode();\r\n    let matchingElement;\r\n\r\n    // Iterate through all text nodes\r\n    while (currentNode) {\r\n        const parentElement = currentNode.parentElement;\r\n        const nodeText = currentNode.textContent.toLowerCase().trim();\r\n\r\n        // Check if the text content of the node is equal to the query\r\n        if (nodeText === lowercaseQuery) {\r\n            // If the parent element is not already in the list, add it\r\n            matchingElement = parentElement;\r\n            let text = matchingElement.innerText;\r\n            matchingElement.style.boxShadow = \"inset 0 0 30px yellow\";\r\n            matchingElement.innerText = text.replace(oldTranslate, newTranslate);\r\n            if (!parentElement.closest('#' + Selectors.targets.menu)) {\r\n                matchingElement.focus();\r\n                matchingElement.scrollIntoView();\r\n            }\r\n        }\r\n        currentNode = treeWalker.nextNode();\r\n    }\r\n    setTimeout(() => {\r\n        matchingElement.style.boxShadow = 'none';\r\n    }, 2000);\r\n}; */\r\n\r\nconst saveTranslate = (form) => {\r\n    const identifier = form.dataset.id;\r\n    const data = [];\r\n    const text = form.querySelectorAll('textarea');\r\n    // Const currentLang = form.dataset.current;\r\n    text.forEach((el) => {\r\n        data.push({string: el.value.trim(), lang: el.dataset.lang.toLowerCase()});\r\n        /*        If (el.dataset.lang.toLowerCase() === currentLang) {\r\n                   newTranslate = el.value.trim();\r\n               } */\r\n    });\r\n    setTranslate(identifier, JSON.stringify(data)).then(() => showAlert())\r\n        .catch((error) => displayException(error));\r\n};\r\n\r\nconst showModal = async(data) => {\r\n    const templateContext = JSON.parse(data);\r\n    const modal = await ModalFactory.create({\r\n        type: ModalFactory.types.SAVE_CANCEL,\r\n        large: true,\r\n        title: getString('setnewtranslate', 'tool_inplacetranslate'),\r\n        body: Templates.render('tool_inplacetranslate/stringmodal', templateContext),\r\n    });\r\n    modal.show();\r\n    modal.getRoot().on(ModalEvents.save, () => {\r\n        const form = modal.getBody()[0].querySelector('#' + Selectors.targets.translatesForm);\r\n        saveTranslate(form);\r\n        modal.destroy();\r\n    });\r\n};"],"names":["oldTranslate","Selectors","targets","menu","menuToggler","search","clearSearchBtn","items","translatesForm","pageFooter","elements","addToggleMenuBtn","Templates","renderForPromise","then","_ref","html","js","target","document","querySelector","prependNodeContents","getElementById","querySelectorAll","onclick","value","forEach","element","closest","classList","add","remove","contains","body","addEventListener","event","preventDefault","searchQuery","htmlRegex","text","innerHTML","replace","trim","toLowerCase","dataset","translate","includes","showSearchResult","toString","identifier","id","query","methodname","args","result","showModal","catch","error","saveTranslate","form","data","el","push","string","lang","translateJson","setTranslate","JSON","stringify","str","alertElement","createElement","setAttribute","closeButton","closeSpan","textContent","appendChild","createTextNode","async","templateContext","parse","modal","ModalFactory","create","type","types","SAVE_CANCEL","large","title","render","show","getRoot","on","ModalEvents","save","getBody","destroy"],"mappings":"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"}