{"version":3,"file":"charts.min.js","sources":["../src/charts.js"],"sourcesContent":["import * as Str from 'core/str';\nimport $ from 'jquery';\nimport d3 from 'report/advancedoverview/js/d3.v7.min.js';\n\n\nconst chartParams = {\n    gradeColorScheme: ['#b2b2b2', '#003F5B', '#003F5B', '#003F5B', '#003F5B', '#003F5B', '#003F5B'],\n    stateColorScheme: [\"#003F5B\", \"#FFBC00\", \"#5175A8\"],\n\n};\n\nexport const createStateChart = function(parent) {\n\n    let parentCard = $(parent).closest('.card');\n    parentCard.find('.donut-сhart-legend-title').html('');\n    parentCard.find('.donut-сhart-legend-inner').html('');\n    parentCard.find('.donut-сhart').html('');\n\n    let radius = 128 /* Math.round(parentCard.outerWidth() * 0.275) */;\n    let innerRadius = radius * 0.30;\n\n    const state_svg = d3.select(parent)\n        .append(\"svg\")\n        .attr(\"width\", radius)\n        .attr(\"height\", radius)\n        .append(\"g\")\n        .attr(\"transform\", `translate(${radius / 2} ,${radius / 2})`);\n    const color = d3.scaleOrdinal()\n        .range(chartParams.stateColorScheme);\n    const pie = d3.pie()\n        .value(d => d[1].value);\n\n    const state_data = pie(Object.entries(chartParams.state));\n    state_svg\n        .selectAll('whatever')\n        .data(state_data)\n        .join('path')\n        .attr('d', d3.arc()\n            .innerRadius(innerRadius)\n            .outerRadius(radius / 2.1)\n        )\n        .attr('data-type', 'state')\n        .attr('data-index', d => d.data[0])\n        .attr('data-label', d => d.data[1].label)\n        .attr('data-value', d => d.data[1].value)\n        .attr('fill', d => color(d.data[0]))\n        .attr(\"stroke\", \"white\")\n        .style(\"stroke-width\", \"1px\");\n\n    const createLegendRow = (index, label, value) => {\n        let template = `<div class=\"donut-сhart-legend-row\" data-row-type=\"${label}\">\n                        <div class=\"square\" style=\"background-color: ${chartParams.stateColorScheme[index]}\"></div>\n                        <div class=\"card-text\">${value} ${label}</div>\n                </div>`;\n        return $(template);\n    };\n\n    let usersSumm = 0;\n    chartParams.state.forEach((element, index) => {\n        createLegendRow(index, element.label, element.value).appendTo(\".donut-сhart-legend-inner\");\n        usersSumm += +element.value;\n    });\n    var donutChartLegendTitle = Str.get_string('studentsintotal', 'quiz_advancedoverview', usersSumm);\n    // As soon as the string is retrieved, i.e. the promise has been fulfilled,\n    // edit the text of a UI element so that it then is the localized string\n    // Note: $.when can be used with an arbitrary number of promised things\n    $.when(donutChartLegendTitle).done(function(str) {\n        $(\".donut-сhart-legend-title\").text(str);\n    });\n    this.initTooltip(parent, state_svg);\n};\nexport const createGradeChart = function(parent) {\n    // GRADE CHART\n    // ////////////\n    let parentCard = $(parent).closest('.card');\n    parentCard.find('.bar-сhart').html('');\n\n    let width = /* Math.round(parentCard.outerWidth() * 0.90) */ 380;\n    let height = /* Math.round(parentCard.outerHeight() * 0.66) */96;\n\n    // Append the svg object to the body of the page\n    const grade_svg = d3.select(parent)\n        .append(\"svg\")\n        .style(\"overflow\", \"visible\")\n        .attr(\"width\", /* Grade_width + grade_margin.left + grade_margin.right */ width)\n        .attr(\"height\", /* Grade_height + grade_margin.top + grade_margin.bottom */ height + 30)\n        .append(\"g\")\n        // .attr(\"transform\", `translate(${grade_margin.left}, ${grade_margin.top})`);\n        .attr(\"transform\", \"translate(0, 30)\");\n\n\n    let grade_data = chartParams.grade;\n\n    const color = d3.scaleOrdinal()\n        .range(chartParams.gradeColorScheme);\n    // X axis\n    const x = d3.scaleBand()\n        .range([0, width])\n        .domain(grade_data.map(d => d.label))\n        .padding(0.2);\n    grade_svg.append(\"g\")\n        .attr(\"transform\", `translate(0, ${height - 24})`)\n        .call(d3.axisBottom(x).ticks(8, \"$.0f\"))\n        .call(d3.axisBottom(x).tickSize(0))\n        .call(g => g.select(\".domain\").remove())\n        .selectAll(\"text\")\n        .style(\"font-size\", \"0.875rem\")\n        .style(\"text-anchor\", \"center\")\n        .attr(\"transform\", (d, i) => {\n            if (i > 0) {return \"translate(14, 0)\";}  // Move labels for all but the first bar\n            return \"translate(0, 0)\";\n        });\n\n    // Add Y axis\n    const max = d3.max(grade_data, function(d) {\n        return d.value;\n    });\n\n    // If all data == 0.\n    if (max === 0) {\n        height = 0;\n    }\n\n    const y = d3.scaleLinear()\n        .domain([0, max])\n        .range([height, 0]);\n\n    // Bars\n    grade_svg.selectAll(\"mybar\")\n        .data(grade_data)\n        .enter()\n        .append(\"rect\")\n        .attr(\"x\", (d, i) => {\n            let xPosition = x(d.label);\n            if (i > 0) {xPosition += 14;}  // Add 20 pixels of space after the first bar\n            return xPosition + 11;\n        })\n        .attr(\"y\", d => y(d.value))\n        .attr(\"width\", x.bandwidth() - 22)\n        .attr(\"height\", function(d) {\n            let value = height - y(d.value) - 30;\n            return value > 0 ? value : 0;\n        }\n        )\n        .attr('fill', d => color(d))\n        .attr(\"stroke\", \"#707070\")\n        .style(\"stroke-width\", \"1px\")\n        .attr('data-type', 'grade')\n        .attr('data-index', (d, i) => i)\n        .attr('data-label', d => d.label)\n        .attr('data-value', d => d.value);\n\n    this.initTooltip(parent, grade_svg);\n};\nexport const initTooltip = function(target, state_svg) {\n    const tooltipTemplate = `\n                <div class=\"chart-tooltip-header d-flex align-items-center justify-content-between\">\n                    <button type=\"button\" class=\"close-tooltip-btn mr-2\">\n                        <i class=\"fa-regular fa-circle-xmark\"></i>\n                    </button>\n                    <div class=\"chart-tooltip-title\"></div>\n                </div>\n                <div class=\"inner\">\n                    <div class=\"chart-tooltip-body p-2\"></div>\n                </div>\n            `;\n    const userItem = (name, link, disabled) => {\n        if(disabled) {\n            return `<span target=”_blank” class=\"tooltip-link d-block text-decoration-none \">${name}</span>`;\n        } else{\n            return `<a href=\"${link}\" target=”_blank” class=\"tooltip-link d-block\">${name}</a>`;\n        }\n    };\n    // Define tooltip\n    var tooltip = d3.select(target).append('div').attr('class', 'chart-tooltip').html(tooltipTemplate);\n\n    state_svg.on('mouseover', function(d) {\n        if (d.target.localName === 'path' || d.target.localName === 'rect') {\n            let title = `${d.target.dataset.value} ${d.target.dataset.label}`;\n            let type = d.target.dataset.type || '';\n            let index = d.target.dataset.index || '';\n            let users = chartParams[type][index].users || '';\n            let counter = 0;\n            let usersList = '';\n\n            if (users) {\n                users.forEach(el => {\n                    usersList += userItem(el.firstname + ' ' + el.lastname, el.link, el.disabled);\n                    counter += 1;\n                });\n            }\n\n            tooltip.select('.chart-tooltip-title').html(title);\n            tooltip.select('.chart-tooltip-body').html(usersList)\n                .attr('class', counter > 10 ? 'chart-tooltip-body hascolumns' : 'chart-tooltip-body');\n\n            tooltip.style('display', 'block');\n            let tooltipHeight = tooltip.node().offsetHeight;\n            tooltip.style('top', (d.layerY - 8 - (tooltipHeight / 2)) + 'px')\n                .style('left', (d.layerX + 8) + 'px');\n        }\n\n    });\n\n    state_svg.on('mouseout', function() {\n        tooltip.style('display', 'none');\n    });\n    tooltip.on('mouseover', function() {\n        tooltip.style('display', 'block');\n    });\n    tooltip.on('mouseout', function() {\n        tooltip.style('display', 'none');\n    });\n    tooltip.select('.close-tooltip-btn').on('click', function() {\n        tooltip.style('display', 'none');\n    });\n};\n\nexport const initcharts = function(charts) {\n    charts = JSON.parse(charts);\n    let lang = $('html')[0].lang;\n    chartParams.textDirection = 'ltr';\n    if (lang === \"he\") {\n        chartParams.textDirection = 'rtl';\n    }\n\n    chartParams.average = charts.average;\n    chartParams.state = charts.state;\n    chartParams.grade = charts.grade[0].values;\n\n    this.createStateChart(\"#charts_state .donut-сhart\");\n    this.createGradeChart(\"#charts_grade .bar-сhart\");\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","Str","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_jquery","_d3V7Min","chartParams","gradeColorScheme","stateColorScheme","_exports","createStateChart","parent","parentCard","$","closest","find","html","state_svg","d3","select","append","attr","color","scaleOrdinal","range","state_data","pie","value","d","entries","state","selectAll","data","join","arc","innerRadius","radius","outerRadius","label","style","usersSumm","forEach","element","index","createLegendRow","template","appendTo","donutChartLegendTitle","get_string","when","done","str","text","this","initTooltip","createGradeChart","height","grade_svg","grade_data","grade","x","scaleBand","domain","map","padding","axisBottom","ticks","tickSize","g","remove","i","max","y","scaleLinear","enter","xPosition","bandwidth","target","tooltip","on","localName","title","dataset","type","users","counter","usersList","el","userItem","name","link","firstname","lastname","disabled","tooltipHeight","node","offsetHeight","layerY","layerX","initcharts","charts","JSON","parse","lang","textDirection","average","values"],"mappings":"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"}