/**
 * Some UI stuff for table.
 *
 * @package
 * @copyright  2020 Devlion <info@devlion.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author     Devlion Moodle Development <service@devlion.co>
 */
define("quiz_competencyoverview/table",["jquery","jqueryui","core/modal_factory","core/modal_events","core/ajax","core/str","community_social/loadingSpinner"],(function($,jqui,ModalFactory,ModalEvents,Ajax,Str,loading){let actualusers="";return{load:function(quizid,cmid,courseid,lastaccess,_actualusers){actualusers=_actualusers,Ajax.call([{methodname:"quiz_competencyoverview_get_init_params",args:{quizid:quizid,cmid:cmid,courseid:courseid,lastaccess:lastaccess},done:params=>{let hlfilterranges=(params=JSON.parse(params.params)).hlfilterranges,hlfilterrangescolor=params.hlfilterrangescolor,assign=params.assign,users=params.users,currentcourseid=params.courseid,topskills=params.topskills,_quizid=params.quizid,_cmid=params.cmid,complist=params.complist,_lastaccess=params.lastaccess;this.init(hlfilterranges,hlfilterrangescolor,assign,users,currentcourseid,topskills,_quizid,_cmid,complist,_lastaccess)},fail:{}}])},init:function(hlfilterranges,hlfilterrangescolor,assign,users,currentcourseid,topskills,quizid,cmid,complist,lastaccess){let langStrings=[];$("#user-action").prop("disabled",!0),Str.get_strings([{key:"task_from_course",component:"quiz_competencyoverview"},{key:"recommended_task_from_shared_repository",component:"quiz_competencyoverview"},{key:"message_to_students_place",component:"quiz_competencyoverview"},{key:"only_to_stud",component:"quiz_competencyoverview"},{key:"more",component:"quiz_competencyoverview"},{key:"sending",component:"quiz_competencyoverview"},{key:"title_aa",component:"quiz_competencyoverview"},{key:"selection",component:"quiz_competencyoverview"},{key:"course_name",component:"quiz_competencyoverview"},{key:"activity",component:"quiz_competencyoverview"},{key:"recommend_activity_list",component:"quiz_competencyoverview"},{key:"recommend_activity_view",component:"quiz_competencyoverview"},{key:"target_section",component:"quiz_competencyoverview"},{key:"message_to_students_place_edit",component:"quiz_competencyoverview"},{key:"message_to_students_place_view",component:"quiz_competencyoverview"},{key:"ok",component:"quiz_competencyoverview"},{key:"finish",component:"quiz_competencyoverview"},{key:"submit",component:"quiz_competencyoverview"},{key:"back",component:"quiz_competencyoverview"},{key:"stud_list",component:"quiz_competencyoverview"},{key:"default_section_name",component:"quiz_competencyoverview"},{key:"selectall",component:"core"},{key:"deselectall",component:"core"},{key:"competency_list_title",component:"quiz_competencyoverview"}]).then((function(results){langStrings=results})),$(".skill-grade-cell").each((function(){let skillgrade=$(this).data("skill-grade"),cell=$(this);$.each(hlfilterrangescolor,(function(index,value){skillgrade>=value[0]&&skillgrade<=value[1]&&cell.closest("td").addClass(value[3],200)}))})),$(document).on("click",".selected-users",(function(){actionStatus(),setskills()})),$(document).on("click","#user-action",(function(e){e.preventDefault(),function(){aastates={selection:{backButton:!1,nextButton:!1,nextButtonEnabled:!1,nextButtonText:!1,scroll:!1,parent:!1,nextAction:!1,title:langStrings[7]},course:{backButton:!0,nextButton:!0,nextButtonEnabled:!1,nextButtonText:langStrings[15],scroll:!0,parent:"selection",nextAction:"activity",title:langStrings[8]},activity:{backButton:!0,nextButton:!0,nextButtonEnabled:!1,nextButtonText:langStrings[15],scroll:!0,parent:"course",nextAction:"targetsection",title:langStrings[9]},repository:{backButton:!0,nextButton:!1,nextButtonEnabled:!1,nextButtonText:!1,scroll:!0,parent:"selection",nextAction:"item",title:langStrings[10]},item:{backButton:!0,nextButton:!0,nextButtonEnabled:!0,nextButtonText:langStrings[15],scroll:!1,parent:"repository",nextAction:"targetsection",title:langStrings[11]},targetsection:{backButton:!0,nextButton:!0,nextButtonEnabled:!1,nextButtonText:langStrings[15],scroll:!0,parent:"selection",nextAction:"message",title:langStrings[12]},message:{backButton:!0,nextButton:!0,nextButtonEnabled:!0,nextButtonText:langStrings[15],scroll:!1,parent:"selection",nextAction:"finish",title:langStrings[13]},finish:{backButton:!0,nextButton:!0,nextButtonEnabled:!0,nextButtonText:langStrings[16],scroll:!1,parent:"selection",nextAction:"submit",title:langStrings[14]}},currentstate="selection",messagetostudents="";let userslist="";selectedusers.forEach((element=>{userslist+="<li class='p-2'>"+users[element].firstname+" "+users[element].lastname+"</li>"})),setskills();let selcomplist=[];selectedskills.forEach((element=>{selcomplist.push(complist[element])})),modalbody="\n                    <div class='custom_container container'>\n                    <div id='assign_activity_body' class='row'>\n\n                    <div id='aa_main_col' class='col-8 d-flex flex-column justify-content-start'>\n\n                    <div class=\"progress-bar-wrapper\">\n                    <div class=\"progress-bar\">\n                    </div>\n                    <div class=\"progress-bar-item active\">1</div>\n                    <div class=\"progress-bar-item\">2</div>\n                    <div class=\"progress-bar-item\">3</div>\n                    <div class=\"progress-bar-item\">4</div>\n                    <div class=\"progress-bar-item\">5</div>\n\n                    </div>\n\n                    <div id='aa_bk' class=''>\n\n                    </div>\n                    <div id='aa_main' class='d-flex justify-content-center flex-grow-1 overflow-hidden\n                        flex-wrap' style='visibility: hidden;'>\n\n                    </div>\n                    <div id='aa_actions' style='visibility: hidden;' class='d-flex mt-5'>\n                    <button id='backbtn' class=\"btn btn-secondary competencies_wizard-button \n                    competencies_wizard-button-outline mr-20\">"+langStrings[18]+"</button>\n                    <button id='nextbtn' class=\"btn btn-primary competencies_wizard-button d-none\">"+langStrings[16]+"</button>\n                    </div>\n                    </div>\n\n                    <div id='aa_st_list' class='col-4'>\n                    <div class=\"competency-popup-subtitle\">\n                    <h3>"+langStrings[23]+'</h3>\n                    <p class="competency-list">'+selcomplist.join(" | ")+"</p>\n                    </div>\n                    <h3 class=''>"+langStrings[19]+'</h3>\n                    <ul class="aa_scroll_students m-l-0 list-group list-group-flush">\n                    '+userslist+"\n                    </ul>\n                    </div>\n\n                    </div>\n                    </div>\n                    "}(),ModalFactory.create({title:langStrings[6],body:modalbody,large:!0}).then((function(aamodal){mainmodal=aamodal,aamodal.getRoot().on(ModalEvents.hidden,(function(){aamodal.destroy()})),aamodal.getRoot().addClass("competencies_wizard"),aamodal.show(),redrawMain()})).catch()}));let currentstate,selectedsource,selectedcourse,selectedactivity,selecteditem,selectedtargetsection,messagetostudents,modalbody,aastates,mainmodal,selectedusers=[],flow=[],submitted=!1,sentusers=[],selectedskills=[],skillname="",selectall=!0,rows=[],ranges=[];function redrawMain(){let mainbody="";switch(currentstate){case"selection":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(0).addClass("active"),mainbody="\n                            <div class='d-flex mt-100'>\n                            <button id='aa_source_course' type=\"button\" class='aa_h select_source btn-lg btn-block mr-20'>\n                            "+langStrings[0]+"</button>\n                            <button id='aa_source_repository' type=\"button\" class='aa_h select_source btn-lg btn-block'>\n                            "+langStrings[1]+"</button>\n                            </div>\n                            ";break;case"course":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(1).addClass("active"),mainbody="",Ajax.call([{methodname:"quiz_competencyoverview_get_courses",args:{},done:courses=>{let courseslist=JSON.parse(courses.courses),list='<div class="aa_scroll"><div id="aa_course_list" class="list-group list-group-flush">';for(let key in courseslist)list+='<a href="#" class="aa_course list-group-item"\n                                    data-selectedcourseid='+courseslist[key].id+">"+courseslist[key].shortname,list+='&nbsp<span class="text-muted aa_modname">'+courseslist[key].fullname+"</span>",list+="</a>";list+="</div></div>",$("#aa_main").html(list),$("#aa_course_list a").on("click",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_course_list a"),(a=>{$(a).removeClass("active")})),selectedcourse=$(this).data("selectedcourseid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active")})),$("#aa_course_list a").on("dblclick",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_course_list a"),(a=>{$(a).removeClass("active")})),selectedcourse=$(this).data("selectedcourseid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active"),switchState(aastates[currentstate].nextAction)}))},fail:{}}]);break;case"activity":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(2).addClass("active"),mainbody="",courseid=selectedcourse,Ajax.call([{methodname:"quiz_competencyoverview_get_activities",args:{courseid:courseid},done:activities=>{let activitieslist=JSON.parse(activities.activities),list='<div class="aa_scroll"><div id="aa_activity_list" class="list-group list-group-flush">';for(let key in activitieslist)list+='<a href="#" class="aa_activity list-group-item list-group-item-secondary"\n                                    data-selectedactivityid='+activitieslist[key].id+">"+activitieslist[key].shortname,list+='&nbsp<span class="text-muted aa_modname">'+activitieslist[key].modname+"</span>",list+="</a>";list+="</div></div>",$("#aa_main").html(list),$("#aa_activity_list a").on("click",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_activity_list a"),(a=>{$(a).removeClass("active")})),selectedactivity=$(this).data("selectedactivityid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active")})),$("#aa_activity_list a").on("dblclick",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_activity_list a"),(a=>{$(a).removeClass("active")})),selectedactivity=$(this).data("selectedactivityid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active"),switchState(aastates[currentstate].nextAction)}))},fail:{}}]);break;case"repository":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(1).addClass("active"),mainbody="",loading.show(),Ajax.call([{methodname:"quiz_competencyoverview_get_items",args:{skills:selectedskills.join()},done:items=>{loading.remove();let itemslist=JSON.parse(items.items),list='<div class="aa_scroll">\n                                    <div id="aa_item_list" class="list-group list-group-flush px-2">';for(let key in itemslist){list+='<div class="js--cardgroup_title cardgroup_title"><span class="carret-down"></span>'+itemslist[key][0]+'</div><div class="card_wrapper">';for(let key2 in itemslist[key][1])list+=itemslist[key][1][key2].item;list=list.replaceAll("mx-3",""),list=list.replaceAll("flex-xl-nowrap",""),list+="</div>"}list+="</div></div>",$("#aa_main").html(list),$(".js--cardgroup_title").click((function(){$(this).toggleClass("active"),$(this).next().slideToggle()})),$(".quiz_competencyoverview-select-button").off("click"),$(".quiz_competencyoverview-select-button").on("click",(e=>{selecteditem=$(e.target).data("activity_id"),selectedcourse=$(e.target).data("course_id"),switchState(aastates[currentstate].nextAction)}))},fail:{}}]);break;case"item":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(1).addClass("active"),mainbody="",Ajax.call([{methodname:"quiz_competencyoverview_get_item",args:{itemid:selecteditem},done:item=>{let list='<div class="aa_scroll"><div id="aa_item_list" class="list-group list-group-flush">';list+=JSON.parse(item.item),list+="</div></div>",$("#aa_main").html(list),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible")},fail:{}}]);break;case"targetsection":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(2).addClass("active"),mainbody="",Ajax.call([{methodname:"quiz_competencyoverview_get_targetsections",args:{currentcourseid:currentcourseid},done:targetsections=>{let targetsectionslist=JSON.parse(targetsections.sections),imgurl=targetsections.imgurl,coursename=targetsections.coursename,list='<div class="coursename-wrapper">\n                                <div class="coursename-image">\n                                <img src="'.concat(imgurl,'" width="auto" height="auto"/>\n                                </div>\n                                <h3 class="coursename">').concat(coursename,'</h3>\n                                </div>\n                                <div class="aa_scroll"><div id="aa_targetsection_list"\n                                class="list-group list-group-flush">');for(let key in targetsectionslist){let sectionline=targetsectionslist[key].name?targetsectionslist[key].name:langStrings[20]+" "+targetsectionslist[key].section;list+='<a href="#" class="aa_targetsection list-group-item list-group-item-secondary"\n                                    data-selectedtargetsectionid='+targetsectionslist[key].id+">"+sectionline,list+="</a>"}list+="</div></div>",$("#aa_main").html(list),null===imgurl&&$(".coursename-image").remove(),$("#aa_targetsection_list a").on("click",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_targetsection_list a"),(a=>{$(a).removeClass("active")})),selectedtargetsection=$(this).data("selectedtargetsectionid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active")})),$("#aa_targetsection_list a").on("dblclick",(function(e){e.preventDefault(),Array.prototype.forEach.call($("#aa_targetsection_list a"),(a=>{$(a).removeClass("active")})),selectedtargetsection=$(this).data("selectedtargetsectionid"),$("#nextbtn").removeClass("d-none"),$("#nextbtn").css("visibility","visible"),$(this).toggleClass("active"),switchState(aastates[currentstate].nextAction)}))},fail:{}}]);break;case"message":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(3).addClass("active"),mainbody='\n                            <div class="input-group">\n                            <textarea id="messagetostudents" class="form-control" rows="5" aria-label=""\n                            placeholder="'+langStrings[2]+'"></textarea>\n                            </div>\n                            ';break;case"finish":$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(3).addClass("active"),$("#aa_st_list").css("visibility","visible"),mainbody='\n                            <div id="aa_finish" class="">\n                            <div class="alert alert-info" role="alert">\n                            <p>'+langStrings[3]+'</p>\n                            </div>\n                            <div class="">\n                            <div class="text-muted muted">'+messagetostudents+"</div>\n                            </div>\n                            </div>\n                            "}var courseid;$("#aa_main").html(mainbody),$("#aa_main").css("visibility","visible"),$("#backbtn").off("click"),$("#backbtn").on("click",(()=>{switchState(flow.pop(),!0)})),aastates[currentstate].nextButton?($("#nextbtn").addClass("d-none"),aastates[currentstate].nextButtonEnabled&&$("#nextbtn").removeClass("d-none"),$("#nextbtn").text(aastates[currentstate].nextButtonText)):$("#nextbtn").addClass("d-none"),$("#nextbtn").off("click"),$("#nextbtn").on("click",(()=>{submitted||switchState(aastates[currentstate].nextAction),"true"==$("#nextbtn").data("finished")&&(submitted=!1,mainmodal.hide())})),$(".select_source").off("click"),$(".select_source").on("click",(e=>{switch(e.target.id){case"aa_source_course":selectedsource="course",switchState("course");break;case"aa_source_repository":selectedsource="repository",switchState("repository")}})),$("#aa_bk").html(aastates[currentstate].title),aastates[currentstate].nextButton&&($("#nextbtn").value=aastates[currentstate].nextButtonText),aastates[currentstate].backButton?$("#backbtn").css("visibility","visible"):$("#backbtn").css("visibility","hidden"),$("#aa_main_col").fadeIn("slow")}function switchState(state){let back=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"submit"!=state?(back||flow.push(currentstate),"message"==currentstate&&(messagetostudents=$("#messagetostudents").val()),$("#aa_main_col").hide(),currentstate=state,redrawMain()):aaSubmit()}function aaSubmit(){submitted=!0,$("#backbtn").css("visibility","hidden"),$(".progress-bar-item").removeClass("active"),$(".progress-bar-item").eq(4).addClass("active"),$("#aa_st_list").css("visibility","hidden"),$("#aa_main").html('\n                <div class = "bravo-img-wrapper mr-auto">\n                  <h2>'+langStrings[5]+'</h2>\n                  <div class="img-background"\n                    style="background-image: url(\''.concat(M.cfg.wwwroot,"/mod/quiz/report/competencyoverview/pix/bravo.png')\"\n                  </div>\n                </div>\n                "));let selectedusersjoin=selectedusers.join();Ajax.call([{methodname:"quiz_competencyoverview_submit_assignment",args:{selectedusersjoin:selectedusersjoin,selectedsource:selectedsource,selectedcourse:selectedcourse||0,selectedactivity:selectedactivity||0,selecteditem:selecteditem||0,selectedtargetsection:selectedtargetsection,messagetostudents:messagetostudents,currentcourseid:currentcourseid},done:()=>{selectedusers.forEach((element=>{sentusers.push(element.toString())})),$("#mod-quiz-report-competencyoverview-report-table tbody tr").not(".emptyrow").not(".gradedattempt").each((function(){-1!=$.inArray($(this)[0].cells[0].children[0].dataset.selectedUserid,sentusers)&&this.firstElementChild.classList.add("sent")})),$("#nextbtn").data("finished","true")},fail:{}}])}function actionStatus(){selectedusers=[],$(".selected-users").each((function(){$(this).closest("input")[0].checked&&selectedusers.push($(this).closest("input").data("selected-userid"))})),0!=selectedusers.length&&0!=selectedskills.length?($("#user-action").html(assign+" | "+selectedusers.length),$("#user-action").prop("disabled",!1)):($("#user-action").html(assign),$("#user-action").prop("disabled",!0))}function selectallstudents(){$(".selected-users").each((function(){$(this).closest("input")[0].checked=selectall}));let selecttitle=selectall?langStrings[22]:langStrings[21];$("#selectallstudents").html(selecttitle),selectall=!selectall}function setskills(){selectedskills=[],$(".selected-comp").each((function(){$(this)[0].checked&&void 0!==$(this)[0].dataset.compid&&selectedskills.push($(this)[0].dataset.compid)}))}function resetfilters(){rows=[],ranges=[],$("#mod-quiz-report-competencyoverview-report-table tbody tr").not(".emptyrow").not(".gradedattempt").each((function(){$(this).show(200)}))}$("#selectallstudents").on("click",(e=>{e.preventDefault(),resetfilters(),setskills(),selectallstudents(),actionStatus()})),$(".selected-comp").on("click",(()=>{setskills(),actionStatus()})),$(document).on("click","#resetfilters",(function(e){e.preventDefault(),resetfilters(!0),selectall=!1,selectallstudents(),actionStatus()})),ranges=[],rows=[],$(document).on("click",".selected-ranges",(function(e){e.preventDefault(),resetfilters(!0);let r=$(this).data("range");skillname=$(this).closest("div")[0].dataset.skill,ranges.push({skillname:skillname,range:r}),0!=ranges.length?($("#resetfilters").fadeIn("slow"),ranges.forEach((range=>{$("#mod-quiz-report-competencyoverview-report-table tbody tr").not(".emptyrow").not(".gradedattempt").each((function(){let description=$(this).find("[data-skill-name='".concat(range.skillname,"']")).data("description"),skillgrade=$(this).find("[data-skill-name='".concat(range.skillname,"']")).data("skill-grade");skillgrade>=hlfilterranges[range.range][0]&&skillgrade<=hlfilterranges[range.range][1]&&void 0===rows[description]&&(rows[description]=skillgrade)}))})),selectall=!1,selectallstudents(),setskills(),$(".selected-users").each((function(){$("#mod-quiz-report-competencyoverview-report-table tbody tr").not(".emptyrow").not(".gradedattempt").each((function(){let _name=$(this).find("[data-skill-name='".concat(skillname,"']")).data("description");rows.hasOwnProperty(_name)&&($(this)[0].cells[0].firstChild.checked=!0)}))})),actionStatus()):(skillname="",resetfilters(!0),selectall=!1,selectallstudents(),setskills(),actionStatus())})),$(document).on("click",".questionsbycompetency",(function(e){e.preventDefault();let compid=$(this).data("compid"),qset=$(this).data("qset"),comptitle=$(this).data("comptitle");loading.show(),function(compid,cmid,quizid,courseid,qset,comptitle){Ajax.call([{methodname:"quiz_competencyoverview_get_questions_by_competency_table",args:{compid:compid,cmid:cmid,quizid:quizid,courseid:courseid,qset:qset,lastaccess:lastaccess,actualusers:actualusers},done:items=>{loading.remove(),items=JSON.parse(items.questionstable),$("#modalquestions").html(items),$("#questionsbycompetencymodalTitle").html(comptitle),$("#questionsbycompetencymodal").modal()},fail:{}}])}(compid,cmid,quizid,currentcourseid,qset,comptitle)}));let order=!1;$(document).on("click","a.sortcol",(function(e){e.preventDefault(),function(colid,order){let A,B,rows=$("#mod-quiz-report-competencyoverview-report-table tbody tr").not(".emptyrow").not(".gradedattempt").get();rows.sort((function(a,b){return 0==colid?order?(A=$(a).children("td").eq(colid).text().toUpperCase(),B=$(b).children("td").eq(colid).text().toUpperCase()):(A=$(b).children("td").eq(colid).text().toUpperCase(),B=$(a).children("td").eq(colid).text().toUpperCase()):order?(A=$(a).children("td").eq(colid).children("div").data("skill-grade"),B=$(b).children("td").eq(colid).children("div").data("skill-grade")):(A=$(b).children("td").eq(colid).children("div").data("skill-grade"),B=$(a).children("td").eq(colid).children("div").data("skill-grade")),A<B?-1:A>B?1:0})),$.each(rows,(function(index,row){$("#mod-quiz-report-competencyoverview-report-table").children("tbody").append(row)}))}($(this).data("colid"),order),order=!order})),$("label.title").on("click",(function(){$(this).closest(".header-inner").toggleClass("checked")})),$('[data-toggle="tooltip"]').tooltip({placement:"top",selector:"div.skill-grade-cell",trigger:"focus",offset:"20",delay:{show:500,hide:100}})}}}));

//# sourceMappingURL=table.min.js.map