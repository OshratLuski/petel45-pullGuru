define("theme_petel/quiz_timer",["exports","core/notification","core/ajax","core/str","core/templates","theme_petel/humanize_duration"],(function(_exports,_notification,_ajax,Str,Templates,timeHumanizer){var obj;
/**
   * Javascript controller for the aside blocks.
   *
   * @module     theme_petel/quiz_timer
   * @package
   * @copyright  2019 Devlion <info@devlion.co>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @since      3.7
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.showReminder=_exports.setReminder=_exports.init=_exports.getReminder=_exports.checkState=_exports.REMINDER=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj},Str=_interopRequireWildcard(Str),Templates=_interopRequireWildcard(Templates),timeHumanizer=_interopRequireWildcard(timeHumanizer);const SELECTORS={},STRINGS={},TIMER={endtime:0,timeoutid:null,timeLimitTotal:0,start:null,timerEnabled:!1},REMINDER={type:"withoutWarnings",isVisible:!1};_exports.REMINDER=REMINDER;const stop=()=>{TIMER.timeoutid&&clearTimeout(TIMER.timeoutid)},twoDigit=num=>num<10?"0"+num:num,updateTimer=()=>{let secondslefttotal=Math.floor((TIMER.endtime-(new Date).getTime())/1e3);if(secondslefttotal<0||0===secondslefttotal){stop(),SELECTORS.timeupInput.value=1;let form=SELECTORS.timeupInput.closest("form");return form.querySelector("input[name=finishattempt]")&&(form.querySelector("input[name=finishattempt]")[0].value=0),SELECTORS.quizTimecounterLabel.innerText=STRINGS.timeisup,void form.submit()}let secondsleft=secondslefttotal,hours=Math.floor(secondsleft/3600);secondsleft-=3600*hours;let minutes=Math.floor(secondsleft/60);secondsleft-=60*minutes;let left=hours+":"+twoDigit(minutes),minutesBeenPassed=Math.floor((TIMER.timeLimitTotal-secondslefttotal)/60);switch(SELECTORS.quizTimecounterLabel&&(SELECTORS.quizTimecounterLabel.innerText=secondslefttotal>0?STRINGS.timeStr(1e3*secondslefttotal)+" "+STRINGS.minutesleft:STRINGS.timeisup),REMINDER.type){case"withoutWarnings":break;case"every30Min":0!==Math.floor(minutesBeenPassed/30)&&showReminder(hours+":"+ +twoDigit(minutes)+1);break;case"thirtyMinBeforeEnd":30===Math.floor(secondslefttotal/60)&&showReminder(30);break;case"fifteenMinBeforeEnd":15===Math.floor(secondslefttotal/60)&&showReminder(15);break;case"fiveMinBeforeEnd":5===Math.floor(secondslefttotal/60)&&showReminder(5)}let leftPerc=Math.floor(secondslefttotal/TIMER.timeLimitTotal*100);SELECTORS.timelineProgress&&SELECTORS.timelineProgress.setAttribute("title",left),SELECTORS.timelineProgressInner&&(SELECTORS.timelineProgressInner.style.width=leftPerc+"%"),SELECTORS.timeLeftInfo&&(SELECTORS.timeLeftInfo.innerText=STRINGS.timeStr(1e3*secondslefttotal)),TIMER.timeoutid=setTimeout(updateTimer,3e4)},showReminder=function(timeleft){let target=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document.querySelector('[role="main"]');const strings=[{key:"thirteenminutesleftuntiltheend",component:"theme_petel"},{key:"minutesleftuntiltheend",component:"theme_petel",param:{timeleft:timeleft}},{key:"every30minutes",component:"theme_petel"},{key:"thirthyminutesbeforetheend",component:"theme_petel"},{key:"withoutwarnings",component:"theme_petel"}];Str.get_strings(strings).then((function(results){STRINGS.thirteenminutesleftuntiltheend=results[0],STRINGS.minutesleftuntiltheend=results[1],STRINGS.every30Min=results[2],STRINGS.thirtyMinBeforeEnd=results[3],STRINGS.withoutWarnings=results[4],STRINGS.alert=results[5];const context={text:STRINGS.minutesleftuntiltheend};return Templates.renderForPromise("theme_petel/quiz_timer_alert",context).then((_ref=>{let{html:html,js:js}=_ref;return Templates.appendNodeContents(target,html,js)})).catch((ex=>(0,_notification.exception)(ex)))})).catch((ex=>(0,_notification.exception)(ex)))};_exports.showReminder=showReminder;const setReminder=(reminderType,isVisible,cmid)=>{_ajax.default.call([{methodname:"theme_petel_quiz_set_timer_preferences",args:{isvisible:isVisible,cmid:+cmid,remindertype:reminderType},done:response=>{response&&(REMINDER.type=response.remindertype,REMINDER.isVisible=response.isvisible)},fail:error=>(0,_notification.exception)(error)}])};_exports.setReminder=setReminder;const getReminder=cmid=>{_ajax.default.call([{methodname:"theme_petel_quiz_get_timer_preferences",args:{cmid:cmid},done:response=>(REMINDER.type=response.remindertype,REMINDER.isVisible=response.isvisible,updateTimer(),checkState(),response),fail:error=>(0,_notification.exception)(error)}])};_exports.getReminder=getReminder;const checkState=()=>{let text;SELECTORS.displayStopwatch.checked=REMINDER.isVisible,"false"===REMINDER.isVisible||!1===REMINDER.isVisible?(SELECTORS.quizTimeBlockBody.classList.add("hidden"),SELECTORS.reminderInfoWrapper.classList.add("hidden"),SELECTORS.reminderInfoWrapper.classList.remove("d-flex"),SELECTORS.displayStopwatch.parentElement.classList.remove("active"),SELECTORS.quizTimecounterLabelWrapper.classList.add("hidden"),SELECTORS.setAlertTimer.forEach((el=>{el.setAttribute("disabled","true")}))):(SELECTORS.quizTimecounterLabelWrapper.classList.remove("hidden"),SELECTORS.quizTimeBlockBody.classList.remove("hidden"),SELECTORS.reminderInfoWrapper.classList.remove("hidden"),SELECTORS.reminderInfoWrapper.classList.add("d-flex"),SELECTORS.setAlertTimer.forEach((el=>{el.removeAttribute("disabled")})),SELECTORS.displayStopwatch.parentElement.classList.add("active"));for(const[key,value]of Object.entries(STRINGS))key===REMINDER.type&&(text=value);SELECTORS.reminderTypeInfo.innerText=STRINGS.alert+text,SELECTORS.setAlertTimer.forEach((el=>{el.id===REMINDER.type?el.checked=!0:el.checked=!1})),SELECTORS.reminderInfo.classList.remove("hidden")};_exports.checkState=checkState;_exports.init=function(start,timeleft,timelimit,ispreview,progress,attemptid,cmid,userid,answered,totalquestions,timerEnabled,active){TIMER.timerEnabled=timerEnabled;let lang=document.documentElement.lang;"he-kids"===lang&&(lang="he"),TIMER.lang=lang||"en";Str.get_strings([{key:"every30minutes",component:"theme_petel"},{key:"thirthyminutesbeforetheend",component:"theme_petel"},{key:"withoutwarnings",component:"theme_petel"},{key:"fifteenminutesbeforebnd",component:"theme_petel"},{key:"fiveminutesbeforetheend",component:"theme_petel"},{key:"alert",component:"theme_petel"},{key:"timeisup",component:"theme_petel"},{key:"minutesleft",component:"theme_petel"}]).then((function(results){if(STRINGS.every30Min=results[0],STRINGS.thirtyMinBeforeEnd=results[1],STRINGS.withoutWarnings=results[2],STRINGS.fifteenMinBeforeEnd=results[3],STRINGS.fiveMinBeforeEnd=results[4],STRINGS.alert=results[5],STRINGS.timeisup=results[6],STRINGS.minutesleft=results[7],STRINGS.timeStr=timeHumanizer.humanizer({language:TIMER.lang,units:["h","m"],maxDecimalPoints:0}),TIMER.timelimit=+timelimit,SELECTORS.alltimeInfo=document.getElementById("alltime_info"),SELECTORS.displayStopwatch=document.getElementById("displayStopwatch"),SELECTORS.form=document.getElementById("responseform"),SELECTORS.quizProgressLabel=document.getElementById("quiz_progress_label"),SELECTORS.quizTimeBlock=document.getElementById("quiz-time-block"),SELECTORS.quizTimeBlockBody=document.querySelector(".quiz-time-block-body"),SELECTORS.quizTimeBlockWrapper=document.querySelector(".quiz-time-block-wrapper"),SELECTORS.quizTimecounterLabel=document.getElementById("quiz_timecounter_label"),SELECTORS.quizTimecounterLabelWrapper=document.querySelector(".quiz_timecounter_label-wrapper"),SELECTORS.quizTotalLabel=document.getElementById("quiz_total_label"),SELECTORS.reminderInfo=document.querySelector(".reminder-info"),SELECTORS.reminderInfoWrapper=document.querySelector(".reminder-info-wrapper"),SELECTORS.reminderTypeInfo=document.getElementById("reminder_type_info"),SELECTORS.setAlertTimer=document.querySelectorAll('[name="setAlertTimer"]'),SELECTORS.timeLeftInfo=document.getElementById("time_left_info"),SELECTORS.timelineProgress=document.getElementById("timeline_progress"),SELECTORS.timelineProgressInner=document.getElementById("timeline_progress_inner"),SELECTORS.timeupInput=document.querySelector("input[name=timeup]"),SELECTORS.textWrapper=document.querySelector(".text-wrapper"),SELECTORS.turnOffAlerts=document.getElementById("turnoffalerts"),0==+TIMER.timelimit&&(SELECTORS.quizTimecounterLabel.innerText=""),TIMER.timerEnabled){TIMER.start=+start,TIMER.timeLimitTotal=+timelimit,REMINDER.cmid=+cmid;Math.floor(timelimit/3600),Math.floor(timelimit/60);TIMER.endtime=(new Date).getTime()+1e3*start,getReminder(REMINDER.cmid),SELECTORS.alltimeInfo.innerText=STRINGS.timeStr(1e3*TIMER.timeLimitTotal),SELECTORS.setAlertTimer.forEach((el=>{el.onchange=e=>{REMINDER.type=e.target.value,checkState(),setReminder(REMINDER.type,REMINDER.isVisible,REMINDER.cmid)}})),SELECTORS.displayStopwatch.onchange=e=>{REMINDER.isVisible=e.target.checked,checkState(),setReminder(REMINDER.type,REMINDER.isVisible,REMINDER.cmid)},updateTimer()}SELECTORS.quizProgressLabel.innerText=answered,SELECTORS.quizTotalLabel.innerText=totalquestions,SELECTORS.textWrapper.classList.remove("d-none"),active&&(SELECTORS.form.onsubmit=()=>{stop()})})).catch((ex=>(0,_notification.exception)(ex)))}}));

//# sourceMappingURL=quiz_timer.min.js.map