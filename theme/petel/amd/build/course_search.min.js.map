{"version":3,"file":"course_search.min.js","sources":["../src/course_search.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the aside blocks.\n *\n * @module     theme_petel/course_search\n * @package\n * @copyright  2023 Devlion <info@devlion.co>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.7\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/str',\n    'core/notification',\n    'jqueryui',\n], function($, Ajax, Str, Notification) {\n\n    let actimer;\n\n    let strnoresults;\n    let strfoundxresults;\n\n    Str.get_strings([\n        {key: 'noresults', component: 'theme_petel'},\n        {key: 'foundxresults', component: 'theme_petel'}\n    ]).done(function(strings) {\n        strnoresults = strings[0];\n        strfoundxresults = strings[1];\n        }).fail(Notification.exception);\n\n    // Copied from lib/jquery/ui-1.12.1/jquery-ui.js\n    $.widget(\"ui.autocomplete\", $.ui.autocomplete, {\n        options: {\n            messages: {\n                noResults: strnoresults,\n                results: function(amount) {\n                    return amount + strfoundxresults;\n                }\n            }\n        },\n\n        __response: function(content) {\n            var message;\n            this._superApply(arguments);\n            if (this.options.disabled || this.cancelSearch) {\n                return;\n            }\n            if (content && content.length) {\n                message = this.options.messages.results(content.length);\n            } else {\n                message = this.options.messages.noResults;\n            }\n            this.liveRegion.children().hide();\n            $(\"<div>\").text(message).appendTo(this.liveRegion);\n        }\n    });\n\n    var widgetsAutocomplete = $.ui.autocomplete;\n\n    const Selector = {\n        TOP_PAGE_ELEMENT: 'body',\n        PAGE_HEADER: '#page-header',\n        SEARCH_INPUT: '#course_activity_search-input',\n        MENU_ITEM: '.ui-menu-item-wrapper',\n    };\n\n    const Class = {\n        AUTOCOMPLETE: 'ui-autocomplete',\n        AUTOCOMPLETE_PETEL: 'ui-autocomplete-petel ml-auto'\n    };\n\n    const getData = function(request, response) {\n\n        const courseid = $(Selector.SEARCH_INPUT).data('courseid');\n\n        Ajax.call([{\n            methodname: 'theme_petel_course_search',\n            args: {\n                'courseid': courseid,\n                'term': request.term\n            },\n            done: function(r) {\n                const res = JSON.parse(r);\n                if (res.response > 0) {\n                    response(res.data);\n                } else {\n                    Str.get_string('noresults', 'theme_petel')\n                    .done(function(s) {\n                        response([]);\n                        // Response([{\n                        //     url: \"#\",\n                        //     name: s,\n                        // }]);\n                    });\n                }\n            },\n            fail: Notification.exception\n        }]);\n    };\n\n    const bindSearch = function() {\n        $(Selector.SEARCH_INPUT).autocomplete({\n            source: getData,\n            minLength: 2,\n            classes: {\n                [Class.AUTOCOMPLETE]: Class.AUTOCOMPLETE_PETEL,\n            },\n            focus: function() {\n                const menu = $(this).data(\"uiAutocomplete\").menu.element;\n                const focusedElement = menu.find(\"a.ui-state-active\");\n\n                $(Selector.SEARCH_INPUT).attr('aria-activedescendant', focusedElement.attr('id'));\n                menu.find(Selector.MENU_ITEM).attr('aria-selected', 'false');\n                focusedElement.attr('aria-selected', 'true');\n            },\n            create: function() {\n                $(this).data(Class.AUTOCOMPLETE)._renderItem = function(ul, item) {\n                    let row;\n                    ul.attr('role', 'listbox');\n                    if (item.url !== '#') {\n                        const regexp = new RegExp(item.term, \"i\");\n                        row = $('<li class=\"border-bottom\" role=\"presentation\">')\n                            .append(`\n                                <div class=\"link-wrapper\"\n                                <a href=\"${item.url}\" role = \"option\" aria-label=\"${item.name}\">\n                                    ${item.name.replace(regexp, match => `<b>${match}</b>`)}\n                                </a>\n                                </div>\n                            `)\n                            .appendTo(ul);\n                    } else {\n                        row = $('<li class=\"border-bottom\" role = \"presentation\">')\n                            .append(`\n                                <div class=\"link-wrapper\"    \n                                    <a href=\"#\" role = \"option\" aria-label=\"${item.name}\">${item.name}</a>\n                                </div>`)\n                            .appendTo(ul);\n                    }\n                    return row;\n                };\n            },\n            select: function(event, ui) {\n                if (ui.item.url !== '#') {\n                    window.location.href = ui.item.url;\n                }\n            },\n            open: function() {\n                // Resize menu width.\n                $('.ui-autocomplete-petel').css('width', $('#course_activity_search').outerWidth());\n            },\n        });\n    };\n\n    const bindShortSearch = function() {\n        $(Selector.SEARCH_INPUT).on('change keyup keydown', function() {\n            clearTimeout(actimer);\n            $(Selector.SEARCH_INPUT).autocomplete(\"option\", \"minLength\", 2);\n            const term = $(this).val();\n            if (term.trim().length === 1) {\n                    actimer = setTimeout(function() {\n                    $(Selector.SEARCH_INPUT).autocomplete(\"option\", \"minLength\", 1);\n                    $(Selector.SEARCH_INPUT).autocomplete(\"search\");\n                }, 2000);\n            }\n        });\n    };\n\n    const init = function() {\n        bindSearch();\n        bindShortSearch();\n    };\n\n    return {\n        init: init\n    };\n\n});\n"],"names":["define","$","Ajax","Str","Notification","actimer","strnoresults","strfoundxresults","get_strings","key","component","done","strings","fail","exception","widget","ui","autocomplete","options","messages","noResults","results","amount","__response","content","message","_superApply","arguments","this","disabled","cancelSearch","length","liveRegion","children","hide","text","appendTo","Selector","Class","getData","request","response","courseid","data","call","methodname","args","term","r","res","JSON","parse","get_string","s","init","source","minLength","classes","focus","menu","element","focusedElement","find","attr","create","_renderItem","ul","item","row","url","regexp","RegExp","append","name","replace","match","select","event","window","location","href","open","css","outerWidth","on","clearTimeout","val","trim","setTimeout"],"mappings":";;;;;;;;;AAyBAA,mCAAO,CACH,SACA,YACA,WACA,oBACA,aACD,SAASC,EAAGC,KAAMC,IAAKC,kBAElBC,QAEAC,aACAC,iBAEJJ,IAAIK,YAAY,CACZ,CAACC,IAAK,YAAaC,UAAW,eAC9B,CAACD,IAAK,gBAAiBC,UAAW,iBACnCC,MAAK,SAASC,SACbN,aAAeM,QAAQ,GACvBL,iBAAmBK,QAAQ,MACxBC,KAAKT,aAAaU,WAGzBb,EAAEc,OAAO,kBAAmBd,EAAEe,GAAGC,aAAc,CAC3CC,QAAS,CACLC,SAAU,CACNC,UAAWd,aACXe,QAAS,SAASC,eACPA,OAASf,oBAK5BgB,WAAY,SAASC,aACbC,aACCC,YAAYC,WACbC,KAAKV,QAAQW,UAAYD,KAAKE,eAI9BL,QADAD,SAAWA,QAAQO,OACTH,KAAKV,QAAQC,SAASE,QAAQG,QAAQO,QAEtCH,KAAKV,QAAQC,SAASC,eAE/BY,WAAWC,WAAWC,OAC3BjC,EAAE,SAASkC,KAAKV,SAASW,SAASR,KAAKI,gBAIrB/B,EAAEe,GAAGC,mBAEzBoB,sBAGY,gCAHZA,mBAIS,wBAGTC,mBACY,kBADZA,yBAEkB,gCAGlBC,QAAU,SAASC,QAASC,gBAExBC,SAAWzC,EAAEoC,uBAAuBM,KAAK,YAE/CzC,KAAK0C,KAAK,CAAC,CACPC,WAAY,4BACZC,KAAM,UACUJ,cACJF,QAAQO,MAEpBpC,KAAM,SAASqC,SACLC,IAAMC,KAAKC,MAAMH,GACnBC,IAAIR,SAAW,EACfA,SAASQ,IAAIN,MAEbxC,IAAIiD,WAAW,YAAa,eAC3BzC,MAAK,SAAS0C,GACXZ,SAAS,QAQrB5B,KAAMT,aAAaU,oBA4EpB,CACHwC,KANS,WAlETrD,EAAEoC,uBAAuBpB,aAAa,CAClCsC,OAAQhB,QACRiB,UAAW,EACXC,QAAS,EACJnB,oBAAqBA,0BAE1BoB,MAAO,iBACGC,KAAO1D,EAAE2B,MAAMe,KAAK,kBAAkBgB,KAAKC,QAC3CC,eAAiBF,KAAKG,KAAK,qBAEjC7D,EAAEoC,uBAAuB0B,KAAK,wBAAyBF,eAAeE,KAAK,OAC3EJ,KAAKG,KAAKzB,oBAAoB0B,KAAK,gBAAiB,SACpDF,eAAeE,KAAK,gBAAiB,SAEzCC,OAAQ,WACJ/D,EAAE2B,MAAMe,KAAKL,oBAAoB2B,YAAc,SAASC,GAAIC,UACpDC,OACJF,GAAGH,KAAK,OAAQ,WACC,MAAbI,KAAKE,IAAa,OACZC,OAAS,IAAIC,OAAOJ,KAAKpB,KAAM,KACrCqB,IAAMnE,EAAE,kDACHuE,uHAEcL,KAAKE,6CAAoCF,KAAKM,wDACnDN,KAAKM,KAAKC,QAAQJ,QAAQK,oBAAeA,iIAIlDvC,SAAS8B,SAEdE,IAAMnE,EAAE,oDACHuE,8JAEiDL,KAAKM,kBAASN,KAAKM,sDAEpErC,SAAS8B,WAEXE,MAGfQ,OAAQ,SAASC,MAAO7D,IACA,MAAhBA,GAAGmD,KAAKE,MACRS,OAAOC,SAASC,KAAOhE,GAAGmD,KAAKE,MAGvCY,KAAM,WAEFhF,EAAE,0BAA0BiF,IAAI,QAASjF,EAAE,2BAA2BkF,iBAM9ElF,EAAEoC,uBAAuB+C,GAAG,wBAAwB,WAChDC,aAAahF,SACbJ,EAAEoC,uBAAuBpB,aAAa,SAAU,YAAa,GAElC,IADdhB,EAAE2B,MAAM0D,MACZC,OAAOxD,SACR1B,QAAUmF,YAAW,WACrBvF,EAAEoC,uBAAuBpB,aAAa,SAAU,YAAa,GAC7DhB,EAAEoC,uBAAuBpB,aAAa,YACvC"}