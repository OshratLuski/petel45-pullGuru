{"version":3,"file":"downloadactivity.min.js","sources":["../src/downloadactivity.js"],"sourcesContent":["import { call as fetchMany } from 'core/ajax';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport ModalEvents from 'core/modal_events';\r\nimport { get_string as getString } from 'core/str';\r\n\r\nconst Selectors = {\r\n    actions: {\r\n        showDownloadModalBtn: '[data-action=\"show_download_modal\"]',\r\n    },\r\n    targets: {\r\n        activityInstance: '.activity-instance',\r\n    }\r\n};\r\n\r\nconst activityDownloadAjax = (\r\n    cmid,\r\n    courseid,\r\n) => fetchMany([{\r\n    methodname: 'format_flexsections_version_download',\r\n    args: {\r\n        cmid,\r\n        courseid,\r\n    },\r\n}])[0].then(response => {\r\n    return response;\r\n}).catch(error => {\r\n    window.console.error('API call failed:', error);\r\n});\r\n\r\nconst getInfoAjax = (\r\n    cmid,\r\n    courseid,\r\n) => fetchMany([{\r\n    methodname: 'format_flexsections_get_info',\r\n    args: {\r\n        cmid,\r\n        courseid,\r\n    },\r\n}])[0].then(response => {\r\n    return response; // Should log 'everything is ok, mate!'\r\n}).catch(error => {\r\n    window.console.error('API call failed:', error);\r\n});\r\n\r\nconst TEMPOBJ = {};\r\n\r\nconst clearTempObj = () => {\r\n    for (const prop in TEMPOBJ) {\r\n        if (TEMPOBJ.hasOwnProperty(prop)) {\r\n            delete TEMPOBJ[prop];\r\n        }\r\n    }\r\n};\r\n\r\nconst setCancelButtonText = async (target) => {\r\n    const closeText = await getString('close', 'format_flexsections');\r\n    target.innerHTML = closeText;\r\n};\r\n\r\nexport const showModal = async () => {\r\n    const info = await getInfoAjax(TEMPOBJ.cmid, TEMPOBJ.courseid);\r\n    const modal = await ModalFactory.create({\r\n        title: info.title,\r\n        body: info.body,\r\n        type: ModalFactory.types.SAVE_CANCEL,\r\n    });\r\n\r\n    modal.setSaveButtonText(getString('downloadtheversionofthisactivity', 'format_flexsections'));\r\n    modal.getRoot().on(ModalEvents.save, function (e) {\r\n        e.preventDefault();\r\n\r\n        activityDownload(modal.getBody()[0]);\r\n        modal.getFooter()[0].querySelector('[data-action=\"save\"]').disabled = true;\r\n\r\n        setCancelButtonText(modal.getFooter()[0].querySelector('[data-action=\"cancel\"]'));\r\n        clearTempObj();\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.cancel, function () {\r\n        clearTempObj();\r\n        modal.hide();\r\n    });\r\n    modal.show();\r\n};\r\n\r\nconst activityDownload = async (target) => {\r\n    const response = await activityDownloadAjax(+TEMPOBJ.cmid, +TEMPOBJ.courseid);\r\n    target.innerHTML = response;\r\n    return response;\r\n};\r\n\r\nconst getCmIdAndCourseId = (e) => {\r\n    const activityInstance = e.target.closest(Selectors.targets.activityInstance);\r\n    const activitytitle = activityInstance.querySelector('.activitytitle');\r\n    if (activitytitle.nextElementSibling.dataset.cmid.length > 0) {\r\n        TEMPOBJ.cmid = activitytitle.nextElementSibling.dataset.cmid;\r\n    }\r\n    if (activitytitle.nextElementSibling.dataset.courseid.length > 0) {\r\n        TEMPOBJ.courseid = activitytitle.nextElementSibling.dataset.courseid;\r\n    }\r\n};\r\n\r\nexport const init = () => {\r\n    document.addEventListener('click', e => {\r\n        if (e.target.closest(Selectors.actions.showDownloadModalBtn)) {\r\n            e.stopPropagation();\r\n            getCmIdAndCourseId(e);\r\n            showModal(e);\r\n        }\r\n    });\r\n};\r\n"],"names":["Selectors","showDownloadModalBtn","activityInstance","TEMPOBJ","clearTempObj","prop","hasOwnProperty","showModal","async","info","cmid","courseid","methodname","args","then","response","catch","error","window","console","modal","ModalFactory","create","title","body","type","types","SAVE_CANCEL","setSaveButtonText","getRoot","on","ModalEvents","save","e","preventDefault","activityDownload","getBody","getFooter","querySelector","disabled","closeText","target","innerHTML","setCancelButtonText","cancel","hide","show","document","addEventListener","closest","stopPropagation","activitytitle","nextElementSibling","dataset","length","getCmIdAndCourseId"],"mappings":"wdAKMA,kBACO,CACLC,qBAAsB,uCAFxBD,kBAIO,CACLE,iBAAkB,sBAkCpBC,QAAU,GAEVC,aAAe,SACZ,MAAMC,QAAQF,QACXA,QAAQG,eAAeD,cAChBF,QAAQE,OAUdE,UAAYC,gBACfC,WA9BNC,KA8B+BP,QAAQO,KA7BvCC,SA6B6CR,QAAQQ,UA5BpD,cAAU,CAAC,CACZC,WAAY,+BACZC,KAAM,CACFH,KAAAA,KACAC,SAAAA,aAEJ,GAAGG,MAAKC,UACDA,WACRC,OAAMC,QACLC,OAAOC,QAAQF,MAAM,mBAAoBA,WAZzB,IAChBP,KACAC,eA8BMS,YAAcC,uBAAaC,OAAO,CACpCC,MAAOd,KAAKc,MACZC,KAAMf,KAAKe,KACXC,KAAMJ,uBAAaK,MAAMC,cAG7BP,MAAMQ,mBAAkB,mBAAU,mCAAoC,wBACtER,MAAMS,UAAUC,GAAGC,sBAAYC,MAAM,SAAUC,GAC3CA,EAAEC,iBAEFC,iBAAiBf,MAAMgB,UAAU,IACjChB,MAAMiB,YAAY,GAAGC,cAAc,wBAAwBC,UAAW,EAlBlD/B,OAAAA,eAClBgC,gBAAkB,mBAAU,QAAS,uBAC3CC,OAAOC,UAAYF,WAkBfG,CAAoBvB,MAAMiB,YAAY,GAAGC,cAAc,2BACvDlC,kBAGJgB,MAAMS,UAAUC,GAAGC,sBAAYa,QAAQ,WACnCxC,eACAgB,MAAMyB,UAEVzB,MAAM0B,2CAGJX,iBAAmB3B,MAAAA,eACfO,eAvENL,MAuE6CP,QAAQO,KAtErDC,UAsE4DR,QAAQQ,UArEnE,cAAU,CAAC,CACZC,WAAY,uCACZC,KAAM,CACFH,KAAAA,KACAC,SAAAA,aAEJ,GAAGG,MAAKC,UACDA,WACRC,OAAMC,QACLC,OAAOC,QAAQF,MAAM,mBAAoBA,WAZhB,IACzBP,KACAC,gBAuEA8B,OAAOC,UAAY3B,SACZA,wBAcS,KAChBgC,SAASC,iBAAiB,SAASf,IAC3BA,EAAEQ,OAAOQ,QAAQjD,kBAAkBC,wBACnCgC,EAAEiB,kBAdcjB,CAAAA,UAElBkB,cADmBlB,EAAEQ,OAAOQ,QAAQjD,kBAAkBE,kBACrBoC,cAAc,kBACjDa,cAAcC,mBAAmBC,QAAQ3C,KAAK4C,OAAS,IACvDnD,QAAQO,KAAOyC,cAAcC,mBAAmBC,QAAQ3C,MAExDyC,cAAcC,mBAAmBC,QAAQ1C,SAAS2C,OAAS,IAC3DnD,QAAQQ,SAAWwC,cAAcC,mBAAmBC,QAAQ1C,WAQxD4C,CAAmBtB,GACnB1B"}