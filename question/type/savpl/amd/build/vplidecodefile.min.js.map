{"version":3,"file":"vplidecodefile.min.js","sources":["../src/vplidecodefile.js"],"sourcesContent":["// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/\r\n//\r\n// VPL for Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// VPL for Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Code files extension method using ACE editorfiles. Add to VPLFile object.\r\n *\r\n * @copyright 2013 Juan Carlos Rodríguez-del-Pino\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>\r\n */\r\n\r\n/* globals ace */\r\n\r\ndefine(\r\n    [\r\n        'jquery',\r\n        'qtype_savpl/vplutil',\r\n        'qtype_savpl/vplui',\r\n    ],\r\n    function($, VPLUtil, VPLUI) {\r\n        return function() {\r\n            var self = this;\r\n            var editor = null;\r\n            var session = null;\r\n            var readOnly = self.getFileManager().readOnly;\r\n            var getOldContent = this.getContent;\r\n            this.getContent = function() {\r\n                if (!this.isOpen()) {\r\n                    return getOldContent.call(this);\r\n                }\r\n                return editor.getValue();\r\n            };\r\n            var setOldContent = this.setContent;\r\n            this.setContent = function(c) {\r\n                setOldContent.call(this, c);\r\n                if (this.isOpen()) {\r\n                    editor.setValue(c);\r\n                }\r\n            };\r\n            var oldDestroy = this.destroy;\r\n            this.destroy = function() {\r\n                if (this.isOpen()) {\r\n                    editor.destroy();\r\n                }\r\n                oldDestroy.call(this);\r\n            };\r\n            this.setFontSize = function(size) {\r\n                if (this.isOpen()) {\r\n                    editor.setFontSize(size);\r\n                }\r\n            };\r\n            var oldAdjustSize = this.adjustSize;\r\n            this.adjustSize = function() {\r\n                if (oldAdjustSize.call(this)) {\r\n                    editor.resize(true);\r\n                    return true;\r\n                }\r\n                return false;\r\n            };\r\n            this.gotoLine = function(line) {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.gotoLine(line, 0);\r\n                editor.scrollToLine(line, true);\r\n                editor.focus();\r\n                this.updateStatus();\r\n            };\r\n            this.setReadOnly = function(s) {\r\n                readOnly = s;\r\n                if (this.isOpen()) {\r\n                    editor.setReadOnly(s);\r\n                }\r\n            };\r\n            this.isReadOnly = function() {\r\n                return readOnly;\r\n            };\r\n            this.focus = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                var tid = this.getTId();\r\n                // Workaround to remove JQwery-UI background color.\r\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\r\n                editor.focus();\r\n                this.updateStatus();\r\n            };\r\n            this.blur = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.blur();\r\n            };\r\n            this.undo = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.undo();\r\n                editor.focus();\r\n            };\r\n            this.redo = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.redo();\r\n                editor.focus();\r\n            };\r\n            this.selectAll = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.selectAll();\r\n                editor.focus();\r\n            };\r\n            this.hasUndo = function() {\r\n                if (!this.isOpen()) {\r\n                    return false;\r\n                }\r\n                return session.getUndoManager().hasUndo();\r\n            };\r\n            this.hasRedo = function() {\r\n                if (!this.isOpen()) {\r\n                    return false;\r\n                }\r\n                return session.getUndoManager().hasRedo();\r\n            };\r\n            this.hasSelectAll = VPLUtil.returnTrue;\r\n            this.hasFind = VPLUtil.returnTrue;\r\n            this.hasFindReplace = VPLUtil.returnTrue;\r\n            this.hasNext = VPLUtil.returnTrue;\r\n            this.find = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.execCommand('find');\r\n            };\r\n            this.replace = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.execCommand('replace');\r\n            };\r\n            this.next = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.execCommand('findnext');\r\n            };\r\n            this.getAnnotations = function() {\r\n                if (!this.isOpen()) {\r\n                    return [];\r\n                }\r\n                return session.getAnnotations();\r\n            };\r\n            this.setAnnotations = function(a) {\r\n                if (!this.isOpen()) {\r\n                    return false;\r\n                }\r\n                return session.setAnnotations(a);\r\n            };\r\n            this.clearAnnotations = function() {\r\n                if (!this.isOpen()) {\r\n                    return false;\r\n                }\r\n                return session.clearAnnotations();\r\n            };\r\n            this.langSelection = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                var ext = VPLUtil.fileExtension(this.getFileName());\r\n                var lang = (ext !== '') ? VPLUtil.langType(ext) : 'text';\r\n                session.setMode(\"ace/mode/\" + lang);\r\n                this.setLang(lang);\r\n            };\r\n            this.getEditor = function() {\r\n                if (!this.isOpen()) {\r\n                    return false;\r\n                }\r\n                return editor;\r\n            };\r\n            this.setTheme = function(theme) {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                editor.setTheme(\"ace/theme/\" + theme);\r\n            };\r\n            this.updateStatus = function() {\r\n                if (!this.isOpen()) {\r\n                    return;\r\n                }\r\n                var text = '';\r\n                var pos = editor.getCursorPosition();\r\n                var fullname = this.getFileName();\r\n                var name = VPLUtil.getFileName(fullname);\r\n                if (fullname.length > 20 || name != fullname) {\r\n                    text = fullname + ' ';\r\n                }\r\n                text += \"Ln \" + (pos.row + 1) + ', Col ' + (pos.column + 1);\r\n                text += \" \" + VPLUtil.langName(VPLUtil.fileExtension(name));\r\n                VPLUI.showIDEStatus(text);\r\n            };\r\n\r\n            this.open = function() {\r\n                this.showFileName();\r\n                if (typeof ace === 'undefined') {\r\n                    VPLUtil.loadScript(['/ace9/ace.js',\r\n                        '/ace9/ext-language_tools.js'],\r\n                        function() {\r\n                            self.open();\r\n                        });\r\n                    return false;\r\n                }\r\n                if (this.isOpen()) {\r\n                    return editor;\r\n                }\r\n                var fileManager = this.getFileManager();\r\n                var tid = this.getTId();\r\n                // Workaround to remove jquery-ui theme background color.\r\n                $(tid).removeClass('ui-widget-content ui-tabs-panel');\r\n                ace.require(\"ext/language_tools\");\r\n                editor = ace.edit(\"vpl_file\" + this.getId());\r\n                session = editor.getSession();\r\n                editor.setOptions({\r\n                    enableBasicAutocompletion: true,\r\n                    enableSnippets: true,\r\n                });\r\n                editor.setValue(this.getContent());\r\n                editor.setFontSize(fileManager.getFontSize());\r\n                editor.setTheme(\"ace/theme/\" + fileManager.getTheme());\r\n                editor.$blockScrolling = Infinity;\r\n                editor.gotoLine(1, 0);\r\n                editor.setReadOnly(readOnly);\r\n                session.setUseSoftTabs(true);\r\n                session.setTabSize(4);\r\n                // Avoid undo of editor initial content.\r\n                session.setUndoManager(new ace.UndoManager());\r\n                this.setOpen(true);\r\n                this.langSelection();\r\n                // Code to control Paste and drop under restricted editing.\r\n                editor.execCommand('replace');\r\n                var addEventDrop = function() {\r\n                    var tag = $(tid + ' div.ace_search');\r\n                    if (tag.length) {\r\n                        tag.on('drop', fileManager.dropHandler);\r\n                        var button = $('.ace_searchbtn_close');\r\n                        button.trigger('click');\r\n                    } else {\r\n                        setTimeout(addEventDrop, 50);\r\n                    }\r\n                };\r\n                editor.on('change', function() {\r\n                    self.change();\r\n                });\r\n                session.selection.on('changeCursor', function() {\r\n                    self.updateStatus();\r\n                });\r\n                // Try to grant dropHandler installation.\r\n                setTimeout(addEventDrop, 5);\r\n                // Save previous onPaste and change for a new one.\r\n                var prevOnPaste = editor.onPaste;\r\n                editor.onPaste = function(s) {\r\n                    if (fileManager.restrictedEdit) {\r\n                        editor.insert(fileManager.getClipboard());\r\n                    } else {\r\n                        prevOnPaste.call(editor, s);\r\n                    }\r\n                };\r\n                // Control copy and cut (yes cut also use this) for localClipboard.\r\n                editor.on('copy', function(t) {\r\n                    fileManager.setClipboard(t.text);\r\n                });\r\n                $(tid).on('paste', '*', fileManager.restrictedPaste);\r\n                $(tid + ' div.ace_content').on('drop', fileManager.dropHandler);\r\n                $(tid + ' div.ace_content').on('dragover', fileManager.dragoverHandler);\r\n                // Workaround to avoid hidden first line in editor.\r\n                $(tid).find('div.ace_scroller').css('position', 'static');\r\n                this.adjustSize();\r\n                $(tid).find('div.ace_scroller').css('position', 'absolute');\r\n                this.updateStatus();\r\n                return editor;\r\n            };\r\n            this.close = function() {\r\n                this.setOpen(false);\r\n                if (editor === null) {\r\n                    return;\r\n                }\r\n                this.setContent(editor.getValue());\r\n                editor.destroy();\r\n                editor = null;\r\n                session = null;\r\n            };\r\n        };\r\n    }\r\n);\r\n"],"names":["define","$","VPLUtil","VPLUI","self","this","editor","session","readOnly","getFileManager","getOldContent","getContent","isOpen","getValue","call","setOldContent","setContent","c","setValue","oldDestroy","destroy","setFontSize","size","oldAdjustSize","adjustSize","resize","gotoLine","line","scrollToLine","focus","updateStatus","setReadOnly","s","isReadOnly","tid","getTId","removeClass","blur","undo","redo","selectAll","hasUndo","getUndoManager","hasRedo","hasSelectAll","returnTrue","hasFind","hasFindReplace","hasNext","find","execCommand","replace","next","getAnnotations","setAnnotations","a","clearAnnotations","langSelection","ext","fileExtension","getFileName","lang","langType","setMode","setLang","getEditor","setTheme","theme","text","pos","getCursorPosition","fullname","name","length","row","column","langName","showIDEStatus","open","showFileName","ace","loadScript","fileManager","require","edit","getId","getSession","setOptions","enableBasicAutocompletion","enableSnippets","getFontSize","getTheme","$blockScrolling","Infinity","setUseSoftTabs","setTabSize","setUndoManager","UndoManager","setOpen","addEventDrop","tag","on","dropHandler","trigger","setTimeout","change","selection","prevOnPaste","onPaste","restrictedEdit","insert","getClipboard","t","setClipboard","restrictedPaste","dragoverHandler","css","close"],"mappings":"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"}