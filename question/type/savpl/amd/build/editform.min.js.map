{"version":3,"file":"editform.min.js","sources":["../src/editform.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Defines the behavior of the editing form for a vplquestion.\r\n * @copyright  Astor Bizard, 2019\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/* globals ace */\r\ndefine([\r\n    'jquery',\r\n    'jqueryui',\r\n    'core/log',\r\n    'qtype_savpl/vplservice',\r\n    'qtype_savpl/codeeditors',\r\n    'qtype_savpl/scriptsloader',\r\n    ], function($, jqui, log, VPLService, CodeEditors, ScriptsLoader) {\r\n\r\n    /**\r\n     * Set editor content to a new content.\r\n     * This is a hard reset (undo history is cleared).\r\n     * @param {Editor} aceEditor Ace editor object to reset.\r\n     * @param {String} newContent The new content to put in the editor.\r\n     */\r\n    function updateEditorContent(aceEditor, newContent) {\r\n        aceEditor.getSession().setValue(newContent);\r\n        aceEditor.getSession().setUndoManager(new ace.UndoManager());\r\n    }\r\n\r\n    /**\r\n     * Update display of execution files editors.\r\n     * This does not include file tabs nor content updating. This is only a visibility update on some elements.\r\n     */\r\n    function updateExecfilesVisibility() {\r\n        var selectedVpl = $('#id_templatevpl').val() > '';\r\n        var showPrecheckExecfiles = $('#id_precheckpreference').val() == 'diff';\r\n        $('.novplmessage').toggle(!selectedVpl);\r\n        $('#execfileslist, #fitem_id_execfile').toggle(selectedVpl);\r\n\r\n        $('#fitem_id_precheckexecfileslist').toggle(showPrecheckExecfiles);\r\n        $('#precheckexecfileslist, #fitem_id_precheckexecfile').toggle(selectedVpl && showPrecheckExecfiles);\r\n\r\n        // Refresh previously hidden editor (which otherwise does not display correctly).\r\n        if ($('#ace_placeholder_precheckexecfile').length) {\r\n            ace.edit('ace_placeholder_precheckexecfile').resize();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Apply the current VPL template choice to form elements that depends on it (template content, execution files, ...).\r\n     * @param {Boolean} keepContents Whether editors contents should be kept.\r\n     *  This is typically false on initialization, true otherwise.\r\n     */\r\n    function applyTemplateChoice(keepContents) {\r\n        var selectedVpl = $('#id_templatevpl').val();\r\n        updateExecfilesVisibility();\r\n        if (selectedVpl) {\r\n            // Update template content.\r\n            VPLService.call('info', 'reqfile', selectedVpl)\r\n            .then(function(reqfile) {\r\n                var lang = VPLService.langOfFile(reqfile.name);\r\n                // Apply language change on editors.\r\n                $('.code-editor:not(.manylangs) .ace-placeholder').each(function() {\r\n                    ace.edit(this).getSession().setMode('ace/mode/' + lang);\r\n                });\r\n\r\n                // Store lang in hidden form element.\r\n                $('[name=templatelang]').val(lang);\r\n\r\n                if (!keepContents) {\r\n                    // Choice changed (it is not initialization):\r\n                    // Reinitialize template content to its original (VPL) state.\r\n                    updateEditorContent(ace.edit('ace_placeholder_templatecontext'), reqfile.contents);\r\n                }\r\n            })\r\n            .fail(function(message) { // The .catch method doesn't exist as it is a $.Deferred object (and not Promise).\r\n                log.error(message, 'Error retrieving required files info for VPL ' + selectedVpl);\r\n            });\r\n\r\n            // Update execution files.\r\n            VPLService.call('info', 'execfiles', selectedVpl)\r\n            .then(function(execfiles) {\r\n                // Filter new exec files to exclude standard scripts.\r\n                execfiles = execfiles.filter(function(execfile) {\r\n                    return !['vpl_run.sh', 'vpl_debug.sh', 'vpl_evaluate.sh', 'pre_vpl_run.sh'].includes(execfile.name);\r\n                });\r\n\r\n                setupExecfiles(execfiles, keepContents, '#execfileslist',\r\n                        'ace_placeholder_execfile', $('[name=execfiles]'));\r\n                setupExecfiles(execfiles, keepContents, '#precheckexecfileslist',\r\n                        'ace_placeholder_precheckexecfile', $('[name=precheckexecfiles]'));\r\n            })\r\n            .fail(function(message) { // The .catch method doesn't exist as it is a $.Deferred object (and not Promise).\r\n                log.error(message, 'Error retrieving execution files info for VPL ' + selectedVpl);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Setup execution files editor and tabs to specified files.\r\n     * @param {{name: String, contents: String}[]} execfiles Array of execution files.\r\n     * @param {Boolean} keepContents Whether current contents should be kept, or overwritten.\r\n     * @param {String} fileTabs Tabs selector for execution files.\r\n     * @param {String} placeholder Placeholder id for editor.\r\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\r\n     */\r\n    function setupExecfiles(execfiles, keepContents, fileTabs, placeholder, $hiddenField) {\r\n        var aceEditor = ace.edit(placeholder);\r\n        // Empty exec files list.\r\n        var $fileTabs = $(fileTabs).html('');\r\n\r\n        // Create exec files object to store in hidden form element, and create file tabs.\r\n        var execfilesObj = {};\r\n        var initialContents = $hiddenField.val().length > 0 ? JSON.parse($hiddenField.val()) : {};\r\n        execfiles.forEach(function(execfile) {\r\n            var content;\r\n            if (VPLService.isBinary(execfile.name)) {\r\n                // Binary file are not editable here.\r\n                content = 'UNUSED';\r\n            } else {\r\n                content = (keepContents && initialContents[execfile.name]) || execfile.contents;\r\n            }\r\n            execfilesObj[execfile.name] = content;\r\n            $fileTabs.append('<li class=\"execfilename float-left\">' +\r\n                                 '<span class=\"clickable rounded-top' + (content.startsWith('UNUSED') ? ' unused' : '') + '\">' +\r\n                                     execfile.name +\r\n                                 '</span>' +\r\n                             '</li>');\r\n        });\r\n        $hiddenField.val(JSON.stringify(execfilesObj));\r\n\r\n        // Setup file tabs navigation.\r\n        $(fileTabs + ' .execfilename span').click(function(event) {\r\n            if (!$(this).is('.currentfile')) {\r\n                updateExecfile($(fileTabs + ' .currentfile'), $(this), aceEditor, $hiddenField);\r\n            }\r\n            event.preventDefault();\r\n        });\r\n\r\n        // On form submit, write current editor value to the field that will be saved.\r\n        $('input[type=submit]').click(function() {\r\n            storeExecfile($(fileTabs + ' .currentfile').text(), aceEditor.getValue(), $hiddenField);\r\n        });\r\n\r\n        // Initialize/re-initialize editor.\r\n        updateExecfile(null, $(fileTabs + ' .execfilename span').first(), aceEditor, $hiddenField);\r\n    }\r\n\r\n    /**\r\n     * Store a file's content to hidden form element.\r\n     * @param {String} fileName File name.\r\n     * @param {String} fileContent File content.\r\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\r\n     */\r\n    function storeExecfile(fileName, fileContent, $hiddenField) {\r\n        var execfiles = JSON.parse($hiddenField.val());\r\n        execfiles[fileName] = fileContent;\r\n        $hiddenField.val(JSON.stringify(execfiles));\r\n    }\r\n\r\n    /**\r\n     * Update Ace editor and tabs after user swapped to another file.\r\n     * @param {jQuery} $prevFile The previously selected tab.\r\n     * @param {jQuery} $newFile The new tab selected by the user.\r\n     * @param {Editor} aceEditor Ace editor object.\r\n     * @param {jQuery} $hiddenField Hidden form field in which files data is stored.\r\n     */\r\n    function updateExecfile($prevFile, $newFile, aceEditor, $hiddenField) {\r\n        var prevFileContent = aceEditor.getValue();\r\n        if ($prevFile !== null) {\r\n            $prevFile.removeClass('currentfile');\r\n            $prevFile.toggleClass('unused', prevFileContent.startsWith('UNUSED'));\r\n            storeExecfile($prevFile.text(), prevFileContent, $hiddenField);\r\n        }\r\n        $newFile.addClass('currentfile');\r\n        var newFile = $newFile.text();\r\n        if (VPLService.isBinary(newFile)) {\r\n            if ($('.qvpl-binary-file').length == 0) {\r\n                $(aceEditor.container).parent().addClass('invisible');\r\n                $('<pre>')\r\n                .addClass('qvpl-binary-file visible bg-white text-center h-100 p-3 position-relative')\r\n                .css('z-index', '1')\r\n                .text(M.util.get_string('binaryfile', 'mod_vpl'))\r\n                .appendTo($(aceEditor.container));\r\n            }\r\n        } else {\r\n            $('.qvpl-binary-file').remove();\r\n            $(aceEditor.container).parent().removeClass('invisible');\r\n            aceEditor.getSession().setMode('ace/mode/' + VPLService.langOfFile(newFile));\r\n        }\r\n        updateEditorContent(aceEditor, JSON.parse($hiddenField.val())[newFile]);\r\n    }\r\n\r\n    /**\r\n     * Setup behaviour for template VPL change, by displaying a dialog with Overwrite/Merge/Cancel options.\r\n     * The dialog will only show up if there is data to merge/overwrite.\r\n     * @param {String} helpButton HTML fragment for help button.\r\n     */\r\n    function setupTemplateChangeManager(helpButton) {\r\n        var $templateSelect = $('#id_templatevpl');\r\n        var templateChangeMessage = M.util.get_string('templatevplchangeprompt', 'qtype_savpl') + helpButton;\r\n        var $templateChangeDialog = $('<div class=\"py-3\">' + templateChangeMessage + '</div>').dialog({\r\n            autoOpen: false,\r\n            dialogClass: 'vplchangedialog p-3 bg-white',\r\n            title: M.util.get_string('templatevplchange', 'qtype_savpl'),\r\n            closeOnEscape: false,\r\n            modal: true,\r\n            buttons:\r\n            [{\r\n                text: M.util.get_string('overwrite', 'qtype_savpl'),\r\n                'class': 'btn btn-primary mx-1',\r\n                click: function() {\r\n                    // Apply the change without merging.\r\n                    $templateSelect.data('current', $templateSelect.val());\r\n                    $(this).dialog('close');\r\n                    applyTemplateChoice(false);\r\n                }\r\n            },\r\n            {\r\n                text: M.util.get_string('merge', 'qtype_savpl'),\r\n                'class': 'btn btn-primary mx-1',\r\n                click: function() {\r\n                    // Apply the change with merging.\r\n                    $templateSelect.data('current', $templateSelect.val());\r\n                    $(this).dialog('close');\r\n                    applyTemplateChoice(true);\r\n                }\r\n            },\r\n            {\r\n                text: M.util.get_string('cancel', 'moodle'),\r\n                'class': 'btn btn-secondary mx-1',\r\n                click: function() {\r\n                    // Undo select change.\r\n                    $templateSelect.val($templateSelect.data('current'));\r\n                    $(this).dialog('close');\r\n                }\r\n            }],\r\n            open: function() {\r\n                // By default, focus is on help button - make it less aggressive by focusing on the dialog.\r\n                $('.vplchangedialog').focus();\r\n            }\r\n        });\r\n        $templateSelect.focus(function() {\r\n            // Save the previous value to manage cancel.\r\n            $(this).data('current', $(this).val());\r\n        }).change(function() {\r\n            if ($templateSelect.val() && $('[name=execfiles]').val() != '') {\r\n                // There is data to merge/overwrite, open a dialog to prompt the user.\r\n                $templateChangeDialog.dialog('open');\r\n            } else {\r\n                // There is nothing to merge/overwrite, simply apply the change.\r\n                $templateSelect.data('current', $templateSelect.val());\r\n                applyTemplateChoice(false);\r\n            }\r\n        });\r\n    }\r\n\r\n    return {\r\n        setup: function(templateChangeHelpButton, vplVersion) {\r\n            // Setup all form editors.\r\n            CodeEditors.setupFormEditors()\r\n            .done(function() {\r\n                ScriptsLoader.loadVPLUtil(vplVersion, function() {\r\n                    // Setup form behavior (VPL template, execution files, etc).\r\n                    applyTemplateChoice(true);\r\n                    // Manage VPL template change.\r\n                    setupTemplateChangeManager(templateChangeHelpButton);\r\n                    $('#id_precheckpreference').change(updateExecfilesVisibility);\r\n                });\r\n            });\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","jqui","log","VPLService","CodeEditors","ScriptsLoader","updateEditorContent","aceEditor","newContent","getSession","setValue","setUndoManager","ace","UndoManager","updateExecfilesVisibility","selectedVpl","val","showPrecheckExecfiles","toggle","length","edit","resize","applyTemplateChoice","keepContents","call","then","reqfile","lang","langOfFile","name","each","this","setMode","contents","fail","message","error","execfiles","setupExecfiles","filter","execfile","includes","fileTabs","placeholder","$hiddenField","$fileTabs","html","execfilesObj","initialContents","JSON","parse","forEach","content","isBinary","append","startsWith","stringify","click","event","is","updateExecfile","preventDefault","storeExecfile","text","getValue","first","fileName","fileContent","$prevFile","$newFile","prevFileContent","removeClass","toggleClass","addClass","newFile","container","parent","css","M","util","get_string","appendTo","remove","setup","templateChangeHelpButton","vplVersion","setupFormEditors","done","loadVPLUtil","helpButton","$templateSelect","templateChangeMessage","$templateChangeDialog","dialog","autoOpen","dialogClass","title","closeOnEscape","modal","buttons","class","data","open","focus","change"],"mappings":"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"}