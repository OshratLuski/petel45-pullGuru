/**
 * Provides utility methods to setup resizable ace editors into a page.
 * @copyright  Astor Bizard, 2019
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_savpl/codeeditors",["jquery","core/url","core/config","core/ajax","core/notification","core/str"],(function($,url,cfg,Ajax,Notification,Str){var aceTheme,fontSize;function updateChatWindow(_questionid){let _button=$(".aisupport-btn-"+_questionid),_textarea=$(".aisupport-prompt-"+_questionid),_chatwindow=$(".aisupport-chat-window-"+_questionid),_request=_textarea.val();_textarea.val("");let _qaid=_button.data("qaid");_button.attr("disabled",!0),_chatwindow.html(_chatwindow.html()+'<div class="aisupport-chat-response aisupport-chat-response-student"> <div class="aisupport-chat-response-student-inner">'+_request+"</div></div>");let request={methodname:"qtype_savpl_get_aisupport",args:{prompt:_request,userid:_button.data("userid"),qaid:_qaid,questionid:_button.data("questionid"),quizid:_button.data("quizid")}};Ajax.call([request])[0].done((function(data){if(data.result){let langkey=data.isrestricted?"aisupportbtnwithleft":"aisupportbtn";Str.get_strings([{key:"respcopybtn",component:"qtype_savpl"},{key:langkey,component:"qtype_savpl",param:data.airequestsleft}]).then((function(strings){_button.html(strings[1]);let _r=(Math.random()+1).toString(36).substring(7);_chatwindow.html(_chatwindow.html()+'<div class="aisupport-chat-response aisupport-chat-response-ai"><div class="aisupport-chat-response-ai-inner"><span class="aisupport-resp-'+_r+' float-left">'+data.response+'</span><a class="btn btn-primary aisupport-resp-copy float-left" data-respid="'+_r+'" data-qaid="'+_qaid+'">'+strings[0]+'</a></div><img class="aisupport-ai-icon mr-2 ml-2" src="'+M.util.image_url("ai","qtype_savpl")+'"/></div>'),_chatwindow.scrollTop(_chatwindow[0].scrollHeight-_chatwindow[0].clientHeight)})),data.airequestsleft>0&&_button.attr("disabled",!1)}else Notification.addNotification({message:data.message,type:"error"}),_button.attr("disabled",!1)})).fail((function(){_button.attr("disabled",!1),Notification.exception}))}function setupAceEditors($textareas,aceSize,aceLang){var aceEditor,prevY,$placeholderBeingResized=null;return void 0===aceLang&&(aceLang="plain_text"),console.log("$textareas"),console.log($textareas),$textareas.each((function(){var $textarea=$(this),$editorPlaceholder=$("<div>",{width:"100%",height:aceSize,id:"ace_placeholder_"+$textarea.attr("name"),class:"ace-placeholder"}).insertAfter($textarea);$textarea.hide(),$("<div>",{id:"ace_resize_"+$textarea.attr("name"),class:"ace-resize"}).insertAfter($editorPlaceholder).mousedown((function(event){prevY=event.clientY,$placeholderBeingResized=$editorPlaceholder,event.preventDefault()})),console.log("ace"),console.log(ace),aceEditor=ace.edit($editorPlaceholder[0]),console.log("aceEditor"),console.log(aceEditor),aceEditor.setOptions({theme:"ace/theme/"+aceTheme,mode:"ace/mode/"+aceLang}),aceEditor.setFontSize(fontSize),aceEditor.$blockScrolling=1/0,aceEditor.getSession().setValue($textarea.val()),aceEditor.setReadOnly($textarea.is("[readonly]")),$("[type=submit], .qvpl-buttons button").click((function(){$textarea.val(ace.edit("ace_placeholder_"+$textarea.attr("name")).getValue())}))})),$(window).mousemove((function(event){$placeholderBeingResized&&($placeholderBeingResized.height((function(i,height){return height+event.clientY-prevY})),prevY=event.clientY,ace.edit($placeholderBeingResized[0]).resize(),event.preventDefault())})).mouseup((function(){$placeholderBeingResized=null})),aceEditor}function loadAce(){if("undefined"!=typeof ace&&void 0!==aceTheme)return $.Deferred().resolve();var ACESCRIPTLOCATION=url.relativeUrl("/mod/vpl/editor/ace9");return $.when($.ajax({url:ACESCRIPTLOCATION+"/ace.js",dataType:"script",cache:!0,success:function(){ace.config.set("basePath",ACESCRIPTLOCATION)}}),getEditorPreferences().then((function(prefs){aceTheme=prefs.aceTheme,fontSize=prefs.fontSize})))}function getEditorPreferences(){return $.ajax({url:url.relativeUrl("/question/type/savpl/ajax/vplpreferences.json.php"),cache:!0}).promise().then((function(outcome){return{aceTheme:outcome.success?outcome.response.aceTheme:"chrome",fontSize:outcome.success?Number(outcome.response.fontSize):12}}))}return $(document).on("click","[data-action=aisupport]",(function(){updateChatWindow($(this).data("questionid"))})),$(".aisupport-prompt-student").on("keypress",(function(e){13==(e.keyCode?e.keyCode:e.which)&&(e.preventDefault(),updateChatWindow($(this).data("questionid")))})),$(document).on("click",".aisupport-resp-copy",(function(){let _respid=$(this).data("respid"),_qaid=$(this).data("qaid"),_text=$(".aisupport-resp-"+_respid).text();Str.get_strings([{key:"respcopyconfirmtitle",component:"qtype_savpl"},{key:"respcopyconfirmbody",component:"qtype_savpl"},{key:"yes",component:"moodle"},{key:"cancel",component:"moodle"}]).done((function(s){Notification.confirm(s[0],s[1],s[2],s[3],(function(){let _textarea=$(".aisupport-textarea-"+_qaid);if(_textarea){_textarea.html(_text);let placeholder=_textarea.siblings(".ace-placeholder");aceEditor=ace.edit(placeholder[0]),aceEditor.setValue(_text)}}))})).fail(Notification.exception)})),{setupFormEditors:function(){return loadAce().done((function(){console.log("$('.code-editor')"),console.log($(".code-editor")),console.log("$('.code-editor textarea')"),console.log($(".code-editor textarea")),setupAceEditors($(".code-editor textarea"),"170px")}))},setupQuestionEditor:function($textarea,$setTextButtons,lineOffset){return loadAce().done((function(){console.log("setupQuestionEditor $textarea"),console.log($textarea);var aceEditor=setupAceEditors($textarea,"200px",$textarea.data("templatelang"));aceEditor.setOption("firstLineNumber",lineOffset),$setTextButtons.each((function(){var text=$(this).data("text");$(this).removeAttr("data-text"),$(this).click((function(event){aceEditor.getValue()!=text&&aceEditor.setValue(text),event.preventDefault()}))}))}))},getEditorPreferences:getEditorPreferences,saveEditorPreferences:function(aceTheme,fontSize){$.ajax({url:url.relativeUrl("/question/type/vplquestion/ajax/vplpreferences.json.php"),cache:!1,method:"POST",data:{set:{aceTheme:aceTheme,fontSize:Number(fontSize)},sesskey:cfg.sesskey}})},changeFontSize:function(newFontSize){$(".ace-placeholder").each((function(){ace.edit(this).setFontSize(Number(newFontSize))}))},changeTheme:function(newTheme){$(".ace-placeholder").each((function(){ace.edit(this).setOptions({theme:"ace/theme/"+newTheme})}))}}}));

//# sourceMappingURL=codeeditors.min.js.map