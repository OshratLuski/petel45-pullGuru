{"version":3,"file":"scriptsloader.min.js","sources":["../src/scriptsloader.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Provides utility methods to load VPL scripts.\r\n * @copyright  Astor Bizard, 2019\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/* globals VPL_Terminal */\r\n/* globals VPL_Util */\r\ndefine(['jquery', 'core/url', 'core/log'], function($, url, log) {\r\n\r\n    /**\r\n     * Constructor for a scripts loader.\r\n     * @param {String[]} scripts Array of scripts urls, to be loaded sequentially.\r\n     * @param {Boolean} alreadyDefined Whether the scripts are already loaded.\r\n     */\r\n    function Loader(scripts, alreadyDefined) {\r\n        this.loading = false;\r\n        this.loaded = alreadyDefined;\r\n        this.callbacks = [];\r\n        this.scripts = scripts;\r\n    }\r\n\r\n    // Loader for VPLUtil script for VPL pre 3.4.\r\n    // It beforehand loads VPL JQuery scripts.\r\n    var utilLoader = new Loader([\r\n        '/mod/vpl/editor/jquery/jquery-1.9.1.js',\r\n        '/mod/vpl/editor/jquery/jquery-ui-1.10.4.js',\r\n        '/mod/vpl/editor/VPL_jquery_no_conflict.js',\r\n        '/mod/vpl/editor/VPLUtil.js'],\r\n        typeof VPL_Util != 'undefined'); // eslint-disable-line camelcase\r\n\r\n    // Loader for VPLTerminal script for VPL pre 3.4.\r\n    // It beforehand loads XTerm script.\r\n    // Note: it needs VPLUtil to be loaded.\r\n    var terminalLoader = new Loader([\r\n        '/mod/vpl/editor/xterm/term.js',\r\n        '/mod/vpl/editor/VPLTerminal.js'],\r\n        typeof VPL_Terminal != 'undefined'); // eslint-disable-line camelcase\r\n\r\n    /**\r\n     * Load scripts according to given loader.\r\n     * It can be called multiple times but will only load them once.\r\n     * @param {Loader} loader The Loader from which to load scripts.\r\n     * @return {function} A function to be called with a callback as parameter.\r\n     */\r\n    function load(loader) {\r\n        return function(callback) {\r\n            if (loader.loaded) {\r\n                callback();\r\n                return;\r\n            }\r\n            loader.callbacks.push(callback);\r\n            if (loader.loading) {\r\n                return;\r\n            }\r\n            loader.loading = true;\r\n            /**\r\n             * Recursive function to load scripts sequentially.\r\n             * @param {Number} iscript Index of the script to load in the Loader array.\r\n             */\r\n            function loadNextScript(iscript) {\r\n                if (iscript < loader.scripts.length) {\r\n                    $.ajax({\r\n                        url: url.relativeUrl(loader.scripts[iscript]),\r\n                        dataType: 'script',\r\n                        cache: true\r\n                    })\r\n                    .then(function() {\r\n                        loadNextScript(iscript + 1);\r\n                        return;\r\n                    })\r\n                    .catch(log.error);\r\n                } else {\r\n                    loader.loaded = true;\r\n                    loader.callbacks.forEach(function(cb) {\r\n                        cb();\r\n                    });\r\n                }\r\n            }\r\n            loadNextScript(0);\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Load VPLUtil and VPLUI scripts.\r\n     * This function loads either from the loader for VPL prior to 3.4.0, or from AMD module for VPL from 3.4.0 ongoing.\r\n     * @param {Number} vplVersion Version number of the VPL plugin.\r\n     * @param {function} callback A function to be called when VPLUtil is loaded and defined.\r\n     */\r\n    function loadVPLUtil(vplVersion, callback) {\r\n        if (typeof VPLUtil != 'undefined') {\r\n            callback();\r\n        } else {\r\n            var vpl34 = vplVersion >= 2021011014; // VPL version 3.4.0.\r\n            var vpl42 = vplVersion >= 2023072512; // VPL version 4.2.0.\r\n            if (vpl42) {\r\n                require(['qtype_savpl/vplutil', 'qtype_savpl/vplui'], function(VPLUtil, VPLUI) {\r\n                    window.VPLUtil = VPLUtil;\r\n                    window.VPLUI = VPLUI;\r\n                    callback();\r\n                });\r\n            } else if (vpl34) {\r\n                require(['qtype_savpl/vplutil'], function(VPLUtil) {\r\n                    window.VPLUtil = VPLUtil;\r\n                    window.VPLUI = VPLUtil; // Just another pointer to VPLUtil.\r\n                    callback();\r\n                });\r\n            } else {\r\n                load(utilLoader)(function() {\r\n                    window.VPLUtil = VPL_Util; // eslint-disable-line camelcase\r\n                    window.VPLUI = VPL_Util; // Just another pointer to VPLUtil.\r\n                    callback();\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Load VPLTerminal script.\r\n     * This function loads either from the loader for VPL prior to 3.4.0, or from AMD module for VPL from 3.4.0 ongoing.\r\n     * @param {Number} vplVersion Version number of the VPL plugin.\r\n     * @param {function} callback A function to be called when VPLUtil is loaded and defined.\r\n     */\r\n    function loadVPLTerminal(vplVersion, callback) {\r\n        if (typeof VPLTerminal != 'undefined') {\r\n            callback();\r\n        } else {\r\n            var vpl34 = vplVersion >= 2021011014; // VPL version 3.4.0.\r\n            if (vpl34) {\r\n                loadVPLUtil(vplVersion, function() {\r\n                    require(['qtype_savpl/vplterminal'], function(VPLTerminal) {\r\n                        window.VPLTerminal = VPLTerminal;\r\n                        $.ajax({\r\n                            url: url.relativeUrl('/mod/vpl/editor/xterm/term.js'),\r\n                            dataType: 'script',\r\n                            cache: true\r\n                        }).done(callback);\r\n                    });\r\n                });\r\n            } else {\r\n                loadVPLUtil(vplVersion, function() {\r\n                    load(terminalLoader)(function() {\r\n                        window.VPLTerminal = VPL_Terminal; // eslint-disable-line camelcase\r\n                        callback();\r\n                    });\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        loadVPLUtil: loadVPLUtil,\r\n        loadVPLTerminal: loadVPLTerminal\r\n    };\r\n});\r\n"],"names":["define","$","url","log","Loader","scripts","alreadyDefined","this","loading","loaded","callbacks","utilLoader","VPL_Util","terminalLoader","VPL_Terminal","load","loader","callback","push","loadNextScript","iscript","length","ajax","relativeUrl","dataType","cache","then","catch","error","forEach","cb","loadVPLUtil","vplVersion","VPLUtil","vpl34","require","VPLUI","window","loadVPLTerminal","VPLTerminal","done"],"mappings":";;;;;AAuBAA,mCAAO,CAAC,SAAU,WAAY,aAAa,SAASC,EAAGC,IAAKC,KAOxD,SAASC,OAAOC,QAASC,gBACrBC,KAAKC,SAAU,EACfD,KAAKE,OAASH,eACdC,KAAKG,UAAY,GACjBH,KAAKF,QAAUA,QAKnB,IAAIM,WAAa,IAAIP,OAAO,CACxB,yCACA,6CACA,4CACA,8BACmB,oBAAZQ,UAKPC,eAAiB,IAAIT,OAAO,CAC5B,gCACA,kCACuB,oBAAhBU,cAQX,SAASC,KAAKC,QACV,OAAO,SAASC,UACRD,OAAOP,OACPQ,YAGJD,OAAON,UAAUQ,KAAKD,UAClBD,OAAOR,UAGXQ,OAAOR,SAAU,EAKjB,SAASW,eAAeC,SAChBA,QAAUJ,OAAOX,QAAQgB,OACzBpB,EAAEqB,KAAK,CACHpB,IAAKA,IAAIqB,YAAYP,OAAOX,QAAQe,UACpCI,SAAU,SACVC,OAAO,IAEVC,MAAK,WACFP,eAAeC,QAAU,MAG5BO,MAAMxB,IAAIyB,QAEXZ,OAAOP,QAAS,EAChBO,OAAON,UAAUmB,SAAQ,SAASC,IAC9BA,SAIZX,CAAe,MAUvB,SAASY,YAAYC,WAAYf,UAC7B,GAAsB,oBAAXgB,QACPhB,eACG,CACH,IAAIiB,MAAQF,YAAc,WACdA,YAAc,WAEtBG,QAAQ,CAAC,sBAAuB,sBAAsB,SAASF,QAASG,OACpEC,OAAOJ,QAAUA,QACjBI,OAAOD,MAAQA,MACfnB,cAEGiB,MACPC,QAAQ,CAAC,wBAAwB,SAASF,SACtCI,OAAOJ,QAAUA,QACjBI,OAAOD,MAAQH,QACfhB,cAGJF,KAAKJ,WAALI,EAAiB,WACbsB,OAAOJ,QAAUrB,SACjByB,OAAOD,MAAQxB,SACfK,eAuChB,MAAO,CACHc,YAAaA,YACbO,gBA7BJ,SAAyBN,WAAYf,UACP,oBAAfsB,YACPtB,WAIIc,YAAYC,WAFJA,YAAc,WAEE,WACpBG,QAAQ,CAAC,4BAA4B,SAASI,aAC1CF,OAAOE,YAAcA,YACrBtC,EAAEqB,KAAK,CACHpB,IAAKA,IAAIqB,YAAY,iCACrBC,SAAU,SACVC,OAAO,IACRe,KAAKvB,cAIQ,WACpBF,KAAKF,eAALE,EAAqB,WACjBsB,OAAOE,YAAczB,aACrBG,iBAWxB"}