{"version":3,"file":"codeeditors.min.js","sources":["../src/codeeditors.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Provides utility methods to setup resizable ace editors into a page.\r\n * @copyright  Astor Bizard, 2019\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/* globals ace */\r\ndefine(['jquery', 'core/url', 'core/config', 'core/ajax', 'core/notification', 'core/str'], function($, url, cfg, Ajax, Notification, Str) {\r\n\r\n    // Global Ace editor theme and font size to use for all editors.\r\n    var aceTheme;\r\n    var fontSize;\r\n\r\n    $(document).on('click', '[data-action=aisupport]', function() {\r\n        updateChatWindow($(this).data('questionid'));\r\n    });\r\n\r\n    $('.aisupport-prompt-student').on('keypress', function(e) {\r\n        var keycode = (e.keyCode ? e.keyCode : e.which);\r\n        if(keycode == 13) {\r\n            e.preventDefault();\r\n            updateChatWindow($(this).data('questionid'));\r\n        }\r\n    });\r\n\r\n    $(document).on('click', '.aisupport-resp-copy', function() {\r\n        let _respid = $(this).data('respid');\r\n        let _qaid = $(this).data('qaid');\r\n        let _text = $('.aisupport-resp-' + _respid).text();\r\n        Str.get_strings([\r\n            {key: 'respcopyconfirmtitle', component: 'qtype_savpl'},\r\n            {key: 'respcopyconfirmbody', component: 'qtype_savpl'},\r\n            {key: 'yes', component: 'moodle'},\r\n            {key: 'cancel', component: 'moodle'}\r\n        ]).done(function(s) {\r\n            Notification.confirm(s[0], s[1], s[2], s[3], function() {\r\n                let _textarea = $('.aisupport-textarea-' + _qaid);\r\n                if (_textarea) {\r\n                    _textarea.html(_text);\r\n                    let placeholder = _textarea.siblings('.ace-placeholder');\r\n                    aceEditor = ace.edit(placeholder[0]);\r\n                    aceEditor.setValue(_text);\r\n                }\r\n            });\r\n        }).fail(Notification.exception);\r\n    });\r\n\r\n\r\n    function updateChatWindow(_questionid) {\r\n        let _button = $('.aisupport-btn-' + _questionid);;\r\n        let _textarea = $('.aisupport-prompt-' + _questionid);\r\n        let _chatwindow = $('.aisupport-chat-window-' + _questionid);\r\n        let _request = _textarea.val();\r\n        _textarea.val('');\r\n        let _qaid = _button.data('qaid');\r\n        _button.attr(\"disabled\", true);\r\n        _chatwindow.html(_chatwindow.html() + '<div class=\"aisupport-chat-response aisupport-chat-response-student\"> <div class=\"aisupport-chat-response-student-inner\">' + _request + '</div></div>');\r\n        let request = {\r\n            methodname: 'qtype_savpl_get_aisupport',\r\n            args: {\r\n                'prompt': _request,\r\n                'userid': _button.data('userid'),\r\n                'qaid': _qaid,\r\n                'questionid': _button.data('questionid'),\r\n                'quizid': _button.data('quizid'),\r\n            }\r\n        };\r\n        Ajax.call([request])[0].done(function(data) {\r\n            if (data.result) {\r\n                let langkey = data.isrestricted ? 'aisupportbtnwithleft' : 'aisupportbtn';\r\n                Str.get_strings([\r\n                    {key: 'respcopybtn', component: 'qtype_savpl'},\r\n                    {key: langkey, component: 'qtype_savpl', param: data.airequestsleft}\r\n                ])\r\n                    .then(function(strings) {\r\n                        _button.html(strings[1]);\r\n                        let _r = (Math.random() + 1).toString(36).substring(7);\r\n                        _chatwindow.html(_chatwindow.html() +\r\n                            '<div class=\"aisupport-chat-response aisupport-chat-response-ai\">' +\r\n                            '<div class=\"aisupport-chat-response-ai-inner\">' +\r\n                            '<span class=\"aisupport-resp-' + _r + ' float-left\">'\r\n                            + data.response +\r\n                            '</span>' +\r\n                            '<a class=\"btn btn-primary aisupport-resp-copy float-left\" data-respid=\"' + _r + '\" data-qaid=\"' + _qaid + '\">' + strings[0] + '</a>' +\r\n                            '</div>' + '<img class=\"aisupport-ai-icon mr-2 ml-2\" src=\"' + M.util.image_url('ai', 'qtype_savpl') + '\"/>' + '</div>'\r\n                        );\r\n                        _chatwindow.scrollTop(_chatwindow[0].scrollHeight - _chatwindow[0].clientHeight);\r\n                    });\r\n                if (data.airequestsleft > 0) {\r\n                    _button.attr(\"disabled\", false);\r\n                }\r\n            } else {\r\n                Notification.addNotification({\r\n                    message: data.message,\r\n                    type: 'error'\r\n                });\r\n                _button.attr(\"disabled\", false);\r\n            }\r\n        }).fail(function() {\r\n            _button.attr(\"disabled\", false);\r\n            Notification.exception;\r\n        });\r\n    }\r\n    /**\r\n     * Setup each specified textarea with Ace editor, with a vertical resize feature.\r\n     * It inherits readonly attribute from textarea.\r\n     * @param {jQuery} $textareas JQuery set of textareas from which to set up editors.\r\n     * @param {String} aceSize Initial CSS size of editors.\r\n     * @param {String} aceLang (optional) Lang (mode) to setup editors from.\r\n     * @return {Editor} The last editor set up.\r\n     */\r\n    function setupAceEditors($textareas, aceSize, aceLang) {\r\n        var aceEditor;\r\n\r\n        // Vertical resizing.\r\n        var prevY;\r\n        var $placeholderBeingResized = null;\r\n\r\n        if (aceLang === undefined) {\r\n            aceLang = 'plain_text';\r\n        }\r\n\r\n        console.log('$textareas');\r\n        console.log($textareas);\r\n\r\n        $textareas.each(function() {\r\n            var $textarea = $(this);\r\n            var $editorPlaceholder = $('<div>', {\r\n                width: '100%',\r\n                height: aceSize,\r\n                'id': 'ace_placeholder_' + $textarea.attr('name'),\r\n                'class': 'ace-placeholder'\r\n            }).insertAfter($textarea);\r\n            $textarea.hide();\r\n\r\n            $('<div>', {\r\n                'id': 'ace_resize_' + $textarea.attr('name'),\r\n                'class': 'ace-resize'\r\n            }).insertAfter($editorPlaceholder)\r\n            .mousedown(function(event) {\r\n                prevY = event.clientY;\r\n                $placeholderBeingResized = $editorPlaceholder;\r\n                event.preventDefault();\r\n            });\r\n            console.log('ace');\r\n            console.log(ace);\r\n            // This is what creates the Ace editor within the placeholder div.\r\n            aceEditor = ace.edit($editorPlaceholder[0]);\r\n            console.log('aceEditor');\r\n            console.log(aceEditor);\r\n            aceEditor.setOptions({\r\n                theme: 'ace/theme/' + aceTheme,\r\n                mode: 'ace/mode/' + aceLang\r\n            });\r\n            aceEditor.setFontSize(fontSize);\r\n            aceEditor.$blockScrolling = Infinity; // Disable ace warning.\r\n            aceEditor.getSession().setValue($textarea.val());\r\n            aceEditor.setReadOnly($textarea.is('[readonly]'));\r\n\r\n            // On submit or run/check, propagate the changes to textarea.\r\n            $('[type=submit], .qvpl-buttons button').click(function() {\r\n                // Cannot use aceEditor here, as it will have another value later.\r\n                $textarea.val(ace.edit('ace_placeholder_' + $textarea.attr('name')).getValue());\r\n            });\r\n        });\r\n\r\n        $(window).mousemove(function(event) {\r\n            if ($placeholderBeingResized) {\r\n                $placeholderBeingResized.height(function(i, height) {\r\n                    return height + event.clientY - prevY;\r\n                });\r\n                prevY = event.clientY;\r\n                ace.edit($placeholderBeingResized[0]).resize();\r\n                event.preventDefault();\r\n            }\r\n        }).mouseup(function() {\r\n            $placeholderBeingResized = null;\r\n        });\r\n\r\n        return aceEditor;\r\n    }\r\n\r\n    /**\r\n     * Loads Ace script from VPL plugin.\r\n     * @return {Promise} A promise that resolves upon load.\r\n     */\r\n    function loadAce() {\r\n        if (typeof ace !== 'undefined' && typeof aceTheme !== 'undefined') {\r\n            return $.Deferred().resolve();\r\n        }\r\n        var ACESCRIPTLOCATION = url.relativeUrl(\"/mod/vpl/editor/ace9\");\r\n        return $.when(\r\n            $.ajax({\r\n                url: ACESCRIPTLOCATION + '/ace.js',\r\n                dataType: 'script',\r\n                cache: true,\r\n                success: function() {\r\n                    ace.config.set('basePath', ACESCRIPTLOCATION);\r\n                }\r\n            }),\r\n            getEditorPreferences().then(function(prefs) {\r\n                aceTheme = prefs.aceTheme;\r\n                fontSize = prefs.fontSize;\r\n            }),\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Get current preferences for font size and editor theme.\r\n     * @return {Promise} A promise that resolves upon load with an argument that is an object containing fontSize and aceTheme keys.\r\n     */\r\n    function getEditorPreferences() {\r\n        return $.ajax({\r\n            url: url.relativeUrl('/question/type/savpl/ajax/vplpreferences.json.php'),\r\n            cache: true,\r\n        }).promise().then(function(outcome) {\r\n            return {\r\n                aceTheme: outcome.success ? outcome.response.aceTheme : 'chrome',\r\n                fontSize: outcome.success ? Number(outcome.response.fontSize) : 12,\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Save preferences for font size and editor theme.\r\n     * @param {String} aceTheme The new theme.\r\n     * @param {String|Number} fontSize The new font size.\r\n     */\r\n    function saveEditorPreferences(aceTheme, fontSize) {\r\n        $.ajax({\r\n            url: url.relativeUrl('/question/type/vplquestion/ajax/vplpreferences.json.php'),\r\n            cache: false,\r\n            method: 'POST',\r\n            data: {\r\n                set: {\r\n                    aceTheme: aceTheme,\r\n                    fontSize: Number(fontSize),\r\n                },\r\n                sesskey: cfg.sesskey,\r\n            },\r\n        });\r\n    }\r\n\r\n    return {\r\n        // Setup editors in question edition form.\r\n        setupFormEditors: function() {\r\n            return loadAce().done(function() {\r\n                console.log(\"$('.code-editor')\");\r\n                console.log($('.code-editor'));\r\n                console.log(\"$('.code-editor textarea')\");\r\n                console.log($('.code-editor textarea'));\r\n                setupAceEditors($('.code-editor textarea'), '170px');\r\n            });\r\n        },\r\n\r\n        // Setup editor in answer form.\r\n        setupQuestionEditor: function($textarea, $setTextButtons, lineOffset) {\r\n            return loadAce().done(function() {\r\n                console.log(\"setupQuestionEditor $textarea\");\r\n                console.log($textarea);\r\n                // Setup question editor.\r\n                var aceEditor = setupAceEditors($textarea, '200px', $textarea.data('templatelang'));\r\n                // Set first line number to match compilation messages.\r\n                aceEditor.setOption('firstLineNumber', lineOffset);\r\n                // Setup reset and correction buttons (if present, ie. not review mode).\r\n                $setTextButtons.each(function() {\r\n                    var text = $(this).data('text');\r\n                    $(this).removeAttr('data-text');\r\n                    $(this).click(function(event) {\r\n                        if (aceEditor.getValue() != text) {\r\n                            aceEditor.setValue(text);\r\n                        }\r\n                        event.preventDefault();\r\n                    });\r\n                });\r\n            });\r\n        },\r\n\r\n        getEditorPreferences: getEditorPreferences,\r\n\r\n        saveEditorPreferences: saveEditorPreferences,\r\n\r\n        changeFontSize: function(newFontSize) {\r\n            $('.ace-placeholder').each(function() {\r\n                ace.edit(this).setFontSize(Number(newFontSize));\r\n            });\r\n        },\r\n\r\n        changeTheme: function(newTheme) {\r\n            $('.ace-placeholder').each(function() {\r\n                ace.edit(this).setOptions({\r\n                    theme: 'ace/theme/' + newTheme\r\n                });\r\n            });\r\n        },\r\n    };\r\n});\r\n"],"names":["define","$","url","cfg","Ajax","Notification","Str","aceTheme","fontSize","updateChatWindow","_questionid","_button","_textarea","_chatwindow","_request","val","_qaid","data","attr","html","request","methodname","args","call","done","result","langkey","isrestricted","get_strings","key","component","param","airequestsleft","then","strings","_r","Math","random","toString","substring","response","M","util","image_url","scrollTop","scrollHeight","clientHeight","addNotification","message","type","fail","exception","setupAceEditors","$textareas","aceSize","aceLang","aceEditor","prevY","$placeholderBeingResized","undefined","console","log","each","$textarea","this","$editorPlaceholder","width","height","insertAfter","hide","mousedown","event","clientY","preventDefault","ace","edit","setOptions","theme","mode","setFontSize","$blockScrolling","Infinity","getSession","setValue","setReadOnly","is","click","getValue","window","mousemove","i","resize","mouseup","loadAce","Deferred","resolve","ACESCRIPTLOCATION","relativeUrl","when","ajax","dataType","cache","success","config","set","getEditorPreferences","prefs","promise","outcome","Number","document","on","e","keyCode","which","_respid","_text","text","s","confirm","placeholder","siblings","setupFormEditors","setupQuestionEditor","$setTextButtons","lineOffset","setOption","removeAttr","saveEditorPreferences","method","sesskey","changeFontSize","newFontSize","changeTheme","newTheme"],"mappings":"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"}