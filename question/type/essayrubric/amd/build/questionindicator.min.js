define("qtype_essayrubric/questionindicator",["exports","jquery","core/str","core/modal_factory","core/modal_events","core/notification","https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"],(function(_exports,_jquery,Str,_modal_factory,_modal_events,_notification,_tabulatorMin){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_tabulatorMin=_interopRequireDefault(_tabulatorMin);var _default={init:function(input,params,hascapedit,researchquestion){Str.get_strings([{key:"selectall",component:"qtype_essayrubric"},{key:"indicatorid",component:"qtype_essayrubric"},{key:"name",component:"qtype_essayrubric"},{key:"category",component:"qtype_essayrubric"},{key:"model",component:"qtype_essayrubric"},{key:"research",component:"qtype_essayrubric"},{key:"visible",component:"qtype_essayrubric"},{key:"type",component:"qtype_essayrubric"},{key:"weight",component:"qtype_essayrubric"},{key:"totalweight",component:"qtype_essayrubric"},{key:"search",component:"qtype_essayrubric"}]).then((function(results){let table;let availindicators=[];const updateAutocomplete=function(){let cell=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,allvalues=[];allvalues=cell?cell.getColumn()._column.cells.map(((col,i)=>col.value)):tabledata.map(((col,i)=>col.name)),availindicators=[...new Set(params.availindicators.concat(allvalues))],availindicators=availindicators.filter((el=>void 0!==el))};let tabledata=Object.keys(input).map((key=>input[key]));const direction=(0,_jquery.default)("html").attr("dir"),readOnly=researchquestion;let tableoptions={movableRows:hascapedit&&"0"===readOnly,footerElement:"<div class='totalWeight'><span>"+results[9]+"</span> <span id='weightNum'>0</span></div>",height:540,data:tabledata,textDirection:direction,layout:"fitColumns",reactiveData:!0,columns:[{rowHandle:hascapedit,formatter:"handle",headerSort:!1,frozen:!0,width:30,minWidth:30,visible:"0"===readOnly},{field:"isindicatorselected",hozAlign:"center",headerHozAlign:"center",headerSort:!1,editable:"0"===readOnly,formatter:cell=>{const catid=cell.getRow()._row.data.id,value=cell.getValue();return`\n          <input ${"1"===readOnly?"disabled":""} class="n_catch n_catch2" ${hascapedit?"":"disabled=disabled"}\n          type="checkbox" ${value?'checked="checked"':""} name="n_indicators_${catid}[]"\n          id="n_indicators_${catid}"/>\n        `},title:hascapedit?"\n          <span>"+results[0]+`</span>\n          <br>\n          <input ${"1"===readOnly?"disabled":""} class="n_catch_all" type="checkbox" name="n_catch_all" id="n_catch_all"/>\n          `:"<span>"+results[0]+"</span>"},{title:results[2],field:"name",width:"50%",editable:"0"===readOnly,editor:!!hascapedit&&"list",headerFilter:"input",headerFilterPlaceholder:results[10],headerFilterLiveFilter:!0,validator:["unique",(cell,value)=>""!==value&&" "!==value],editorParams:{values:availindicators,autocomplete:!0,allowEmpty:!1,listOnEmpty:!0,freetext:!0,placeholderEmpty:!1},headerSort:!1,cellEdited:function(cell){!function(){let cell=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,row=cell.getRow();params.availindicatorsfull.forEach((element=>{const matchingElement=params.availindicatorsfull.find((element=>element.name===cell.getData().name));matchingElement?row.update({indicatorid:matchingElement.indicatorid}):row.update({indicatorid:null})})),params.availindicatorsfull=params.availindicatorsfull.filter((el=>void 0!==el&&"undefined"!==el))}(cell),updateAutocomplete(cell);for(const column of tableoptions.columns)"name"===column.field&&(column.editorParams.values=availindicators);void 0!==table&&table.replaceData(table.getData())}},{title:results[7],field:"type",width:"20%",editable:"0"===readOnly,editor:!!hascapedit&&"list",editorParams:{values:params.types,allowEmpty:!0,listOnEmpty:!0,clearable:!0},formatter:(cell,formatterParams,onRendered)=>"â€”"===params.types[cell.getValue()]?"":params.types[cell.getValue()],headerSort:!1},{title:results[8],field:"weight",hozAlign:"left",editable:"0"===readOnly,maxWidth:100,headerHozAlign:"center",cellEdited:cell=>{cell.setValue(Number(cell.getValue()))},editor:!!hascapedit}]};updateAutocomplete();for(const column of tableoptions.columns)"name"===column.field&&(column.editorParams.values=availindicators);table=new _tabulatorMin.default("#questionindicatorfulltable-table",tableoptions);const rerenderTotalWeight=()=>{let totalWeightSum=0;document.querySelectorAll(".tabulator-row .tabulator-cell:nth-last-child(2)").forEach((el=>{let currentNum=Number(el.innerText);isNaN(currentNum)||(totalWeightSum+=currentNum)})),(0,_jquery.default)("#weightNum")[0].innerText=totalWeightSum};table.on("cellEdited",(function(cell){rerenderTotalWeight()})),table.on("dataProcessed",(()=>{rerenderTotalWeight(),checkAddEvent()}));const checkAddEvent=()=>{Array.from(document.querySelectorAll(".n_catch2")).forEach((el=>{el.addEventListener("click",(()=>{(0,_jquery.default)(".n_catch2:checked")[0]&&(0,_jquery.default)("#ind_delete").hasClass("disabled")&&(0,_jquery.default)("#ind_delete").removeClass("disabled"),(0,_jquery.default)(".n_catch2:checked")[0]||(0,_jquery.default)("#ind_delete").hasClass("disabled")||(0,_jquery.default)("#ind_delete").addClass("disabled")}))}))};table.on("renderComplete",checkAddEvent),table.on("renderComplete",(()=>{(0,_jquery.default)(".tabulator-row-handle-box").attr("class","icon fa fa-arrows fa-fw  iconsmall")})),hascapedit&&(table.on("tableBuilt",(function(){"1"===readOnly&&((0,_jquery.default)("#ind_addnew")[0].disabled=!0),(0,_jquery.default)("#n_catch_all").change((function(){table.getColumn("isindicatorselected").getCells().forEach((element=>{element.setValue(this.checked)})),(0,_jquery.default)(".n_catch2:checked")[0]&&(0,_jquery.default)("#ind_delete").hasClass("disabled")&&(0,_jquery.default)("#ind_delete").removeClass("disabled"),(0,_jquery.default)(".n_catch2:checked")[0]||(0,_jquery.default)("#ind_delete").hasClass("disabled")||(0,_jquery.default)("#ind_delete").addClass("disabled"),checkAddEvent()})),(0,_jquery.default)("form").submit((e=>{let updatedTableData=table.getData();if(updatedTableData.find((element=>null==element.name)))return require(["core/toast"],(Toast=>{Toast.add("Empty indicator name!",{type:"danger"})})),!1;let datajson=JSON.stringify(updatedTableData);return(0,_jquery.default)("#questionindicatorfulltable").attr("value",datajson),!0}))})),document.getElementById("ind_addnew").addEventListener("click",(function(){if("1"===readOnly)return;let newData=table.getData();newData.push({weight:0}),table.replaceData(newData),checkAddEvent()})),document.getElementById("ind_delete").addEventListener("click",(()=>{const elements=Array.from((0,_jquery.default)(".n_catch2")),oldData=table.getData(),newData=[];elements.forEach(((el,ind)=>{el.checked||newData.push(oldData[ind])})),oldData.length!==newData.length&&Str.get_strings([{key:"labeldeleteindicators",component:"qtype_essayrubric"},{key:"areyoushure",component:"qtype_essayrubric"},{key:"success",component:"qtype_essayrubric"}]).done((function(strings){var modalPromise=_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0],body:strings[1]});_jquery.default.when(modalPromise).then((function(fmodal){return fmodal.setSaveButtonText(strings[2]),fmodal.getRoot().on(_modal_events.default.save,(function(){table.replaceData(newData),(0,_jquery.default)(".n_catch_all")[0].checked=!1,(0,_jquery.default)("#ind_delete").addClass("disabled")})),fmodal})).done((function(modal){modal.show()})).fail(_notification.default.exception)}))})))}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=questionindicator.min.js.map