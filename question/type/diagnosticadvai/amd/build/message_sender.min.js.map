{"version":3,"file":"message_sender.min.js","sources":["../src/message_sender.js"],"sourcesContent":["define(['jquery', 'core/ajax'], function($, Ajax) {\n    return {\n        init: function() {\n            const searchParams = new URLSearchParams(window.location.search);\n            const attemptId = searchParams.get('attempt');\n            const cmId = searchParams.get('cmid');\n            const slot = $('#slot').val();\n            var chatContainer = $('.chat-messages');\n\n            function renderMathJax(element) {\n                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {\n                    MathJax.typesetPromise([element]).catch(function(err) {\n                        console.error('MathJax typesetting failed: ', err);\n                    });\n                } else if (typeof MathJax !== 'undefined' && MathJax.Hub) {\n                    MathJax.Hub.Queue([\"Typeset\", MathJax.Hub, element]);\n                } \n            }\n\n            function loadMessages() {\n                Ajax.call([{\n                    methodname: 'qtype_diagnosticadvai_get_message',\n                    args: { attemptid: attemptId },\n                    done: function(response) {\n                        chatContainer.empty();\n                        response.messages.forEach(function(msg) {\n                            appendMessage(msg.text, msg.sender, msg.timestamp);\n                        });\n                        if (response.messages.length === 0) {\n                            $('.run-button').show();\n                            $('#allbuttons').hide();\n                        } else {\n                            $('.run-button').hide();\n                            $('#allbuttons').show();\n                        }\n                        renderMathJax(chatContainer[0]);\n                    },\n                    fail: function(error) {\n                        console.log(\"Error loading messages:\", error);\n                    }\n                }]);\n            }\n\n            function appendMessage(text, sender, timestamp) {\n                var messageClass = sender === 'user' ? 'user-message right' : 'ai-message left';\n                var messageHtml = '<div class=\"' + messageClass + ' message-container\">' +\n                    '<div class=\"message-bubble\">' +\n                    '<span class=\"message-text\">' + text + '</span>' +\n                    '<span class=\"message-timestamp\">' + timestamp + '</span>' +\n                    '</div>' +\n                    '</div>';\n                var newMessage = $(messageHtml);\n                chatContainer.append(newMessage);\n                chatContainer.scrollTop(chatContainer.prop(\"scrollHeight\"));\n                renderMathJax(newMessage[0]);\n            }\n\n            $(document).on('click', '.run-button', function(event) {\n                event.preventDefault();\n                $(\".btn_aianalytics_spinner_run\").show();\n                $(this).prop(\"disabled\", true);\n                Ajax.call([{\n                    methodname: 'qtype_diagnosticadvai_send_message',\n                    args: { attemptid: attemptId, message: '', cmid: cmId, slot: slot },\n                    done: function(response) {\n                        $('.run-button').hide();\n                        $('#allbuttons').show();\n                        appendMessage(response.reply, 'ai', new Date().toLocaleTimeString());\n                        $(\".btn_aianalytics_spinner\").hide();\n                        $(\".btn_aianalytics_spinner_run\").hide();\n                        $(\".send-button\").prop(\"disabled\", false);\n                    },\n                    fail: function(error) {\n                        console.log(\"AJAX Error:\", error);\n                        appendMessage('Error initiating conversation!', 'ai', new Date().toLocaleTimeString());\n                        $(\".btn_aianalytics_spinner_run\").hide();\n                        $(\".btn_aianalytics_spinner\").hide();\n                        $('.run-button').prop(\"disabled\", false);\n                    }\n                }]);\n            });\n\n            $(document).on('click', '.send-button', function(event) {\n                event.preventDefault();\n                var message = $('#question').val().trim();\n                if (!message) {\n                    return;\n                }\n                $(\".btn_aianalytics_spinner\").show();\n                $(\".send-button\").prop(\"disabled\", true);\n                appendMessage(message, 'user', new Date().toLocaleTimeString());\n                $('#question').val('');\n\n                Ajax.call([{\n                    methodname: 'qtype_diagnosticadvai_send_message',\n                    args: { attemptid: attemptId, message: message, cmid: cmId, slot: slot },\n                    done: function(response) {\n                        appendMessage(response.reply, 'ai', new Date().toLocaleTimeString());\n                        $(\".btn_aianalytics_spinner\").hide();\n                        $(\".send-button\").prop(\"disabled\", false);\n                    },\n                    fail: function(error) {\n                        console.log(\"AJAX Error:\", error);\n                        appendMessage('Error sending message!', 'ai', new Date().toLocaleTimeString());\n                        $(\".btn_aianalytics_spinner\").hide();\n                        $(\".send-button\").prop(\"disabled\", false);\n                    }\n                }]);\n            });\n\n            loadMessages();\n        }\n    };\n});"],"names":["define","$","Ajax","init","searchParams","URLSearchParams","window","location","search","attemptId","get","cmId","slot","val","chatContainer","renderMathJax","element","MathJax","typesetPromise","catch","err","console","error","Hub","Queue","appendMessage","text","sender","timestamp","newMessage","append","scrollTop","prop","document","on","event","preventDefault","show","this","call","methodname","args","attemptid","message","cmid","done","response","hide","reply","Date","toLocaleTimeString","fail","log","trim","empty","messages","forEach","msg","length"],"mappings":"AAAAA,8CAAO,CAAC,SAAU,cAAc,SAASC,EAAGC,YACjC,CACHC,KAAM,iBACIC,aAAe,IAAIC,gBAAgBC,OAAOC,SAASC,QACnDC,UAAYL,aAAaM,IAAI,WAC7BC,KAAOP,aAAaM,IAAI,QACxBE,KAAOX,EAAE,SAASY,UACpBC,cAAgBb,EAAE,2BAEbc,cAAcC,SACI,oBAAZC,SAA2BA,QAAQC,eAC1CD,QAAQC,eAAe,CAACF,UAAUG,OAAM,SAASC,KAC7CC,QAAQC,MAAM,+BAAgCF,QAExB,oBAAZH,SAA2BA,QAAQM,KACjDN,QAAQM,IAAIC,MAAM,CAAC,UAAWP,QAAQM,IAAKP,mBA4B1CS,cAAcC,KAAMC,OAAQC,eAQ7BC,WAAa5B,EANC,gBADY,SAAX0B,OAAoB,qBAAuB,mBAC5C,8EAEkBD,KAFlB,0CAGuBE,UAHvB,uBAOlBd,cAAcgB,OAAOD,YACrBf,cAAciB,UAAUjB,cAAckB,KAAK,iBAC3CjB,cAAcc,WAAW,IAG7B5B,EAAEgC,UAAUC,GAAG,QAAS,eAAe,SAASC,OAC5CA,MAAMC,iBACNnC,EAAE,gCAAgCoC,OAClCpC,EAAEqC,MAAMN,KAAK,YAAY,GACzB9B,KAAKqC,KAAK,CAAC,CACPC,WAAY,qCACZC,KAAM,CAAEC,UAAWjC,UAAWkC,QAAS,GAAIC,KAAMjC,KAAMC,KAAMA,MAC7DiC,KAAM,SAASC,UACX7C,EAAE,eAAe8C,OACjB9C,EAAE,eAAeoC,OACjBZ,cAAcqB,SAASE,MAAO,MAAM,IAAIC,MAAOC,sBAC/CjD,EAAE,4BAA4B8C,OAC9B9C,EAAE,gCAAgC8C,OAClC9C,EAAE,gBAAgB+B,KAAK,YAAY,IAEvCmB,KAAM,SAAS7B,OACXD,QAAQ+B,IAAI,cAAe9B,OAC3BG,cAAc,iCAAkC,MAAM,IAAIwB,MAAOC,sBACjEjD,EAAE,gCAAgC8C,OAClC9C,EAAE,4BAA4B8C,OAC9B9C,EAAE,eAAe+B,KAAK,YAAY,UAK9C/B,EAAEgC,UAAUC,GAAG,QAAS,gBAAgB,SAASC,OAC7CA,MAAMC,qBACFO,QAAU1C,EAAE,aAAaY,MAAMwC,OAC9BV,UAGL1C,EAAE,4BAA4BoC,OAC9BpC,EAAE,gBAAgB+B,KAAK,YAAY,GACnCP,cAAckB,QAAS,QAAQ,IAAIM,MAAOC,sBAC1CjD,EAAE,aAAaY,IAAI,IAEnBX,KAAKqC,KAAK,CAAC,CACPC,WAAY,qCACZC,KAAM,CAAEC,UAAWjC,UAAWkC,QAASA,QAASC,KAAMjC,KAAMC,KAAMA,MAClEiC,KAAM,SAASC,UACXrB,cAAcqB,SAASE,MAAO,MAAM,IAAIC,MAAOC,sBAC/CjD,EAAE,4BAA4B8C,OAC9B9C,EAAE,gBAAgB+B,KAAK,YAAY,IAEvCmB,KAAM,SAAS7B,OACXD,QAAQ+B,IAAI,cAAe9B,OAC3BG,cAAc,yBAA0B,MAAM,IAAIwB,MAAOC,sBACzDjD,EAAE,4BAA4B8C,OAC9B9C,EAAE,gBAAgB+B,KAAK,YAAY,WArF3C9B,KAAKqC,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CAAEC,UAAWjC,WACnBoC,KAAM,SAASC,UACXhC,cAAcwC,QACdR,SAASS,SAASC,SAAQ,SAASC,KAC/BhC,cAAcgC,IAAI/B,KAAM+B,IAAI9B,OAAQ8B,IAAI7B,cAEX,IAA7BkB,SAASS,SAASG,QAClBzD,EAAE,eAAeoC,OACjBpC,EAAE,eAAe8C,SAEjB9C,EAAE,eAAe8C,OACjB9C,EAAE,eAAeoC,QAErBtB,cAAcD,cAAc,KAEhCqC,KAAM,SAAS7B,OACXD,QAAQ+B,IAAI,0BAA2B9B"}