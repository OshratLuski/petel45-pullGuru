function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("qtype_shortmath/editor_page",["exports","core/notification","qtype_shortmath/api_helpers","qtype_shortmath/visual-math-input"],(function(_exports,_notification,_api_helpers,_visualMathInput){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=_superPropBase(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},_get.apply(this,arguments)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function set(target,property,value,receiver){return set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(target,property,value,receiver){var desc,base=_superPropBase(target,property);if(base){if((desc=Object.getOwnPropertyDescriptor(base,property)).set)return desc.set.call(receiver,value),!0;if(!desc.writable)return!1}if(desc=Object.getOwnPropertyDescriptor(receiver,property)){if(!desc.writable)return!1;desc.value=value,Object.defineProperty(receiver,property,desc)}else _defineProperty(receiver,property,value);return!0},set(target,property,value,receiver)}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(self)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initialize=void 0,_notification=_interopRequireDefault(_notification),_visualMathInput=_interopRequireDefault(_visualMathInput);var dragged,nodes,draggedIndex,EditorInput=function(_VisualMath$Input){_inherits(EditorInput,_VisualMath$Input);var _super=_createSuper(EditorInput);function EditorInput(input,parent){var _this;_classCallCheck(this,EditorInput),(_this=_super.call(this,input,parent)).textarea.addEventListener("focusout",(function(){_assertThisInitialized(_this)})),_this.rawInput.setAttribute("required",!0),_this.rawInput.classList.add("form-control");var errorDiv=document.createElement("div");return errorDiv.classList.add("invalid-feedback","text-nowrap"),_this.parent.appendChild(errorDiv),_this}return _createClass(EditorInput,[{key:"change",value:function(){!function(target,property,value,receiver,isStrict){if(!set(target,property,value,receiver||target)&&isStrict)throw new Error("failed to set property")}(_getPrototypeOf(EditorInput.prototype),"onEdit",(function(rawInput,mathInput){rawInput.value=mathInput.latex(),rawInput.dispatchEvent(new Event("change"))}),this,!0)}}]),EditorInput}(_visualMathInput.default.Input),EditorControl=function(_VisualMath$Control){_inherits(EditorControl,_VisualMath$Control);var _super2=_createSuper(EditorControl);function EditorControl(name,text,onClick,command){var _this2;return _classCallCheck(this,EditorControl),(_this2=_super2.call(this,name,text,onClick)).command=command,_this2}return _createClass(EditorControl,[{key:"enable",value:function(){_get(_getPrototypeOf(EditorControl.prototype),"enable",this).call(this),this.element.id=this.name,this.element.setAttribute("draggable",!0),this.element.addEventListener("dragstart",(function(event){dragged=event.target,nodes=Array.from(dragged.parentNode.children),draggedIndex=nodes.indexOf(dragged),event.dataTransfer.setData("text",event.target.id),event.dataTransfer.dropEffect="move",document.querySelector(".delete-box").classList.remove("d-none")})),this.element.addEventListener("dragend",(function(event){event.target.style.opacity="",null!==document.getElementById("placeholder")&&document.getElementById("placeholder").replaceWith(dragged),document.querySelector(".delete-box").classList.add("d-none")}))}}]),EditorControl}(_visualMathInput.default.Control),EditorControlList=function(_VisualMath$ControlLi){_inherits(EditorControlList,_VisualMath$ControlLi);var _super3=_createSuper(EditorControlList);function EditorControlList(wrapper){return _classCallCheck(this,EditorControlList),_super3.call(this,wrapper)}return _createClass(EditorControlList,[{key:"add",value:function(buttonMathInput,expressionMathInput){var mathquillExpressionString=buttonMathInput.__controller.container[0].querySelector(".mq-root-block").outerHTML;return this.addControl("btn_"+Date.now(),mathquillExpressionString,expressionMathInput.latex()),!0}},{key:"addAll",value:function(value){var name=value.name,html=value.button,command=value.expression;this.addControl(name,html,command)}},{key:"addControl",value:function(name,html,command){var control=new EditorControl(name,html,(function(mathInput){return mathInput.write(command)}),command);this.controls[name]=control,control.enable(),null!==this.boundInput&&control.bindInput(this.boundInput),this.wrapper.append(control.element)}}]),EditorControlList}(_visualMathInput.default.ControlList);_exports.initialize=function(templateId,templateName,managerPath){new EditorPage(templateId,templateName,managerPath)};var EditorPage=function(){function EditorPage(templateId,templateName){_classCallCheck(this,EditorPage),_defineProperty(this,"vmiButton",void 0),_defineProperty(this,"buttonRawInput",void 0),_defineProperty(this,"buttonMathInput",void 0),_defineProperty(this,"vmiExpression",void 0),_defineProperty(this,"expressionRawInput",void 0),_defineProperty(this,"expressionMathInput",void 0),_defineProperty(this,"vmiTest",void 0),_defineProperty(this,"testRawInput",void 0),_defineProperty(this,"testMathInput",void 0),_defineProperty(this,"controlsWrapper",void 0),_defineProperty(this,"vmiTestAndSaveContainer",void 0),_defineProperty(this,"target",void 0),_defineProperty(this,"controls",void 0),this.templateId=templateId,this.templateName=templateName,this.initInputFields(),this.initControlsWrapper(),this.initAddForm(),this.initDeleteButton(),this.addSubmitButtonEventListener()}var _initDeleteButton,_initAddForm;return _createClass(EditorPage,[{key:"initInputFields",value:function(){this.testRawInput=document.querySelector("#id_mqtest"),this.buttonRawInput=document.querySelector("#id_mqbtntext"),this.expressionRawInput=document.querySelector("#id_mqexpression"),this.testRawInput.classList.remove("d-inline"),this.vmiTest=new EditorInput(this.testRawInput,this.testRawInput.closest("div")),this.vmiTest.rawInput.style.display="none",this.vmiTest.change(),this.testMathInput=this.vmiTest.mathInput,this.testRawInput.value&&this.testMathInput.write(this.testRawInput.value),this.buttonRawInput.classList.remove("d-inline"),this.vmiButton=new EditorInput(this.buttonRawInput,this.buttonRawInput.closest("div")),this.vmiButton.rawInput.style.display="none",this.vmiButton.addClass("shortmath-blue"),this.vmiButton.change(),this.buttonMathInput=this.vmiButton.mathInput,this.expressionRawInput.classList.remove("d-inline"),this.vmiExpression=new EditorInput(this.expressionRawInput,this.expressionRawInput.closest("div")),this.vmiExpression.rawInput.style.display="none",this.vmiExpression.change(),this.expressionMathInput=this.vmiExpression.mathInput}},{key:"initControlsWrapper",value:function(){var _this3=this;this.controlsWrapper=document.querySelector(".controlswrapper"),this.controlsWrapper.addEventListener("drop",(function(event){event.preventDefault(),_this3.target.id!==dragged.id?(document.getElementById("placeholder").replaceWith(dragged),event.dataTransfer.clearData()):event.dataTransfer.clearData()})),this.controlsWrapper.addEventListener("dragover",(function(event){event.preventDefault(),event.dataTransfer.dropEffect="move"})),this.controlsWrapper.addEventListener("dragenter",(function(event){var targetId;if("placeholder"!==(targetId=event.target.classList.contains("visual-math-input-wrapper")?event.target.lastChild.id:"BUTTON"!==event.target.nodeName?event.target.closest("button").id:event.target.id)){_this3.target=document.getElementById(targetId);var targetIndex=nodes.indexOf(_this3.target);if(draggedIndex!==targetIndex){var empty=document.createElement("button");empty.id="placeholder",empty.classList.add("visual-math-input-control","mq-math-mode","btn","btn-primary"),empty.setAttribute("draggable",!0),_this3.target.parentNode.contains(dragged)?_this3.target.parentNode.removeChild(dragged):_this3.target.parentNode.removeChild(document.getElementById("placeholder")),draggedIndex<targetIndex?_this3.target.parentNode.lastChild!==_this3.target?_this3.target.parentNode.insertBefore(empty,_this3.target.nextSibling):_this3.target.parentNode.appendChild(empty):_this3.target.parentNode.insertBefore(empty,_this3.target),nodes=Array.from(_this3.target.parentNode.children),draggedIndex=nodes.indexOf(empty)}}}))}},{key:"initAddForm",value:(_initAddForm=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var addButton,_this4=this;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(addButton=document.querySelector("#id_mqaddbutton"),this.vmiTestAndSaveContainer=document.querySelector(".test-box"),this.controls=new EditorControlList(this.controlsWrapper),this.controls.bindInput(this.vmiTest),this.vmiButton.parent.querySelector(".invalid-feedback").textContent="Button is empty or invalid!",this.vmiExpression.parent.querySelector(".invalid-feedback").textContent="Expression is empty or invalid!",addButton.addEventListener("click",(function(event){event.preventDefault(),event.stopPropagation(),_this4.isSuccess=_this4.controls.add(_this4.buttonMathInput,_this4.expressionMathInput),_this4.buttonMathInput.latex(""),_this4.expressionMathInput.latex("")})),!(this.templateId>0)){_context.next=18;break}return _context.prev=8,_context.next=11,(0,_api_helpers.getShortmathTemplate)(this.templateId);case 11:_context.sent.forEach(this.controls.addAll.bind(this.controls)),_context.next=18;break;case 15:_context.prev=15,_context.t0=_context.catch(8),_notification.default.addNotification({message:_context.t0,type:"error"});case 18:case"end":return _context.stop()}}),_callee,this,[[8,15]])}))),function(){return _initAddForm.apply(this,arguments)})},{key:"initDeleteButton",value:(_initDeleteButton=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var deleteIcon,_this5=this;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:(deleteIcon=document.querySelector(".delete-icon")).addEventListener("dragover",(function(event){event.preventDefault(),event.dataTransfer.dropEffect="move"})),deleteIcon.addEventListener("drop",(function(event){event.preventDefault();var parentNode=dragged.parentNode;if(null!==parentNode)parentNode.removeChild(dragged),null===parentNode.firstElementChild&&_this5.testMathInput.latex("");else{var placeholder=document.getElementById("placeholder");null!==placeholder&&placeholder.parentNode.removeChild(placeholder)}event.dataTransfer.clearData()}));case 3:case"end":return _context2.stop()}}),_callee2)}))),function(){return _initDeleteButton.apply(this,arguments)})},{key:"addSubmitButtonEventListener",value:function(){var _this6=this;document.querySelector("#id_submitbutton").addEventListener("click",(function(event){var data=[],items=_this6.controls.controls;_this6.controlsWrapper.querySelectorAll("button").forEach((function(element){var control=items[element.id];data.push({name:control.name,button:control.text,expression:control.command})}));var buttonsString=JSON.stringify(data);document.querySelector('[name="templatestring"]').value=buttonsString}))}}]),EditorPage}()}));

//# sourceMappingURL=editor_page.min.js.map