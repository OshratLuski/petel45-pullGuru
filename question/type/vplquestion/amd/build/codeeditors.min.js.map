{"version":3,"file":"codeeditors.min.js","sources":["../src/codeeditors.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides utility methods to setup resizable ace editors into a page.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals ace */\ndefine(['jquery', 'core/url', 'core/config'], function($, url, cfg) {\n\n    // Global Ace editor theme and font size to use for all editors.\n    var aceTheme;\n    var fontSize;\n\n    /**\n     * Setup each specified textarea with Ace editor, with a vertical resize feature.\n     * It inherits readonly attribute from textarea.\n     * @param {jQuery} $textareas JQuery set of textareas from which to set up editors.\n     * @param {String} aceSize Initial CSS size of editors.\n     * @param {String} aceLang (optional) Lang (mode) to setup editors from.\n     * @return {Editor} The last editor set up.\n     */\n    function setupAceEditors($textareas, aceSize, aceLang) {\n        var aceEditor;\n\n        // Vertical resizing.\n        var prevY;\n        var $placeholderBeingResized = null;\n\n        if (aceLang === undefined) {\n            aceLang = 'plain_text';\n        }\n\n        $textareas.each(function() {\n            var $textarea = $(this);\n            var $editorPlaceholder = $('<div>', {\n                width: '100%',\n                height: aceSize,\n                'id': 'ace_placeholder_' + $textarea.attr('name'),\n                'class': 'ace-placeholder'\n            }).insertAfter($textarea);\n            $textarea.hide();\n\n            $('<div>', {\n                'id': 'ace_resize_' + $textarea.attr('name'),\n                'class': 'ace-resize'\n            }).insertAfter($editorPlaceholder)\n            .mousedown(function(event) {\n                prevY = event.clientY;\n                $placeholderBeingResized = $editorPlaceholder;\n                event.preventDefault();\n            });\n\n            ace.config.set('modePath', url.relativeUrl(\"/mod/vpl/editor/ace9\"));\n            ace.config.set('themePath', url.relativeUrl(\"/mod/vpl/editor/ace9\"));\n\n            // This is what creates the Ace editor within the placeholder div.\n            aceEditor = ace.edit($editorPlaceholder[0]);\n            aceEditor.setOptions({\n                theme: 'ace/theme/' + aceTheme,\n                mode: 'ace/mode/' + aceLang\n            });\n            aceEditor.setFontSize(fontSize);\n            aceEditor.$blockScrolling = Infinity; // Disable ace warning.\n            aceEditor.getSession().setValue($textarea.val());\n            aceEditor.setReadOnly($textarea.is('[readonly]'));\n\n            // On submit or run/check, propagate the changes to textarea.\n            $('[type=submit], .qvpl-buttons button').click(function() {\n                // Cannot use aceEditor here, as it will have another value later.\n                $textarea.val(ace.edit('ace_placeholder_' + $textarea.attr('name')).getValue());\n            });\n        });\n\n        $(window).mousemove(function(event) {\n            if ($placeholderBeingResized) {\n                $placeholderBeingResized.height(function(i, height) {\n                    return height + event.clientY - prevY;\n                });\n                prevY = event.clientY;\n                ace.edit($placeholderBeingResized[0]).resize();\n                event.preventDefault();\n            }\n        }).mouseup(function() {\n            $placeholderBeingResized = null;\n        });\n\n        return aceEditor;\n    }\n\n    /**\n     * Loads Ace script from VPL plugin.\n     * @return {Promise} A promise that resolves upon load.\n     */\n    function loadAce() {\n        if (typeof ace !== 'undefined' && typeof aceTheme !== 'undefined') {\n            return $.Deferred().resolve();\n        }\n        var ACESCRIPTLOCATION = url.relativeUrl(\"/mod/vpl/editor/ace9\");\n        return $.when(\n            $.ajax({\n                url: ACESCRIPTLOCATION + '/ace.js',\n                dataType: 'script',\n                cache: true,\n                success: function() {\n                    ace.config.set('basePath', ACESCRIPTLOCATION);\n                }\n            }),\n            getEditorPreferences().then(function(prefs) {\n                aceTheme = prefs.aceTheme;\n                fontSize = prefs.fontSize;\n            }),\n        );\n    }\n\n    /**\n     * Get current preferences for font size and editor theme.\n     * @return {Promise} A promise that resolves upon load with an argument that is an object containing fontSize and aceTheme keys.\n     */\n    function getEditorPreferences() {\n        return $.ajax({\n            url: url.relativeUrl('/question/type/vplquestion/ajax/vplpreferences.json.php'),\n            cache: true,\n        }).promise().then(function(outcome) {\n            return {\n                aceTheme: outcome.success ? outcome.response.aceTheme : 'chrome',\n                fontSize: outcome.success ? Number(outcome.response.fontSize) : 12,\n            };\n        });\n    }\n\n    /**\n     * Save preferences for font size and editor theme.\n     * @param {String} aceTheme The new theme.\n     * @param {String|Number} fontSize The new font size.\n     */\n    function saveEditorPreferences(aceTheme, fontSize) {\n        $.ajax({\n            url: url.relativeUrl('/question/type/vplquestion/ajax/vplpreferences.json.php'),\n            cache: false,\n            method: 'POST',\n            data: {\n                set: {\n                    aceTheme: aceTheme,\n                    fontSize: Number(fontSize),\n                },\n                sesskey: cfg.sesskey,\n            },\n        });\n    }\n\n    return {\n        // Setup editors in question edition form.\n        setupFormEditors: function() {\n            return loadAce().done(function() {\n                setupAceEditors($('.code-editor textarea'), '170px');\n            });\n        },\n\n        // Setup editor in answer form.\n        setupQuestionEditor: function($textarea, $setTextButtons, lineOffset) {\n            return loadAce().done(function() {\n                // Setup question editor.\n                var aceEditor = setupAceEditors($textarea, '200px', $textarea.data('templatelang'));\n                // Set first line number to match compilation messages.\n                aceEditor.setOption('firstLineNumber', lineOffset);\n                // Setup reset and correction buttons (if present, ie. not review mode).\n                $setTextButtons.each(function() {\n                    var text = $(this).data('text');\n                    $(this).removeAttr('data-text');\n                    $(this).click(function(event) {\n                        if (aceEditor.getValue() != text) {\n                            aceEditor.setValue(text);\n                        }\n                        event.preventDefault();\n                    });\n                });\n            });\n        },\n\n        getEditorPreferences: getEditorPreferences,\n\n        saveEditorPreferences: saveEditorPreferences,\n\n        changeFontSize: function(newFontSize) {\n            $('.ace-placeholder').each(function() {\n                ace.edit(this).setFontSize(Number(newFontSize));\n            });\n        },\n\n        changeTheme: function(newTheme) {\n            $('.ace-placeholder').each(function() {\n                ace.edit(this).setOptions({\n                    theme: 'ace/theme/' + newTheme\n                });\n            });\n        },\n    };\n});\n"],"names":["define","$","url","cfg","aceTheme","fontSize","setupAceEditors","$textareas","aceSize","aceLang","aceEditor","prevY","$placeholderBeingResized","undefined","each","$textarea","this","$editorPlaceholder","width","height","attr","insertAfter","hide","mousedown","event","clientY","preventDefault","ace","config","set","relativeUrl","edit","setOptions","theme","mode","setFontSize","$blockScrolling","Infinity","getSession","setValue","val","setReadOnly","is","click","getValue","window","mousemove","i","resize","mouseup","loadAce","Deferred","resolve","ACESCRIPTLOCATION","when","ajax","dataType","cache","success","getEditorPreferences","then","prefs","promise","outcome","response","Number","setupFormEditors","done","setupQuestionEditor","$setTextButtons","lineOffset","data","setOption","text","removeAttr","saveEditorPreferences","method","sesskey","changeFontSize","newFontSize","changeTheme","newTheme"],"mappings":"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"}