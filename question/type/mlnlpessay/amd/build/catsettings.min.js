define("qtype_mlnlpessay/catsettings",["exports","core/ajax","core/notification","qtype_mlnlpessay/tabulatorlib","core/modal","core/modal_events","core/str","core/templates","core/fragment","jquery"],function(_exports,_ajax,_notification,_tabulatorlib,_modal,_modal_events,_str,_templates,_fragment,_jquery){function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=function(e,t){if("function"==typeof WeakMap)var r=new WeakMap,n=new WeakMap;return function(e,t){if(!t&&e&&e.__esModule)return e;var o,i,f={__proto__:null,default:e};if(null===e||"object"!=typeof e&&"function"!=typeof e)return f;if(o=t?n:r){if(o.has(e))return o.get(e);o.set(e,f)}for(const t in e)"default"!==t&&{}.hasOwnProperty.call(e,t)&&((i=(o=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,t))&&(i.get||i.set)?o(f,t,i):f[t]=e[t]);return f}(e,t)}(_notification),_tabulatorlib=_interopRequireDefault(_tabulatorlib),_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_fragment=_interopRequireDefault(_fragment),_jquery=_interopRequireDefault(_jquery);const SELECTORS_CATCONTAINER=".mlnlpessay-categories-wrapper",SELECTORS_LANGCONTAINER=".mlnlpessay-lang-wrapper",SELECTORS_ADDEDITTRIGGER="qtype-mlnlpessay-settingaddedit",SELECTORS_TOPICCONTAINER=".mlnlpessay-topics-wrapper",SELECTORS_SUBTOPICCONTAINER=".mlnlpessay-subtopics-wrapper",SELECTORS_MODALCONTAINER=".mlnlpessay-modal",SELECTORS_DELETETRIGGER="qtype-mlnlpessay-settingdelete",SELECTORS_VISIBILITYTRIGGER="qtype-mlnlpessay-settingvisibilitytoggle",SELECTORS_CSVUPLOADTRIGGER="qtype-mlnlpessay-csvupload",getData=async item=>{let data=[],response=await _ajax.default.call([{methodname:"qtype_mlnlpessay_get_"+item,args:{}}])[0];return response.status&&(data=response.response),data};window.qtypeMlnlpessayCsvModalState={step:"upload",precheckData:null,formData:null};_exports.init=async contextid=>{const tables={categoriestable:new _tabulatorlib.default(SELECTORS_CATCONTAINER,{data:await getData("categories"),layout:"fitColumns",responsiveLayout:"hide",addRowPos:"top",history:!0,pagination:"local",paginationSize:7,paginationSizeSelector:!0,paginationCounter:"rows",movableColumns:!0,initialSort:[{column:"id",dir:"asc"}],columnDefaults:{tooltip:!0},columns:[{title:M.util.get_string("catid","qtype_mlnlpessay"),field:"id"},{title:M.util.get_string("categoryname","qtype_mlnlpessay"),field:"name",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("modelid","qtype_mlnlpessay"),field:"modelid",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("modelname","qtype_mlnlpessay"),field:"model",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("categorytag","qtype_mlnlpessay"),field:"tag",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("descriptioncategory","qtype_mlnlpessay"),field:"description",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("catlang","qtype_mlnlpessay"),field:"lang",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("cattopic","qtype_mlnlpessay"),field:"topic",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("catsubtopic","qtype_mlnlpessay"),field:"subtopic",headerFilter:"input",headerFilterLiveFilter:!0},{title:M.util.get_string("catstatus","qtype_mlnlpessay"),field:"active",formatter:"html"},{title:M.util.get_string("catdisabled","qtype_mlnlpessay"),field:"disabled"},{title:M.util.get_string("catactions","qtype_mlnlpessay"),field:"catactions",formatter:"html"}]}),langstable:new _tabulatorlib.default(SELECTORS_LANGCONTAINER,{data:await getData("langs"),layout:"fitColumns",responsiveLayout:"hide",addRowPos:"top",history:!0,pagination:"local",paginationSize:7,paginationSizeSelector:!0,paginationCounter:"rows",movableColumns:!0,initialSort:[{column:"id",dir:"asc"}],columnDefaults:{tooltip:!0},columns:[{title:M.util.get_string("langid","qtype_mlnlpessay"),field:"id"},{title:M.util.get_string("langcode","qtype_mlnlpessay"),field:"code"},{title:M.util.get_string("langname","qtype_mlnlpessay"),field:"name"},{title:M.util.get_string("langactive","qtype_mlnlpessay"),field:"active",formatter:"html"},{title:M.util.get_string("langactions","qtype_mlnlpessay"),field:"langactions",formatter:"html"}]}),topicstable:new _tabulatorlib.default(SELECTORS_TOPICCONTAINER,{data:await getData("topics"),layout:"fitColumns",responsiveLayout:"hide",addRowPos:"top",history:!0,pagination:"local",paginationSize:7,paginationSizeSelector:!0,paginationCounter:"rows",movableColumns:!0,initialSort:[{column:"id",dir:"asc"}],columnDefaults:{tooltip:!0},columns:[{title:M.util.get_string("topicid","qtype_mlnlpessay"),field:"id"},{title:M.util.get_string("topicname","qtype_mlnlpessay"),field:"name"},{title:M.util.get_string("topicactive","qtype_mlnlpessay"),field:"active",formatter:"html"},{title:M.util.get_string("topicactions","qtype_mlnlpessay"),field:"topicactions",formatter:"html"}]}),subtopicstable:new _tabulatorlib.default(SELECTORS_SUBTOPICCONTAINER,{data:await getData("subtopics"),layout:"fitColumns",responsiveLayout:"hide",addRowPos:"top",history:!0,pagination:"local",paginationSize:7,paginationSizeSelector:!0,paginationCounter:"rows",movableColumns:!0,initialSort:[{column:"id",dir:"asc"}],columnDefaults:{tooltip:!0},columns:[{title:M.util.get_string("subtopicid","qtype_mlnlpessay"),field:"id"},{title:M.util.get_string("subtopicname","qtype_mlnlpessay"),field:"name"},{title:M.util.get_string("subtopicactive","qtype_mlnlpessay"),field:"active",formatter:"html"},{title:M.util.get_string("subtopicactions","qtype_mlnlpessay"),field:"subtopicactions",formatter:"html"}]})};document.addEventListener("click",async function(e){if(e.target.classList.contains(SELECTORS_ADDEDITTRIGGER)){e.preventDefault();let action=e.target.getAttribute("data-action");const modal=await _modal.default.create({title:await(0,_str.get_string)("modal"+action+"title","qtype_mlnlpessay"),body:await _templates.default.render("qtype_mlnlpessay/modal",{action:action})});modal.show(),modal.getRoot().on(_modal_events.default.hidden,function(){modal.destroy()});let fragmentargs={action:action};e.target.getAttribute("data-id")&&(fragmentargs.id=e.target.getAttribute("data-id")),_fragment.default.loadFragment("qtype_mlnlpessay","settingsform",contextid,fragmentargs).done(async function(html,js){_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,js),(0,_jquery.default)(SELECTORS_MODALCONTAINER).find("form").on("submit",function(e){e.preventDefault(),e.stopPropagation(),_notification.default.saveCancelPromise(M.util.get_string("saveconfirm","qtype_mlnlpessay"),M.util.get_string("savewarning","qtype_mlnlpessay")).then(()=>{e.preventDefault();let formdata=(0,_jquery.default)(this).serialize();_ajax.default.call([{methodname:"qtype_mlnlpessay_save_settings",args:{action:action,formdata:formdata}}])[0].done(async function(response){if(response.status){_notification.default.addNotification({message:M.util.get_string("savesuccess","qtype_mlnlpessay"),type:"info"}),modal.hide(),tables[action+"table"].replaceData(await getData(action))}else _notification.default.addNotification({message:M.util.get_string("saveerror","qtype_mlnlpessay"),type:"error"})}).fail(_notification.default.exception)})})})}if(e.target.classList.contains(SELECTORS_DELETETRIGGER)){e.preventDefault();let action=e.target.getAttribute("data-action"),id=e.target.getAttribute("data-id");_notification.default.deleteCancelPromise(M.util.get_string("deleteconfirm","qtype_mlnlpessay"),M.util.get_string("deletewarning","qtype_mlnlpessay")).then(()=>{_ajax.default.call([{methodname:"qtype_mlnlpessay_delete_setting",args:{action:action,id:id}}])[0].done(async function(response){if(response.status){_notification.default.addNotification({message:M.util.get_string("deletesuccess","qtype_mlnlpessay"),type:"info"}),tables[action+"table"].replaceData(await getData(action))}else _notification.default.addNotification({message:M.util.get_string("saveerror","qtype_mlnlpessay"),type:"error"})}).fail(_notification.default.exception)}).catch(()=>{})}if(e.target.classList.contains(SELECTORS_VISIBILITYTRIGGER)){e.preventDefault();let action=e.target.getAttribute("data-action"),id=e.target.getAttribute("data-id");_ajax.default.call([{methodname:"qtype_mlnlpessay_toggle_visible",args:{action:action,id:id}}])[0].done(async function(response){if(response.status){tables[action+"table"].replaceData(await getData(action))}else _notification.default.addNotification({message:M.util.get_string("saveerror","qtype_mlnlpessay"),type:"error"})}).fail(_notification.default.exception)}if(e.target.classList.contains(SELECTORS_CSVUPLOADTRIGGER)){e.preventDefault(),window.qtypeMlnlpessayCsvModalState={step:"upload",precheckData:null,formData:null};const modal=await _modal.default.create({title:await(0,_str.get_string)("modalcsvuploadtitle","qtype_mlnlpessay"),body:await _templates.default.render("qtype_mlnlpessay/modal",{})});modal.show(),modal.getRoot().on(_modal_events.default.hidden,async function(){if(modal.destroy(),tables&&tables.categoriestable){const newData=await getData("categories");tables.categoriestable.replaceData(newData)}window.qtypeMlnlpessayCsvModalState={step:"upload",precheckData:null,formData:null}}),_fragment.default.loadFragment("qtype_mlnlpessay","csvuploadform",contextid,[]).done(async function(html,js){_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,js),window.qtypeMlnlpessayCsvModalState.formData,(0,_jquery.default)(SELECTORS_MODALCONTAINER).find("form").on("submit",async function(e){e.preventDefault(),_notification.default.saveCancelPromise(M.util.get_string("csvconfirm","qtype_mlnlpessay"),M.util.get_string("csvwarning","qtype_mlnlpessay"),M.util.get_string("csvproceed","qtype_mlnlpessay")).then(async()=>{let formdata=(0,_jquery.default)(this).serialize();_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),'<div class="text-center p-3"><span class="spinner-border" role="status"></span></div>',"");let response=await _ajax.default.call([{methodname:"qtype_mlnlpessay_csv_upload",args:{formdata:formdata}}])[0];if(!response.status||!response.response||!response.response.rows||0===response.response.rows.length)return _notification.default.addNotification({message:M.util.get_string("csvuploaderror","qtype_mlnlpessay"),type:"error"}),void _fragment.default.loadFragment("qtype_mlnlpessay","csvuploadform",contextid,[]).done(function(html,js){_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,js)});window.qtypeMlnlpessayCsvModalState={step:"precheck",precheckData:response.response,formData:formdata};let html=await _templates.default.render("qtype_mlnlpessay/csvuploadprecheck",response.response);_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,""),response.response.rows&&0!==response.response.rows.length||(0,_jquery.default)(SELECTORS_MODALCONTAINER).find(".qtype-mlnlpessay-csvprocess").prop("disabled",!0)})})})}if(e.target.classList.contains("qtype-mlnlpessay-csvback")&&(e.preventDefault(),"result"===window.qtypeMlnlpessayCsvModalState.step?(window.qtypeMlnlpessayCsvModalState.step="precheck",window.qtypeMlnlpessayCsvModalState.precheckData&&_templates.default.render("qtype_mlnlpessay/csvuploadprecheck",window.qtypeMlnlpessayCsvModalState.precheckData).then(function(html){_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,"")})):"precheck"===window.qtypeMlnlpessayCsvModalState.step&&(window.qtypeMlnlpessayCsvModalState.step="upload",_fragment.default.loadFragment("qtype_mlnlpessay","csvuploadform",contextid,[]).done(function(html,js){_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,js)}))),e.target.classList.contains("qtype-mlnlpessay-csvprocess")){e.preventDefault();let form=(0,_jquery.default)(SELECTORS_MODALCONTAINER).find("form"),formdata=window.qtypeMlnlpessayCsvModalState.formData||(form.length?form.serialize():"");if(!formdata)return void _notification.default.addNotification({message:"Could not find CSV file data to upload.",type:"error"});_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),'<div class="text-center p-3"><span class="spinner-border" role="status"></span></div>',""),_ajax.default.call([{methodname:"qtype_mlnlpessay_csv_upload_perform",args:{formdata:formdata}}])[0].done(async function(response){if(response.status){window.qtypeMlnlpessayCsvModalState.step="result";let html=await _templates.default.render("qtype_mlnlpessay/csvuploadresult",response.response);_templates.default.replaceNodeContents((0,_jquery.default)(SELECTORS_MODALCONTAINER),html,"")}else _notification.default.addNotification({message:response.message||"CSV import failed.",type:"error"})}).fail(_notification.default.exception)}if(e.target.classList.contains("qtype-mlnlpessay-csvundo")){e.preventDefault();let importid=e.target.getAttribute("data-importid");if(!importid)return;e.target.disabled=!0,_ajax.default.call([{methodname:"qtype_mlnlpessay_csv_upload_undo",args:{importid:importid}}])[0].done(function(response){response.status?(_notification.default.addNotification({message:M.util.get_string("csvundodone","qtype_mlnlpessay"),type:"info"}),(0,_jquery.default)(SELECTORS_MODALCONTAINER).closest(".modal").modal("hide")):_notification.default.addNotification({message:response.message||"Undo failed.",type:"error"})}).fail(_notification.default.exception).always(function(){e.target.disabled=!1})}}),(0,_jquery.default)(document).on("keydown",".mlnlpessay-categories-search",function(e){if("Enter"===e.key){e.preventDefault(),e.stopPropagation();const query=(0,_jquery.default)(this).val().toLowerCase();if(!query)return void tables.categoriestable.clearFilter();tables.categoriestable.setFilter(function(data){return Object.values(data).some(val=>null!=val&&(val+"").includes(query))})}})}});

//# sourceMappingURL=catsettings.min.js.map