{"version":3,"file":"assign_participants.min.js","sources":["../src/assign_participants.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Some UI stuff for participants page.\n * This is also used by the report/participants/index.php because it has the same functionality.\n *\n * @module     local_petel/assign_participants\n * @package    local_petel\n * @copyright  2017 Damyon Wiese\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author     Devlion Moodle Development <service@devlion.co>\n */\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/notification', 'core/ajax'],\n    function ($, Str, ModalFactory, ModalEvents, Templates, Notification, Ajax) {\n\n        var SELECTORS = {\n            BULKACTIONSELECT: \"table\"\n        };\n\n        /**\n         * Constructor\n         *\n         * @param {Object} selected Object containing options. Contextid is required.\n         * Each call to templates.render gets it's own instance of this class.\n         */\n        var Participants = function (selected) {\n\n            if (selected.length === 0) {\n                return;\n            }\n\n            Participants.prototype.showSendMessage(selected).fail(Notification.exception);\n        };\n        // Class variables and functions.\n\n        /**\n         * @var {Modal} modal\n         * @private\n         */\n        Participants.prototype.modal = null;\n\n        /**\n         * Show the send message popup.\n         *\n         * @method showSendMessage\n         * @private\n         * @param {int[]} users\n         * @return {Promise}\n         */\n        Participants.prototype.showSendMessage = function (users) {\n\n            if (users.length === 0) {\n                // Nothing to do.\n                return $.Deferred().resolve().promise();\n            }\n            var titlePromise = null;\n            if (users.length === 1) {\n                titlePromise = Str.get_string('sendbulkmessagesingle', 'core_message');\n            } else {\n                titlePromise = Str.get_string('sendbulkmessage', 'core_message', users.length);\n            }\n\n            return $.when(\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    body: Templates.render('core_user/send_bulk_message', {})\n                }),\n                titlePromise\n            ).then(function (modal, title) {\n                // Keep a reference to the modal.\n                this.modal = modal;\n\n                this.modal.setTitle(title);\n                this.modal.setSaveButtonText(title);\n\n                // We want to focus on the action select when the dialog is closed.\n                this.modal.getRoot().on(ModalEvents.hidden, function () {\n                    $(SELECTORS.BULKACTIONSELECT).focus();\n                    this.modal.getRoot().remove();\n                }.bind(this));\n\n                this.modal.getRoot().on(ModalEvents.save, this.submitSendMessage.bind(this, users));\n\n                this.modal.show();\n\n                return this.modal;\n            }.bind(this));\n        };\n\n        /**\n         * Send a message to these users.\n         *\n         * @method submitSendMessage\n         * @private\n         * @param {int[]} users\n         * @param {Event} e Form submission event.\n         * @return {Promise}\n         */\n        Participants.prototype.submitSendMessage = function (users) {\n\n            var messageText = this.modal.getRoot().find('form textarea').val();\n\n            var messages = [],\n                i = 0;\n\n            for (i = 0; i < users.length; i++) {\n                messages.push({ touserid: users[i], text: messageText });\n            }\n\n            return Ajax.call([{\n                methodname: 'core_message_send_instant_messages',\n                args: { messages: messages }\n            }])[0].then(function (messageIds) {\n                if (messageIds.length === 1) {\n                    return Str.get_string('sendbulkmessagesentsingle', 'core_message');\n                } else {\n                    return Str.get_string('sendbulkmessagesent', 'core_message', messageIds.length);\n                }\n            }).then(function (msg) {\n                Notification.addNotification({\n                    message: msg,\n                    type: \"success\"\n                });\n                return true;\n            }).catch(Notification.exception);\n        };\n\n        return /** @alias module:core_user/participants */ {\n            'init': function (selectedusers) {\n                return new Participants(selectedusers);\n            }\n        };\n    });\n"],"names":["define","$","Str","ModalFactory","ModalEvents","Templates","Notification","Ajax","SELECTORS","Participants","selected","length","prototype","showSendMessage","fail","exception","modal","users","Deferred","resolve","promise","titlePromise","get_string","when","create","type","types","SAVE_CANCEL","body","render","then","title","setTitle","setSaveButtonText","getRoot","on","hidden","focus","remove","bind","this","save","submitSendMessage","show","messageText","find","val","messages","i","push","touserid","text","call","methodname","args","messageIds","msg","addNotification","message","catch","selectedusers"],"mappings":";;;;;;;;;;AAyBAA,yCAAO,CAAC,SAAU,WAAY,qBAAsB,oBAAqB,iBAAkB,oBAAqB,cAC5G,SAAUC,EAAGC,IAAKC,aAAcC,YAAaC,UAAWC,aAAcC,UAE9DC,2BACkB,QASlBC,aAAe,SAAfA,aAAyBC,UAED,IAApBA,SAASC,QAIbF,aAAaG,UAAUC,gBAAgBH,UAAUI,KAAKR,aAAaS,mBAQvEN,aAAaG,UAAUI,MAAQ,KAU/BP,aAAaG,UAAUC,gBAAkB,SAAUI,UAE1B,IAAjBA,MAAMN,cAECV,EAAEiB,WAAWC,UAAUC,cAE9BC,aAAe,YAEfA,aADiB,IAAjBJ,MAAMN,OACST,IAAIoB,WAAW,wBAAyB,gBAExCpB,IAAIoB,WAAW,kBAAmB,eAAgBL,MAAMN,QAGpEV,EAAEsB,KACLpB,aAAaqB,OAAO,CAChBC,KAAMtB,aAAauB,MAAMC,YACzBC,KAAMvB,UAAUwB,OAAO,8BAA+B,MAE1DR,cACFS,KAAK,SAAUd,MAAOe,mBAEff,MAAQA,WAERA,MAAMgB,SAASD,YACff,MAAMiB,kBAAkBF,YAGxBf,MAAMkB,UAAUC,GAAG/B,YAAYgC,OAAQ,WACxCnC,EAAEO,4BAA4B6B,aACzBrB,MAAMkB,UAAUI,UACvBC,KAAKC,YAEFxB,MAAMkB,UAAUC,GAAG/B,YAAYqC,KAAMD,KAAKE,kBAAkBH,KAAKC,KAAMvB,aAEvED,MAAM2B,OAEJH,KAAKxB,OACduB,KAAKC,QAYX/B,aAAaG,UAAU8B,kBAAoB,SAAUzB,WAE7C2B,YAAcJ,KAAKxB,MAAMkB,UAAUW,KAAK,iBAAiBC,MAEzDC,SAAW,GACXC,EAAI,MAEHA,EAAI,EAAGA,EAAI/B,MAAMN,OAAQqC,IAC1BD,SAASE,KAAK,CAAEC,SAAUjC,MAAM+B,GAAIG,KAAMP,qBAGvCrC,KAAK6C,KAAK,CAAC,CACdC,WAAY,qCACZC,KAAM,CAAEP,SAAUA,aAClB,GAAGjB,MAAK,SAAUyB,mBACQ,IAAtBA,WAAW5C,OACJT,IAAIoB,WAAW,4BAA6B,gBAE5CpB,IAAIoB,WAAW,sBAAuB,eAAgBiC,WAAW5C,WAE7EmB,MAAK,SAAU0B,YACdlD,aAAamD,gBAAgB,CACzBC,QAASF,IACT/B,KAAM,aAEH,KACRkC,MAAMrD,aAAaS,YAGyB,MACvC,SAAU6C,sBACP,IAAInD,aAAamD,gBAGnC"}