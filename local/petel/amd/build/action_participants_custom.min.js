define("local_petel/action_participants_custom",["exports","core_table/dynamic","core/str","core/checkbox-toggleall","core/custom_interaction_events","core_table/local/dynamic/selectors","core/modal_events","core/notification","core/pending","jquery","core_user/local/participants/bulkactions","core/inplace_editable","core/modal_factory","core/templates","core/toast","core/ajax"],(function(_exports,DynamicTable,Str,_checkboxToggleall,_custom_interaction_events,_selectors,_modal_events,_notification,_pending,_jquery,_bulkactions,_inplace_editable,_modal_factory,_templates,Toast,Ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Some UI stuff for participants page.
   * This is also used by the report/participants/index.php because it has the same functionality.
   *
   * @module     local_petel/action_participants_custom
   * @copyright  2023 devlion.co
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,DynamicTable=_interopRequireWildcard(DynamicTable),Str=_interopRequireWildcard(Str),_checkboxToggleall=_interopRequireDefault(_checkboxToggleall),_custom_interaction_events=_interopRequireDefault(_custom_interaction_events),_selectors=_interopRequireDefault(_selectors),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),_jquery=_interopRequireDefault(_jquery),_modal_factory=_interopRequireDefault(_modal_factory),_templates=_interopRequireDefault(_templates),Toast=_interopRequireWildcard(Toast),Ajax=_interopRequireWildcard(Ajax);const Selectors_bulkActionSelect="#formactionid",Selectors_bulkUserSelectedCheckBoxes="input[data-togglegroup='participants-table'][data-toggle='slave']:checked",Selectors_checkCountButton="#checkall",Selectors_showCountText='[data-region="participant-count"]',Selectors_stateHelpIcon='[data-region="state-help-icon"]',Selectors_tableForm=uniqueId=>'form[data-table-unique-id="'.concat(uniqueId,'"]');_exports.init=_ref=>{let{uniqueid:uniqueid,noteStateNames:noteStateNames={},currentcourseid:currentcourseid,currentuserid:currentuserid,defaults:defaults}=_ref;const root=document.querySelector(Selectors_tableForm(uniqueid)),getTableFromUniqueId=uniqueId=>root.querySelector(_selectors.default.main.fromRegionId(uniqueId)),resetBulkAction=bulkActionSelect=>{bulkActionSelect.value=""};_custom_interaction_events.default.define(Selectors_bulkActionSelect,[_custom_interaction_events.default.events.accessibleChange]),Str.get_strings([{key:"buttoncreatecourse",component:"local_petel"},{key:"buttonaddsystemgroups",component:"local_petel"}]).done((function(strings){(0,_jquery.default)("#formactionid option").each((function(index){if(2===index){let name=strings[0];var newOption='<option id="participants-createcourse" value="#createcourse">'+name+"</option>";(0,_jquery.default)(newOption).insertAfter((0,_jquery.default)(this)),name=strings[1],newOption='<option id="participants-addsystemgroups" value="#addsystemgroups">'+name+"</option>",(0,_jquery.default)(newOption).insertAfter((0,_jquery.default)(this))}}))})),(0,_jquery.default)(Selectors_bulkActionSelect).on(_custom_interaction_events.default.events.accessibleChange,(e=>{console.log(uniqueid,"uniqueid");const bulkActionSelect=e.target.closest("select"),action=bulkActionSelect.value,checkboxes=getTableFromUniqueId(uniqueid).querySelectorAll(Selectors_bulkUserSelectedCheckBoxes),pendingPromise=new _pending.default("core_user/participants:bulkActionSelect");if(-1!==action.indexOf("#")){e.preventDefault();const ids=[];let bulkAction;if(checkboxes.forEach((checkbox=>{ids.push(checkbox.getAttribute("name").replace("user",""))})),"#messageselect"===action?bulkAction=(0,_bulkactions.showSendMessage)(ids):"#addgroupnote"===action&&(bulkAction=(0,_bulkactions.showAddNote)(root.dataset.courseId,ids,noteStateNames,root.querySelector(Selectors_stateHelpIcon))),"#addsystemgroups"===action&&(bulkAction=openPopupAddSystemGroups(currentcourseid,currentuserid,defaults)),"#createcourse"===action&&(bulkAction=openPopupCourseCreate(currentcourseid,currentuserid,defaults)),bulkAction){const pendingBulkAction=new _pending.default("core_user/participants:bulkActionSelected");bulkAction.then((modal=>(modal.getRoot().on(_modal_events.default.hidden,(()=>{bulkActionSelect.focus()})),pendingBulkAction.resolve(),modal))).catch(_notification.default.exception)}}else""!==action&&checkboxes.length&&bulkActionSelect.form.submit();resetBulkAction(bulkActionSelect),pendingPromise.resolve()})),root.addEventListener("click",(e=>{const checkCountButton=root.querySelector(Selectors_checkCountButton);if(checkCountButton&&checkCountButton.contains(e.target)){e.preventDefault();const tableRoot=getTableFromUniqueId(uniqueid);DynamicTable.setPageSize(tableRoot,checkCountButton.dataset.targetPageSize).then((tableRoot=>(_checkboxToggleall.default.setGroupState(root,"participants-table",!0),tableRoot))).catch(_notification.default.exception)}})),root.addEventListener(DynamicTable.Events.tableContentRefreshed,(e=>{const checkCountButton=root.querySelector(Selectors_checkCountButton),tableRoot=e.target,defaultPageSize=parseInt(tableRoot.dataset.tableDefaultPerPage,10),currentPageSize=parseInt(tableRoot.dataset.tablePageSize,10),totalRowCount=parseInt(tableRoot.dataset.tableTotalRows,10);_checkboxToggleall.default.updateSlavesFromMasterState(root,"participants-table");const pageCountStrings=[{key:"countparticipantsfound",component:"core_user",param:totalRowCount}];totalRowCount<=defaultPageSize?checkCountButton&&checkCountButton.classList.add("hidden"):totalRowCount<=currentPageSize?(pageCountStrings.push({key:"selectalluserswithcount",component:"core",param:defaultPageSize}),checkCountButton&&checkCountButton.classList.add("hidden")):(pageCountStrings.push({key:"selectalluserswithcount",component:"core",param:totalRowCount}),checkCountButton&&checkCountButton.classList.remove("hidden")),Str.get_strings(pageCountStrings).then((_ref2=>{let[showingParticipantCountString,selectCountString]=_ref2;root.querySelector(Selectors_showCountText).innerHTML=showingParticipantCountString,selectCountString&&checkCountButton&&(checkCountButton.value=selectCountString)})).catch(_notification.default.exception)}));const openPopupAddSystemGroups=function(currentcourseid,currentuserid,defaults){const openPopupAddSystemGroupsUniqueid=Date.now();var users=[];(0,_jquery.default)("#participants tbody tr input:checked").each((function(index){users.push((0,_jquery.default)(this).attr("name").replace("user",""))}));let titlePromise=null;titlePromise=users.length>1?Str.get_string("titleaddsystemgroups","local_petel",users.length):Str.get_string("titleaddsystemgroups1","local_petel"),Str.get_strings([{key:"selectgroups",component:"local_petel"}]).done((function(strings){const context={autocompletemultiplefields:[{title:strings[0],inputid:"system_groups_ac"+openPopupAddSystemGroupsUniqueid,methodname:"get_system_groups_ac"}]};return _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,body:_templates.default.render("local_petel/popup_action_participants",context),title:titlePromise,buttons:{save:titlePromise},removeOnClose:!0}).then((modal=>(modal.getRoot().on(_modal_events.default.save,(()=>submitPopupAddSystemGroups(currentcourseid,currentuserid,users,openPopupAddSystemGroupsUniqueid))),modal.show(),modal)))}))},submitPopupAddSystemGroups=function(currentcourseid,currentuserid,users,openPopupAddSystemGroupsUniqueid){var Selector={GROUPS_SELECT:".modal.show #system_groups_ac"+openPopupAddSystemGroupsUniqueid};(0,_jquery.default)(Selector.GROUPS_SELECT).parent().find(".error-block").hide();let groupids=(0,_jquery.default)(Selector.GROUPS_SELECT).val();if(0===groupids.length)return 0===groupids.length&&(0,_jquery.default)(Selector.GROUPS_SELECT).parent().find(".error-block").show(),!1;var data={groupids:JSON.stringify(groupids),currentuserid:currentuserid,users:JSON.stringify(users)};Ajax.call([{methodname:"local_petel_create_system_groups_for_teachers",args:data,done:function(response){response.result&&Str.get_strings([{key:"coursescreated",component:"local_petel"}]).done((function(strings){Toast.add(strings[0])}))},fail:_notification.default.exception}])},openPopupCourseCreate=function(currentcourseid,currentuserid,defaults){const popupCourseCreateUniqueid=Date.now();var users=[];(0,_jquery.default)("#participants tbody tr input:checked").each((function(index){users.push((0,_jquery.default)(this).attr("name").replace("user",""))}));let titlePromise=null;titlePromise=users.length>1?Str.get_string("titlecreatecourse","local_petel",users.length):Str.get_string("titlecreatecourse1","local_petel"),Str.get_strings([{key:"selectmaincategory",component:"local_petel"},{key:"selecttemplatecourse",component:"local_petel"},{key:"selectrole",component:"local_petel"},{key:"selectgroups",component:"local_petel"},{key:"keynull",component:"local_petel"}]).done((function(strings){const categoriesac={title:strings[0],placeholder:strings[0],inputid:"categories_ac"+popupCourseCreateUniqueid,methodname:"get_categories_ac",paramname:"main-category",paramid:"main-category"+popupCourseCreateUniqueid,paramvalue:defaults.categories_ac.value,paramdesc:defaults.categories_ac.name},coursesac={title:strings[1],placeholder:strings[1],inputid:"courses_ac"+popupCourseCreateUniqueid,methodname:"get_courses_ac",paramname:"template-course",paramid:"template-course"+popupCourseCreateUniqueid,paramvalue:defaults.courses_ac.value,paramdesc:defaults.courses_ac.name},rolesac={title:strings[2],placeholder:strings[2],inputid:"roles_ac"+popupCourseCreateUniqueid,methodname:"get_roles_ac",paramname:"template-role",paramid:"template-role"+popupCourseCreateUniqueid,paramvalue:defaults.roles_ac.value,paramdesc:defaults.roles_ac.name},groupsac={title:strings[3],inputid:"system_groups_ac"+popupCourseCreateUniqueid,methodname:"get_system_groups_ac"},context=(strings[4],defaults.roles_ac.value,{autocompletefields:[categoriesac,coursesac,rolesac],autocompletemultiplefields:[groupsac]});return _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,body:_templates.default.render("local_petel/popup_action_participants",context),title:titlePromise,buttons:{save:titlePromise},removeOnClose:!0}).then((modal=>(modal.getRoot().on(_modal_events.default.save,(()=>submitPopupCourseCreate(currentcourseid,currentuserid,users,popupCourseCreateUniqueid))),modal.show(),modal)))}))},submitPopupCourseCreate=function(currentcourseid,currentuserid,users,popupCourseCreateUniqueid){var Selector={CATEGORY_SELECT:".modal.show #main-category"+popupCourseCreateUniqueid,COURSE_SELECT:".modal.show #template-course"+popupCourseCreateUniqueid,ROLE_SELECT:".modal.show #template-role"+popupCourseCreateUniqueid,GROUPS_SELECT:".modal.show #system_groups_ac"+popupCourseCreateUniqueid,NULL_CHECKBOX:".modal.show #keynull"+popupCourseCreateUniqueid};(0,_jquery.default)(Selector.CATEGORY_SELECT).parent().find(".error-block").hide(),(0,_jquery.default)(Selector.COURSE_SELECT).parent().find(".error-block").hide(),(0,_jquery.default)(Selector.ROLE_SELECT).parent().find(".error-block").hide(),(0,_jquery.default)(Selector.GROUPS_SELECT).parent().find(".error-block").hide(),(0,_jquery.default)(Selector.NULL_CHECKBOX).parent().find(".error-block").hide();let categoryid=(0,_jquery.default)(Selector.CATEGORY_SELECT).val(),courseid=(0,_jquery.default)(Selector.COURSE_SELECT).val(),roleid=(0,_jquery.default)(Selector.ROLE_SELECT).val(),groups=(0,_jquery.default)(Selector.GROUPS_SELECT).val();if(0===categoryid.length||0===courseid.length||0===roleid.length)return 0===categoryid.length&&(0,_jquery.default)(Selector.CATEGORY_SELECT).parent().find(".error-block").show(),0===courseid.length&&(0,_jquery.default)(Selector.COURSE_SELECT).parent().find(".error-block").show(),0===roleid.length&&(0,_jquery.default)(Selector.ROLE_SELECT).parent().find(".error-block").show(),!1;var data={categoryid:categoryid,courseid:courseid,roleid:roleid,groups:JSON.stringify(groups),nullcheck:true,currentuserid:currentuserid,users:JSON.stringify(users)};Ajax.call([{methodname:"local_petel_create_courses_for_teachers",args:data,done:function(response){response.result&&Str.get_strings([{key:"coursescreated",component:"local_petel"}]).done((function(strings){Toast.add(strings[0])}))},fail:_notification.default.exception}])}}}));

//# sourceMappingURL=action_participants_custom.min.js.map