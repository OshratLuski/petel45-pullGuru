{"version":3,"file":"issues.min.js","sources":["../src/issues.js"],"sourcesContent":["define([\r\n    'jquery',\r\n    'core/str',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/ajax',\r\n    'core/templates',\r\n    'core/notification',\r\n    'local_redmine/chat'\r\n\r\n], function($, Str, ModalFactory, ModalEvents, Ajax, Templates, Notification, Chat) {\r\n\r\n    let global_params = {\r\n        default_search: '',\r\n    };\r\n\r\n    let history_params = {\r\n        search: '',\r\n        filter: 3,\r\n        sort_col: '',\r\n        sort_dir: '',\r\n        page: 1,\r\n    };\r\n\r\n    let active_params = {\r\n        search: '',\r\n        filter: 1,\r\n        sort_col: '',\r\n        sort_dir: '',\r\n        page: 1,\r\n    };\r\n\r\n    let SELECTORS = {\r\n        ACTIVEISSUES: '.activeissues-wrapper',\r\n        HISTORYISSUES: '.history-wrapper'\r\n    };\r\n\r\n    return {\r\n        init: function(issueid) {\r\n            // Hide header block.\r\n            $('#page-header').addClass('d-none');\r\n\r\n            if(issueid !== undefined){\r\n                this.renderChatPage(issueid);\r\n            }else{\r\n                this.renderIssuesPage();\r\n            }\r\n        },\r\n\r\n        renderIssuesPage: function() {\r\n            let self = this;\r\n\r\n            Templates.render('local_redmine/issues/view', global_params)\r\n                .done(function(html, js) {\r\n                    Templates.replaceNodeContents('#local-redmine-issues-page', html, js);\r\n\r\n                    self.renderIssuesActiveBlock();\r\n                    self.renderIssuesHistoryBlock();\r\n\r\n                    $(\"#local-redmine-search\").change(function(e) {\r\n                        let value = $(e.target).val();\r\n\r\n                        global_params.default_search = value;\r\n\r\n                        history_params.search = value;\r\n                        history_params.page = 1;\r\n                        self.renderIssuesHistoryBlock();\r\n\r\n                        active_params.search = value;\r\n                        active_params.page = 1;\r\n                        self.renderIssuesActiveBlock();\r\n                    });\r\n                });\r\n        },\r\n\r\n        renderIssuesActiveBlock: function() {\r\n            let self = this;\r\n\r\n            this.showLoading(SELECTORS.ACTIVEISSUES);\r\n            Ajax.call([{\r\n                methodname: 'local_redmine_get_active_issues',\r\n                args: active_params,\r\n                done: function(response) {\r\n\r\n                    let data = JSON.parse(response);\r\n                    Templates.render('local_redmine/issues/activeissues', data)\r\n                        .done(function(html, js) {\r\n                            Templates.replaceNodeContents('#local-redmine-issues-activeissues', html, js);\r\n\r\n                            // Events on activeissues block.\r\n                            $(\"#local-redmine-activeissues-block\").on(\"click\", function(e) {\r\n\r\n                                // Paging.\r\n                                if ($(e.target).data('area') === 'paging') {\r\n                                    if ($(e.target).data('value') !== 'next' && $(e.target).data('value') !== 'previus') {\r\n                                        active_params.page = $(e.target).data('value');\r\n                                    } else {\r\n                                        let active_page = $(e.target).parent().parent().find('.active a').data('value');\r\n\r\n                                        if ($(e.target).data('value') === 'next') {\r\n                                            active_params.page = active_page + 1;\r\n                                        }\r\n\r\n                                        if ($(e.target).data('value') === 'previus') {\r\n                                            active_params.page = active_page - 1;\r\n                                        }\r\n                                    }\r\n\r\n                                    self.renderIssuesActiveBlock();\r\n                                }\r\n\r\n                             \r\n                                // Sorting.\r\n                                if ($(e.target).data('area') === 'sorting') {\r\n                                    active_params.sort_col = $(e.target).data('column');\r\n\r\n                                    let direction = '';\r\n                                    if ($(e.target).data('value').length === 0 || $(e.target).data('value') === 'asc') {\r\n                                        direction = 'desc';\r\n                                    }\r\n\r\n                                    if ($(e.target).data('value') === 'desc') {\r\n                                        direction = 'asc';\r\n                                    }\r\n\r\n                                    active_params.sort_col = $(e.target).data('column');\r\n                                    active_params.sort_dir = direction;\r\n\r\n                                    active_params.page = 1;\r\n                                    self.renderIssuesActiveBlock();\r\n                                }\r\n\r\n                                // Get single issue page.\r\n                                if ($(e.target).closest('.appeals-history-table-row').data('area') === 'edit_page') {\r\n                                    let id = $(e.target).data('value') || $(e.target).closest('.appeals-history-table-row').data('value');\r\n\r\n                                    self.showLoading(SELECTORS.ACTIVEISSUES);\r\n                                    self.renderChatPage(id);\r\n                                }\r\n                            });\r\n                            // Filter.\r\n                            $(\"#local-redmine-activeissues-block select.custom-select\").on('change', function (e) {\r\n                                active_params.filter = $(this).find('option:selected').data('value');\r\n                                active_params.page = 1;\r\n                                self.renderIssuesActiveBlock();\r\n                              })\r\n\r\n                            self.hideLoading(SELECTORS.ACTIVEISSUES);\r\n                        });\r\n                },\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        renderIssuesHistoryBlock: function() {\r\n            let self = this;\r\n            this.showLoading(SELECTORS.HISTORYISSUES);\r\n            console.debug(history_params)\r\n            Ajax.call([{\r\n                methodname: 'local_redmine_get_history_issues',\r\n                args: history_params,\r\n                done: function(response) {\r\n\r\n                    let data = JSON.parse(response);\r\n                    Templates.render('local_redmine/issues/history', data)\r\n                        .done(function(html, js) {\r\n                            Templates.replaceNodeContents('#local-redmine-issues-history', html, js);\r\n\r\n                            // Events on history block.\r\n                            $(\"#local-redmine-history-block\").on(\"click\", function(e) {\r\n\r\n                                // Paging.\r\n                                if ($(e.target).data('area') === 'paging') {\r\n                                    if ($(e.target).data('value') !== 'next' && $(e.target).data('value') !== 'previus') {\r\n                                        history_params.page = $(e.target).data('value');\r\n                                    } else {\r\n                                        let active_page = $(e.target).parent().parent().find('.active a').data('value');\r\n\r\n                                        if ($(e.target).data('value') === 'next') {\r\n                                            history_params.page = active_page + 1;\r\n                                        }\r\n\r\n                                        if ($(e.target).data('value') === 'previus') {\r\n                                            history_params.page = active_page - 1;\r\n                                        }\r\n                                    }\r\n\r\n                                    self.renderIssuesHistoryBlock();\r\n                                }\r\n\r\n                                // Sorting.\r\n                                if ($(e.target).data('area') === 'sorting') {\r\n                                    history_params.sort_col = $(e.target).data('column');\r\n\r\n                                    let direction = '';\r\n                                    if ($(e.target).data('value').length === 0 || $(e.target).data('value') === 'asc') {\r\n                                        direction = 'desc';\r\n                                    }\r\n\r\n                                    if ($(e.target).data('value') === 'desc') {\r\n                                        direction = 'asc';\r\n                                    }\r\n\r\n                                    history_params.sort_col = $(e.target).data('column');\r\n                                    history_params.sort_dir = direction;\r\n\r\n                                    history_params.page = 1;\r\n                                    self.renderIssuesHistoryBlock();\r\n                                }\r\n\r\n                                // Get single issue page.\r\n                                if ($(e.target).closest('.appeals-history-table-row').data('area') === 'edit_page') {\r\n                                    let id = $(e.target).data('value') || $(e.target).closest('.appeals-history-table-row').data('value');\r\n\r\n                                    self.showLoading(SELECTORS.ACTIVEISSUES);\r\n                                    self.renderChatPage(id);\r\n                                }\r\n                            });\r\n                            \r\n                            // Filter.\r\n                            $(\"#local-redmine-history-block select.custom-select\").on('change', function (e) {\r\n                                history_params.filter = $(this).find('option:selected').data('value');\r\n                                history_params.page = 1;\r\n                                self.renderIssuesHistoryBlock();\r\n                              })\r\n                            self.hideLoading(SELECTORS.HISTORYISSUES);\r\n                        });\r\n                },\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        renderChatPage: function(id) {\r\n            let self = this;\r\n\r\n            Ajax.call([{\r\n                methodname: 'local_redmine_get_chat_page',\r\n                args: {\r\n                    id: id,\r\n                },\r\n                done: function(response) {\r\n                    let data = JSON.parse(response);\r\n\r\n                    self.buildHistoryUrl(id);\r\n\r\n                    Templates.render('local_redmine/chat/view', data)\r\n                        .done(function(html, js) {\r\n                            Templates.replaceNodeContents('#local-redmine-issues-page', html, js);\r\n\r\n                            // Event back page.\r\n                            $(\"#local-redmine-messages-page\").on(\"click\", function(e) {\r\n                                if ($(e.target).data('action') === 'back_button') {\r\n                                    self.renderIssuesPage();\r\n                                    self.buildHistoryUrl(0);\r\n                                }\r\n                            })\r\n\r\n                            Chat.init(id);\r\n                        });\r\n                },\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        showLoading: function(parent){\r\n            $('.messages-loading-wrapper').show();\r\n        },\r\n\r\n        hideLoading: function(parent){\r\n            $('.messages-loading-wrapper').hide();\r\n        },\r\n\r\n        buildHistoryUrl: function (issueid) {\r\n\r\n            // Build url.\r\n            if(issueid === 0){\r\n                window.history.replaceState({}, document.title, window.location.pathname);\r\n            }\r\n\r\n            if(issueid !== 0){\r\n                let url = '?id=' + issueid;\r\n                window.history.pushState(\"\", \"\", url);\r\n            }\r\n\r\n            return true;\r\n        },\r\n    };\r\n});\r\n"],"names":["define","$","Str","ModalFactory","ModalEvents","Ajax","Templates","Notification","Chat","global_params","default_search","history_params","search","filter","sort_col","sort_dir","page","active_params","SELECTORS","init","issueid","addClass","undefined","renderChatPage","renderIssuesPage","self","this","render","done","html","js","replaceNodeContents","renderIssuesActiveBlock","renderIssuesHistoryBlock","change","e","value","target","val","showLoading","call","methodname","args","response","data","JSON","parse","on","active_page","parent","find","direction","length","closest","id","hideLoading","fail","exception","console","debug","buildHistoryUrl","show","hide","window","history","replaceState","document","title","location","pathname","url","pushState"],"mappings":"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"}