define("local_redmine/support",["jquery","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/notification","local_redmine/html2canvas","local_redmine/pageProperties"],(function($,Str,ModalFactory,ModalEvents,Ajax,Templates,Notification,html2canvas,pageProperties){let screenshot,popup_disable=!1,myip="";return{init:function(){let self=this;self.renderIssueCounter(),pageProperties.getIP((function(ip){myip=ip})),$("#support-btn").click((()=>(self.supportPopup(),!1))),$("#support-btn-student").click((e=>($(e.target).addClass("active disabled"),self.insertSpinner("#support-btn-student"),self.supportPopupStudent(),!1)))},supportPopup:function(def){const self=this;if(popup_disable)return;popup_disable=!0;let context={};switch(def){case 1:default:context={default_question:!0};break;case 2:context={default_pedagogical_help:!0};break;case 3:context={default_suggest_improvement:!0};break;case 4:context={default_contenterror_report:!0};break;case 5:context={default_error_report:!0}}Str.get_strings([{key:"have_you_a_question",component:"local_redmine"},{key:"send",component:"local_redmine"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0]});$.when(modalPromise).then((function(fmodal){return fmodal.setSaveButtonText(strings[1]),Templates.render("local_redmine/support/supportPopup",context).done((function(html,js){fmodal.setBody(html)})),fmodal.getRoot().on(ModalEvents.bodyRendered,(function(){let support_activities_div=fmodal.body.find("#support_activities"),support_activities_title=fmodal.body.find("#support_activities_title");popup_disable=!1;var callback,ms,timer;$(fmodal.body.find("#more_info")).keyup((callback=function(e){support_activities_div.hide(),support_activities_title.hide();var query=$(this).val().trim();query.length>0&&get_activities(query)},ms=500,timer=0,function(){var context=this,args=arguments;clearTimeout(timer),timer=setTimeout((function(){callback.apply(context,args)}),ms||0)}));let get_activities=query=>{Ajax.call([{methodname:"local_redmine_get_support_activities",args:{query:query},done:render_activities}])},render_activities=list=>{(list=JSON.parse(list)).length>0?(support_activities_div.show(),support_activities_title.show()):(support_activities_div.hide(),support_activities_title.hide()),support_activities_div.html(""),list.forEach((act=>{let link=$("<a>",{href:act.link,html:act.title+' <i class="fa fa-external-link" aria-hidden="true"></i>',target:"blank"});support_activities_div.append(link)}))}})),fmodal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),fmodal.body.find(".more_info_error").hide(),fmodal.body.find(".question_type_error").hide();var more_info=fmodal.body.find("#more_info").val(),upload_info=fmodal.body.find("#upload_info").val(),question=fmodal.body.find('input[name="questionType"]:checked').val(),errors=[];more_info.trim().length||(fmodal.body.find(".more_info_error").show(),fmodal.body.find("#more_info").focus(),errors.push("Error more_info")),void 0===question&&(fmodal.body.find(".question_type_error").show(),fmodal.body.find("#rg1").focus(),errors.push("Error question")),0===errors.length&&(self.insertSpinner($(fmodal.footer).find('[data-action="save"]')),Ajax.call([{methodname:"local_redmine_support_request",args:{userBrowserName:pageProperties.getBrowser().name,userBrowserVersion:pageProperties.getBrowser().version,userIP:myip,moreInfo:more_info,uploadInfo:upload_info,resolution:pageProperties.getResolution(),pageurl:pageProperties.getPageUrl(),questionType:question},done:function(response){self.removeSpinner($(fmodal.footer).find('[data-action="save"]')),fmodal.destroy(),Str.get_strings([{key:"supportsuccesssendtitle",component:"local_redmine"},{key:"supportsuccesssendcontent",component:"local_redmine"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.ALERT,title:strings[0],body:strings[1]});$.when(modalPromise).then((function(fmodal){return fmodal.show(),fmodal})).fail(Notification.exception)}))},fail:Notification.exception}]))})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)}))},supportPopupStudent:function(){const self=this;popup_disable||(popup_disable=!0,Str.get_strings([{key:"question_to_teacher",component:"local_redmine"},{key:"send",component:"local_redmine"}]).done((function(strings){const screen=document.querySelector("body");html2canvas(screen).then((canvas=>{screenshot=canvas.toDataURL("image/jpeg");var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0]});$.when(modalPromise).then((function(fmodal){fmodal.setSaveButtonText(strings[1]);let context={screenshot:screenshot};return Templates.render("local_redmine/support/supportPopupStudent",context).done((function(html,js){fmodal.setBody(html),popup_disable=!1})),fmodal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),fmodal.body.find(".more_info_error").hide();var more_info=fmodal.body.find("#more_info").val(),upload_info=fmodal.body.find("#upload_info").val(),errors=[];more_info.trim().length||errors.push("Error more_info"),0===errors.length?(self.insertSpinner($(fmodal.footer).find('[data-action="save"]')),Ajax.call([{methodname:"local_redmine_support_student_request",args:{userBrowserName:pageProperties.getBrowser().name,userBrowserVersion:pageProperties.getBrowser().version,userIP:myip,screenshot:screenshot,moreInfo:more_info,uploadInfo:upload_info,resolution:pageProperties.getResolution(),pageurl:pageProperties.getPageUrl(),courseid:pageProperties.getCourseID()},done:function(response){self.removeSpinner($(fmodal.footer).find('[data-action="save"]')),fmodal.destroy(),Str.get_strings([{key:"supportstudentsuccesssendtitle",component:"local_redmine"},{key:"supportstudentsuccesssendcontent",component:"local_redmine"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.ALERT,title:strings[0],body:strings[1]});$.when(modalPromise).then((function(fmodal){return fmodal.show(),fmodal})).fail(Notification.exception)}))},fail:Notification.exception}])):(fmodal.body.find(".more_info_error").show(),fmodal.body.find("#more_info").focus())})),fmodal})).done((function(modal){modal.show(),$("#support-btn-student").removeClass("active disabled"),self.removeSpinner("#support-btn-student")})).fail(Notification.exception)}))})))},insertSpinner:function(parent){if(0==$(parent).find("span").length){let innerText=$(parent).html();innerText='<span class="btn-text" style="display:none;"> '.concat(innerText," </span>").concat('<div class="spinner-border text-white align-items-center justify-conten-center" role="status" style="width: 1.5rem; height: 1.5rem; display:flex;">\n                        <span class="sr-only">Loading...</span>\n                    </div>'),$(parent).html(innerText).addClass("disabled").attr("disabled","disabled")}else $(parent).find(".btn-text").hide(),$(parent).find(".spinner-border").show(),$(parent).addClass("disabled").attr("disabled","disabled")},removeSpinner:function(parent){$(parent).find(".btn-text").show(),$(parent).find(".spinner-border").hide(),$(parent).removeClass("disabled").removeAttr("disabled")},renderIssueCounter:function(){Str.get_strings([{key:"have_you_a_question",component:"local_redmine"},{key:"send",component:"local_redmine"}]).done((function(strings){Ajax.call([{methodname:"local_redmine_issues_counter_user",args:{},done:function(response){let data=JSON.parse(response);data.counter>0?($("#issues_counter_user").text(data.counter).show(),$("#issues_counter_user_span").text(data.counter),$("#issues_counter_user_block").show()):($("#issues_counter_user").hide(),$("#issues_counter_user_block").hide())},fail:Notification.exception}])}))}}}));

//# sourceMappingURL=support.min.js.map