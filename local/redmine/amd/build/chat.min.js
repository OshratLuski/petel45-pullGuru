define("local_redmine/chat",["jquery","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/notification","local_redmine/support"],(function($,Str,ModalFactory,ModalEvents,Ajax,Templates,Notification,Support){let issueid;return{init:function(id){$("#page-header").addClass("d-none"),issueid=id,$(".messages-loading-wrapper").show(),this.renderMessageBlock((function(){$(".messages-loading-wrapper").hide()}))},renderMessageBlock:function(callback){let self=this;Ajax.call([{methodname:"local_redmine_get_chat_messages",args:{id:issueid},done:function(response){let data=JSON.parse(response);Templates.render("local_redmine/chat/messages",data).done((function(html,js){Templates.replaceNodeContents("#local_redmine_messages_content",html,js),$(".messaging-form").submit(!1),$("#local_redmine_message_submit").click((function(e){self.sendMessage()})),callback()}))},fail:Notification.exception}])},sendMessage:function(){const self=this,file=$("#local_redmine_outcomming_file").prop("files")[0];let message=$("#local_redmine_outcomming_message").val().trim();if($("#error-message").hide(),$("#error-imgformat-message").hide(),"true"===$("#local_redmine_outcomming_file").data("added-file").toString()&&0===message.length)return $("#error-message").show(),!1;if(0===message.length)return!1;if($(".messages-loading-wrapper").show(),void 0!==file){let filename=file.name,filetype=file.type;var reader=new FileReader;reader.readAsDataURL(file),reader.onload=function(){let filecontent=reader.result;Ajax.call([{methodname:"local_redmine_send_chat_message",args:{id:issueid,message:message,filename:filename,filetype:filetype,filecontent:filecontent},done:function(response){self.renderMessageBlock((function(){$(".messages-loading-wrapper").hide()})),Support.renderIssueCounter()},fail:Notification.exception}])}}else Ajax.call([{methodname:"local_redmine_send_chat_message",args:{id:issueid,message:message,filename:"",filetype:"",filecontent:""},done:function(response){self.renderMessageBlock((function(){$(".messages-loading-wrapper").hide()})),Support.renderIssueCounter()},fail:Notification.exception}])},chatPageActions:function(){$(".messaging-form .fa-paperclip").on("click",(function(e){e.preventDefault(),e.stopPropagation(),"false"===$("#local_redmine_outcomming_file").data("added-file").toString()&&$("#local_redmine_outcomming_file").trigger("click")})),$("#local_redmine_outcomming_file").on("change",(function(e){let valueArr=$(this).val().split(".");const format=valueArr[valueArr.length-1];if("jpg"===format.toLowerCase()||"png"===format.toLowerCase()||"jpeg"===format.toLowerCase()){$(this).data("added-file","true"),$(".messaging-form .fa-paperclip").hide(),$(".messaging-form .fa-paperclip.text-success").show(),$("#error-imgformat-message").hide();const filenameText=$(this)[0].files[0].name;$("#loaded-file-name").text(filenameText),$("#added-file-block").show(),$("#local_redmine_outcomming_file").data("added-file",!0)}else $(this).data("added-file","false"),$("#added-file-block").hide(),$("#error-imgformat-message").show()})),$(document).on("click","#delete-file-btn",(function(){$("#local_redmine_outcomming_file").data("added-file","false"),$("#local_redmine_outcomming_file").val(""),$(".messaging-form .fa-paperclip").show(),$(".messaging-form .fa-paperclip.text-success").hide(),$("#added-file-block").hide(),$("#error-message").hide()})),$("#local_redmine_outcomming_message").on("input",(function(){$("#error-message").hide()})),$([document.documentElement,document.body]).animate({scrollTop:$("h1").last().offset().top},500),$(".message-wrapper").length>1&&$(".messaging-block-inner").animate({scrollTop:$(".message-wrapper").last().offset().top},10)}}}));

//# sourceMappingURL=chat.min.js.map