{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["define([\r\n    'jquery',\r\n    'core/str',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/ajax',\r\n    'core/templates',\r\n    'core/notification',\r\n    'local_redmine/support',\r\n\r\n], function($, Str, ModalFactory, ModalEvents, Ajax, Templates, Notification, Support) {\r\n\r\n    let issueid;\r\n\r\n    return {\r\n        init: function(id) {\r\n            // Hide header block.\r\n            $('#page-header').addClass('d-none');\r\n\r\n            issueid = id;\r\n\r\n            $('.messages-loading-wrapper').show();\r\n\r\n            this.renderMessageBlock(function(){\r\n                $('.messages-loading-wrapper').hide();\r\n            });\r\n        },\r\n\r\n        renderMessageBlock: function(callback) {\r\n            let self = this;\r\n\r\n            Ajax.call([{\r\n                methodname: 'local_redmine_get_chat_messages',\r\n                args: {\r\n                    id: issueid,\r\n                },\r\n                done: function(response) {\r\n                    let data = JSON.parse(response);\r\n\r\n                    Templates.render('local_redmine/chat/messages', data)\r\n                        .done(function(html, js) {\r\n                            Templates.replaceNodeContents('#local_redmine_messages_content', html, js);\r\n\r\n                            // Events.\r\n                            $('.messaging-form').submit(false);\r\n                            $('#local_redmine_message_submit').click(function(e) {\r\n                                self.sendMessage();\r\n                            });\r\n\r\n                            callback();\r\n                        });\r\n                },\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        sendMessage: function() {\r\n            const self = this;\r\n            const file = $(\"#local_redmine_outcomming_file\").prop(\"files\")[0];\r\n            let message = $('#local_redmine_outcomming_message').val().trim();\r\n\r\n            $('#error-message').hide();\r\n            $('#error-imgformat-message').hide();\r\n\r\n            if ($('#local_redmine_outcomming_file').data('added-file').toString() === \"true\" && message.length === 0){\r\n                $('#error-message').show();\r\n                return false;\r\n\r\n            } else if (message.length === 0) {\r\n                return false;\r\n            }\r\n            \r\n            // Loading.\r\n            $('.messages-loading-wrapper').show();\r\n\r\n            \r\n            if (file !== undefined) {\r\n                let filename = file.name;\r\n                let filetype = file.type;\r\n\r\n                // Create FileReader object\r\n                var reader = new FileReader();\r\n                reader.readAsDataURL(file);\r\n\r\n                // Get base64 image from FileReader object\r\n                reader.onload = function() {\r\n                    let filecontent = reader.result;\r\n\r\n                    Ajax.call([{\r\n                        methodname: 'local_redmine_send_chat_message',\r\n                        args: {\r\n                            id: issueid,\r\n                            message: message,\r\n                            filename: filename,\r\n                            filetype: filetype,\r\n                            filecontent: filecontent\r\n                        },\r\n                        done: function(response) {\r\n                            self.renderMessageBlock(function(){\r\n                                $('.messages-loading-wrapper').hide();\r\n                            });\r\n                            Support.renderIssueCounter();\r\n                        },\r\n                        fail: Notification.exception\r\n                    }]);\r\n                };\r\n            } else {\r\n                Ajax.call([{\r\n                    methodname: 'local_redmine_send_chat_message',\r\n                    args: {\r\n                        id: issueid,\r\n                        message: message,\r\n                        filename: '',\r\n                        filetype: '',\r\n                        filecontent: ''\r\n                    },\r\n                    done: function(response) {\r\n                        self.renderMessageBlock(function(){\r\n                            $('.messages-loading-wrapper').hide();\r\n                        });\r\n                        Support.renderIssueCounter();\r\n                    },\r\n                    fail: Notification.exception\r\n                }]);\r\n            }\r\n        },\r\n        chatPageActions: function() {\r\n\r\n            $('.messaging-form .fa-paperclip').on('click', function(e) {\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n                // If file not added - trigger click on hidden input type=\"file\"\r\n                if ($('#local_redmine_outcomming_file').data('added-file').toString() === \"false\") {\r\n                    $('#local_redmine_outcomming_file').trigger('click');\r\n                }\r\n            });\r\n\r\n            $('#local_redmine_outcomming_file').on('change', function(e) {\r\n\r\n                // Check input type=\"file\" loaded file format\r\n                let valueArr = $(this).val().split('.');\r\n                const format = valueArr[(valueArr.length - 1)];\r\n\r\n                // If format is correct\r\n                if (format.toLowerCase() === 'jpg' || format.toLowerCase() === 'png' || format.toLowerCase() === 'jpeg') {\r\n                    // Change input type=\"file\" data attribute to avoid second click;\r\n                    $(this).data('added-file', 'true');\r\n\r\n                    // Change btn color\r\n                    $('.messaging-form .fa-paperclip').hide();\r\n                    $('.messaging-form .fa-paperclip.text-success').show();\r\n\r\n                    // Hide error message block.\r\n                    $('#error-imgformat-message').hide();\r\n\r\n                    // Add filename into added-file-block message and show block.\r\n                    const filenameText = $(this)[0].files[0].name;\r\n                    $('#loaded-file-name').text(filenameText);\r\n                    $('#added-file-block').show();\r\n                    $('#local_redmine_outcomming_file').data('added-file', true);\r\n                } else {\r\n                    // If format incorrect.\r\n                    // Change input type=\"file\" data attr.\r\n                    $(this).data('added-file', \"false\");\r\n\r\n                    // Hide added-file-block message.\r\n                    $('#added-file-block').hide();\r\n\r\n                    // Show error message.\r\n                    $('#error-imgformat-message').show();\r\n                }\r\n            });\r\n\r\n            // Delete loaded file from input type=\"file\" and file name string (under message text input)\r\n            $(document).on('click', '#delete-file-btn', function() {\r\n                $('#local_redmine_outcomming_file').data('added-file', \"false\");\r\n                $('#local_redmine_outcomming_file').val('');\r\n                $('.messaging-form .fa-paperclip').show();\r\n                $('.messaging-form .fa-paperclip.text-success').hide();\r\n                $('#added-file-block').hide();\r\n                $('#error-message').hide();\r\n            });\r\n\r\n            // Remove eror message when start typing text\r\n            $('#local_redmine_outcomming_message').on('input', function() {\r\n                $('#error-message').hide();\r\n            });\r\n\r\n            // Scroll page to lasst message\r\n            $([document.documentElement, document.body]).animate({\r\n                scrollTop:   $('h1').last().offset().top\r\n            }, 500);\r\n            if ($('.message-wrapper').length > 1) {\r\n                $('.messaging-block-inner').animate({\r\n                    scrollTop:   $('.message-wrapper').last().offset().top\r\n                }, 10);\r\n            }\r\n\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Str","ModalFactory","ModalEvents","Ajax","Templates","Notification","Support","issueid","init","id","addClass","show","renderMessageBlock","hide","callback","self","this","call","methodname","args","done","response","data","JSON","parse","render","html","js","replaceNodeContents","submit","click","e","sendMessage","fail","exception","file","prop","message","val","trim","toString","length","undefined","filename","name","filetype","type","reader","FileReader","readAsDataURL","onload","filecontent","result","renderIssueCounter","chatPageActions","on","preventDefault","stopPropagation","trigger","valueArr","split","format","toLowerCase","filenameText","files","text","document","documentElement","body","animate","scrollTop","last","offset","top"],"mappings":"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"}