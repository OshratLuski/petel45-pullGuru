define("local_redmine/issues",["jquery","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/notification","local_redmine/chat"],(function($,Str,ModalFactory,ModalEvents,Ajax,Templates,Notification,Chat){let global_params={default_search:""},history_params={search:"",filter:3,sort_col:"",sort_dir:"",page:1},active_params={search:"",filter:1,sort_col:"",sort_dir:"",page:1},SELECTORS_ACTIVEISSUES=".activeissues-wrapper",SELECTORS_HISTORYISSUES=".history-wrapper";return{init:function(issueid){$("#page-header").addClass("d-none"),void 0!==issueid?this.renderChatPage(issueid):this.renderIssuesPage()},renderIssuesPage:function(){let self=this;Templates.render("local_redmine/issues/view",global_params).done((function(html,js){Templates.replaceNodeContents("#local-redmine-issues-page",html,js),self.renderIssuesActiveBlock(),self.renderIssuesHistoryBlock(),$("#local-redmine-search").change((function(e){let value=$(e.target).val();global_params.default_search=value,history_params.search=value,history_params.page=1,self.renderIssuesHistoryBlock(),active_params.search=value,active_params.page=1,self.renderIssuesActiveBlock()}))}))},renderIssuesActiveBlock:function(){let self=this;this.showLoading(SELECTORS_ACTIVEISSUES),Ajax.call([{methodname:"local_redmine_get_active_issues",args:active_params,done:function(response){let data=JSON.parse(response);Templates.render("local_redmine/issues/activeissues",data).done((function(html,js){Templates.replaceNodeContents("#local-redmine-issues-activeissues",html,js),$("#local-redmine-activeissues-block").on("click",(function(e){if("paging"===$(e.target).data("area")){if("next"!==$(e.target).data("value")&&"previus"!==$(e.target).data("value"))active_params.page=$(e.target).data("value");else{let active_page=$(e.target).parent().parent().find(".active a").data("value");"next"===$(e.target).data("value")&&(active_params.page=active_page+1),"previus"===$(e.target).data("value")&&(active_params.page=active_page-1)}self.renderIssuesActiveBlock()}if("sorting"===$(e.target).data("area")){active_params.sort_col=$(e.target).data("column");let direction="";0!==$(e.target).data("value").length&&"asc"!==$(e.target).data("value")||(direction="desc"),"desc"===$(e.target).data("value")&&(direction="asc"),active_params.sort_col=$(e.target).data("column"),active_params.sort_dir=direction,active_params.page=1,self.renderIssuesActiveBlock()}if("edit_page"===$(e.target).closest(".appeals-history-table-row").data("area")){let id=$(e.target).data("value")||$(e.target).closest(".appeals-history-table-row").data("value");self.showLoading(SELECTORS_ACTIVEISSUES),self.renderChatPage(id)}})),$("#local-redmine-activeissues-block select.custom-select").on("change",(function(e){active_params.filter=$(this).find("option:selected").data("value"),active_params.page=1,self.renderIssuesActiveBlock()})),self.hideLoading(SELECTORS_ACTIVEISSUES)}))},fail:Notification.exception}])},renderIssuesHistoryBlock:function(){let self=this;this.showLoading(SELECTORS_HISTORYISSUES),console.debug(history_params),Ajax.call([{methodname:"local_redmine_get_history_issues",args:history_params,done:function(response){let data=JSON.parse(response);Templates.render("local_redmine/issues/history",data).done((function(html,js){Templates.replaceNodeContents("#local-redmine-issues-history",html,js),$("#local-redmine-history-block").on("click",(function(e){if("paging"===$(e.target).data("area")){if("next"!==$(e.target).data("value")&&"previus"!==$(e.target).data("value"))history_params.page=$(e.target).data("value");else{let active_page=$(e.target).parent().parent().find(".active a").data("value");"next"===$(e.target).data("value")&&(history_params.page=active_page+1),"previus"===$(e.target).data("value")&&(history_params.page=active_page-1)}self.renderIssuesHistoryBlock()}if("sorting"===$(e.target).data("area")){history_params.sort_col=$(e.target).data("column");let direction="";0!==$(e.target).data("value").length&&"asc"!==$(e.target).data("value")||(direction="desc"),"desc"===$(e.target).data("value")&&(direction="asc"),history_params.sort_col=$(e.target).data("column"),history_params.sort_dir=direction,history_params.page=1,self.renderIssuesHistoryBlock()}if("edit_page"===$(e.target).closest(".appeals-history-table-row").data("area")){let id=$(e.target).data("value")||$(e.target).closest(".appeals-history-table-row").data("value");self.showLoading(SELECTORS_ACTIVEISSUES),self.renderChatPage(id)}})),$("#local-redmine-history-block select.custom-select").on("change",(function(e){history_params.filter=$(this).find("option:selected").data("value"),history_params.page=1,self.renderIssuesHistoryBlock()})),self.hideLoading(SELECTORS_HISTORYISSUES)}))},fail:Notification.exception}])},renderChatPage:function(id){let self=this;Ajax.call([{methodname:"local_redmine_get_chat_page",args:{id:id},done:function(response){let data=JSON.parse(response);self.buildHistoryUrl(id),Templates.render("local_redmine/chat/view",data).done((function(html,js){Templates.replaceNodeContents("#local-redmine-issues-page",html,js),$("#local-redmine-messages-page").on("click",(function(e){"back_button"===$(e.target).data("action")&&(self.renderIssuesPage(),self.buildHistoryUrl(0))})),Chat.init(id)}))},fail:Notification.exception}])},showLoading:function(parent){$(".messages-loading-wrapper").show()},hideLoading:function(parent){$(".messages-loading-wrapper").hide()},buildHistoryUrl:function(issueid){if(0===issueid&&window.history.replaceState({},document.title,window.location.pathname),0!==issueid){let url="?id="+issueid;window.history.pushState("","",url)}return!0}}}));

//# sourceMappingURL=issues.min.js.map