define("community_sharequestion/main",["jquery","core/yui","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/notification","core/fragment","community_sharequestion/sendtoteacher","community_sharequestion/select2"],(function($,Y,Str,ModalFactory,ModalEvents,Ajax,Templates,Notification,Fragment,SendToTeacher){M.cfg.sesskey;function build_select2(modal,sclass){var select2Target=modal.body.find(sclass),dropdownParent=select2Target.closest(".select-wrapper");select2Target.select2({dropdownAutoWidth:!0,dropdownParent:dropdownParent})}function open_selector(){let selected=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,currentcourseid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,currentcoursecontext=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,type=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,self=this;switch(null!==selected&&(this.selected_questions=selected),null!==currentcourseid&&(this.currentcourseid=currentcourseid),null!==currentcoursecontext&&(this.currentcoursecontext=currentcoursecontext),type){case"all":self.large=!0,self.context_template={questionupload:!0,copyquestionstoteacher:!0,copyquestionstocategory:!0,copyquestionstoquiz:!0};break;case"all-nooer":self.large=!0,self.context_template={questionupload:!1,copyquestionstoteacher:!0,copyquestionstocategory:!0,copyquestionstoquiz:!0};break;case"message":case"oer":self.large=!1,self.context_template={copyquestionstocategory:!0,copyquestionstoquiz:!0}}0!==this.selected_questions.length&&Str.get_strings([{key:"menupopuptitle",component:"community_sharequestion"},{key:"cancel",component:"community_sharequestion"}]).done((function(strings){Templates.render("community_sharequestion/selector",self.context_template).done((function(html){var modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,large:self.large,title:strings[0],body:html});$.when(modalPromise).then((function(modal){return modal.setButtonText("cancel",strings[1]),modal.getRoot()[0].classList.add("sharemodal"),modal.getRoot()[0].classList.add("sharequestionmodal"),modal.getRoot().find(".modal-dialog").addClass("modal-dialog-centered"),modal.show(),modal.body.find("button").on("click",(function(e){switch(e.stopPropagation(),e.currentTarget.dataset.handler){case"copyQuestionsToQuiz":self.flag_background_enable=!0,modal.destroy(),function(){let self=this;0!==this.selected_questions.length&&Str.get_strings([{key:"copyquestionstoquiz",component:"community_sharequestion"},{key:"copy",component:"community_sharequestion"},{key:"back",component:"community_sharequestion"},{key:"copyquestionstoquizsuccess",component:"community_sharequestion"}]).done((function(strings){Ajax.call([{methodname:"community_sharequestion_copy_to_quiz_html",args:{currentcourseid:self.currentcourseid},done:function(response){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:response}).done((function(modal){modal.setSaveButtonText(strings[1]),modal.setButtonText("cancel",strings[2]),modal.getRoot().addClass("copy-question-to-cat-modal"),build_select2(modal,".select-course"),build_select2(modal,".select-quiz"),modal.body.find(".select-course").on("change",(function(e){modal.body.find(".select-quiz-error").hide();let courseid=this.value;Ajax.call([{methodname:"community_sharequestion_get_quizes_by_course",args:{courseid:courseid},done:function(response){let data=JSON.parse(response);modal.body.find(".select-quiz").empty(),$.each(data.activities,(function(index,obj){modal.body.find(".select-quiz").append('<option value="'+obj.cmid+'">'+obj.name+"</option>")}))},fail:Notification.exception}])})),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0;let value=modal.body.find(".select-quiz").val();null!==value?Ajax.call([{methodname:"community_sharequestion_save_questions_to_cron",args:{type:"copy_to_quiz",targetid:value,questionids:JSON.stringify(self.selected_questions)},done:function(response){JSON.parse(response).result&&(modal.destroy(),open_success_popup(strings[0],strings[3]))},fail:Notification.exception}]):modal.body.find(".select-quiz-error").show()})),modal.getRoot().on(ModalEvents.cancel,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal.show()}))},fail:Notification.exception}])}))}();break;case"copyQuestionsToCategory":self.flag_background_enable=!0,modal.destroy(),function(){let self=this;0!==this.selected_questions.length&&Str.get_strings([{key:"copyquestionstocategory",component:"community_sharequestion"},{key:"copy",component:"community_sharequestion"},{key:"back",component:"community_sharequestion"},{key:"copyquestionstoquizsuccess",component:"community_sharequestion"}]).done((function(strings){Ajax.call([{methodname:"community_sharequestion_copy_to_category_html",args:{currentcourseid:self.currentcourseid},done:function(response){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:response}).done((function(modal){modal.setSaveButtonText(strings[1]),modal.setButtonText("cancel",strings[2]),modal.getRoot().addClass("copy-question-to-cat-modal"),build_select2(modal,".select-course"),build_select2(modal,".select-category"),modal.body.find(".select-course").on("change",(function(e){modal.body.find(".select-category-error").hide();let courseid=this.value;Ajax.call([{methodname:"community_sharequestion_get_categories_by_course",args:{courseid:courseid},done:function(response){let data=JSON.parse(response);modal.body.find(".select-category").empty(),$.each(data.categories,(function(index,obj){modal.body.find(".select-category").append('<option value="'+obj.id+'">'+obj.name+"</option>")}))},fail:Notification.exception}])})),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0;let value=modal.body.find(".select-category").val();null!=value?Ajax.call([{methodname:"community_sharequestion_save_questions_to_cron",args:{type:"copy_to_category",targetid:value,questionids:JSON.stringify(self.selected_questions)},done:function(response){JSON.parse(response).result&&(modal.destroy(),open_success_popup(strings[0],strings[3]))},fail:Notification.exception}]):modal.body.find(".select-category-error").show()})),modal.getRoot().on(ModalEvents.cancel,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal.show()}))},fail:Notification.exception}])}))}();break;case"uploadQuestionsToMaagar":self.flag_background_enable=!0,modal.destroy(),function(){let self=this;if(0!==this.selected_questions.length){const getBody=function(){var params={courseid:self.currentcourseid,selected_questions:JSON.stringify(self.selected_questions)};return Fragment.loadFragment("community_sharequestion","upload_questions_maagar",self.currentcoursecontext,params)};Str.get_strings([{key:"share_national_shared",component:"community_sharequestion"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:getBody()});$.when(modalPromise).then((function(fmodal){fmodal.setLarge();var root=fmodal.getRoot();return root.on(ModalEvents.bodyRendered,(function(){root.find(".modal-body").animate({scrollTop:0},0),setTimeout((function(){root.find("input:not([type=hidden])").first().focus()}),300)})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)}))}}();break;case"copyQuestionsToTeacher":self.flag_background_enable=!0,modal.destroy(),function(){let self=this;0!==this.selected_questions.length&&Str.get_strings([{key:"copyquestionstoteacher",component:"community_sharequestion"},{key:"send",component:"community_sharequestion"},{key:"back",component:"community_sharequestion"},{key:"copyquestionstoquizsuccess",component:"community_sharequestion"}]).done((function(strings){Ajax.call([{methodname:"community_sharequestion_copy_to_teacher_html",args:{currentcourseid:self.currentcourseid,questionids:JSON.stringify(self.selected_questions)},done:function(response){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:response}).done((function(modal){modal.setSaveButtonText(strings[1]),modal.setButtonText("cancel",strings[2]),$(modal.body).closest(".modal-content").addClass("share-with-teacher-modal"),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0,modal.body.find(".error-teachers").hide();var message=modal.body.find('[data-handler="messageForTeacher"]').val(),teachersId=[];modal.body.find(".tag-wrapper [data-teacherid]").each((function(){teachersId.push($(this).attr("data-teacherid"))}));var errors=[];teachersId.length||errors.push("No users"),0===errors.length?Ajax.call([{methodname:"community_sharequestion_submit_teachers",args:{questionids:JSON.stringify(self.selected_questions),teachersid:JSON.stringify(teachersId),message:message},done:function(response){JSON.parse(response).result&&(modal.destroy(),open_success_popup(strings[0],strings[3]))},fail:Notification.exception}]):(self.flag_background_enable=!1,modal.body.find(".error-teachers").show())})),modal.getRoot().on(ModalEvents.cancel,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1,SendToTeacher.init(modal)})),modal.show()}))},fail:Notification.exception}])}))}()}})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal})).fail(Notification.exception)})).fail(Notification.exception)}))}function open_success_popup(title,html){let self=this;Str.get_strings([{key:"back",component:"community_sharequestion"},{key:"end",component:"community_sharequestion"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:html});$.when(modalPromise).then((function(modal){return modal.setSaveButtonText(strings[0]),modal.setButtonText("cancel",strings[1]),modal.show(),modal.getRoot().on(ModalEvents.save,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal})).fail(Notification.exception)}))}return{question_edit_init:function(currentcourseid,currentcoursecontext,visiblebuttons){$(".modulespecificbuttonscontainer").find("input").each((function(index){if(1===index){let self=this;Str.get_strings([{key:"sharingbutton",component:"community_sharequestion"}]).done((function(strings){let element='<input type=button class="btn-share-questions btn btn-secondary mr-1" value="'+strings[0]+'" data-action="toggle" data-togglegroup="qbank" data-toggle="action" disabled="1">';$(element).insertBefore($(self)),$(".btn-share-questions").on("click",(function(e){var checkedVals=$("#categoryquestions").find("input:checked").map((function(){return this.name})).get();let selected=[];$.each(checkedVals,(function(index,value){var sd=value.replace(/[^0-9]/gi,"");if(0!==sd.length){var number=parseInt(sd,10);selected.push(number)}})),open_selector(selected,currentcourseid,currentcoursecontext,visiblebuttons)}))}))}}))},mod_quiz_edit_init:function(currentcourseid,currentcoursecontext,visiblebuttons){function mod_quiz_edit_recalculate_page(){let pageid="";$(".section li").each((function(index){$(this).hasClass("pagenumber")&&(pageid=$(this).attr("id")),$(this).find("input").data("pageid",pageid)}))}function mod_quiz_edit_toogle_buttons(){let flag=!1;$(".select-multiple-checkbox-share").each((function(index){$(this).find("input").is(":checked")&&(flag=!0)})),flag?($(".btn-delete-questions").attr("disabled",!1),$(".btn-share-questions").attr("disabled",!1)):($(".btn-delete-questions").attr("disabled",!0),$(".btn-share-questions").attr("disabled",!0)),1===$(".btn-delete-questions").data("hasattempts")&&$(".btn-delete-questions").attr("disabled",!0)}mod_quiz_edit_toogle_buttons(),$(".btn-share-questions").on("click",(function(e){const checkboxes=document.querySelector("div.mod-quiz-edit-content").querySelectorAll("input.select-multiple-checkbox:checked"),selected_questions=[];checkboxes.forEach((checkbox=>{const questionContainer=checkbox.closest("li.activity");if(questionContainer){const activityInstance=questionContainer.querySelector("div.activityinstance");if(activityInstance){const link=activityInstance.querySelector('a[href*="id="]');if(link){const questionIdMatch=link.getAttribute("href").match(/[?&]id=(\d+)/);if(questionIdMatch){const questionRealId=questionIdMatch[1];selected_questions.push(questionRealId)}}}}})),open_selector(selected_questions,currentcourseid,currentcoursecontext,visiblebuttons)})),$(".checkbox-select-all-questions").on("click",(function(e){mod_quiz_edit_recalculate_page();let pageid=$(this).data("pageid");$(this).is(":checked")?$(".select-multiple-checkbox-share").each((function(index){$(this).find("input").data("pageid")===pageid&&$(this).find("input").prop("checked",!0)})):$(".select-multiple-checkbox-share").each((function(index){$(this).find("input").data("pageid")===pageid&&$(this).find("input").prop("checked",!1)})),mod_quiz_edit_toogle_buttons()})),$(".select-multiple-checkbox").on("click",(function(e){if(mod_quiz_edit_recalculate_page(),!$(this).is(":checked")){let pageid=$(this).data("pageid");$(".checkbox-select-all-questions").each((function(index){$(this).data("pageid")===pageid&&$(this).prop("checked",!1)}))}mod_quiz_edit_toogle_buttons()}))},message_edit_init:function(currentcourseid,currentcoursecontext){$("body").on("click",(function(e){if("copyQuestionsFromMessage"===$(e.target).data("handler")){open_selector($(e.target).data("questionids"),currentcourseid,currentcoursecontext,"message")}}))},community_oer_question:function(selected){open_selector(selected,0,0,"oer")}}}));

//# sourceMappingURL=main.min.js.map