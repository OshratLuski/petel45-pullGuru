{"version":3,"file":"sharewithteacher.min.js","sources":["../src/sharewithteacher.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"Actions\" panel at the bottom of the page.\n *\n * @module     community_sharewith/sharewithteacher\n * @package\n * @copyright  2018 Devlion <info@devlion.co>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.6\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'community_sharewith/modal',\n    'community_sharewith/storage'\n], function($, Ajax, Notification, modal, St) {\n\n    /** @alias module:community_sharewith/sharewithteacher */\n    return {\n\n        resultBlock: '',\n        tagWrapper: '',\n        input: '',\n        numOfSings: 3,\n\n        init: function() {\n\n            var root = modal.modalWrapper;\n            root.addEventListener('click', function(e) {\n                var target = e.target;\n                while (root.contains(target)) {\n                    switch (target.dataset.handler) {\n                        case 'addTag':\n                            this.addTag(target);\n                            break;\n                        case 'removeTag':\n                            this.removeTag(target);\n                            break;\n                        case 'sendLinkToTeachers':\n                            this.submitTeachers();\n                            break;\n                        case 'shareActivity':\n                            this.shareActivity();\n                            break;\n                    }\n                    target = target.parentNode;\n                }\n            }.bind(this));\n\n            root.addEventListener('input', function(e) {\n                var target = e.target;\n                while (root.contains(target)) {\n                    switch (target.dataset.handler) {\n                        case 'selectTeacher':\n                            this.autocompleteTeachers(target);\n                            break;\n                    }\n                    target = target.parentNode;\n                }\n            }.bind(this));\n\n        },\n        /**\n         * Choose a teacher for copying the activity.\n         *\n         * @method shareActivity\n         * @param {Node} target element.\n         */\n        shareActivity: function() {\n            var self = this;\n            var parseResponse = function(response) {\n                var context = JSON.parse(response);\n                modal.render(modal.template.shareteacher, context)\n                    .done(function() {\n                        self.resultBlock = document.querySelector('.result-block');\n                        self.tagWrapper = document.querySelector('.tag-wrapper');\n                        self.input = document.querySelector('input[data-handler = \"selectTeacher\"]');\n                    });\n            };\n\n            Ajax.call([{\n                methodname: 'community_sharewith_get_teachers',\n                args: {\n                    activityid: Number(St.cmid),\n                    courseid: Number(St.getCurrentCourse())\n                },\n                done: parseResponse,\n                fail: Notification.exception\n            }]);\n        },\n\n        keySelect: function(container) {\n\n            var currentItem = 0;\n            var tagWrapper = document.querySelector('.tag-wrapper');\n            var items = Array.from(container.children);\n            items.forEach(function(item) {\n                item.tabIndex = 0;\n            });\n\n            container.onmouseover = function(e) {\n                e.target.focus();\n                items.forEach(function(item, index) {\n                    item.onfocus = function() {\n                        currentItem = index;\n                    };\n                });\n            };\n\n            var setBlur = function() {\n                items[currentItem].blur();\n            };\n            var setFocus = function() {\n                items[currentItem].focus();\n            };\n\n            var goUp = function() {\n                if (currentItem <= 0) {\n                    return;\n                } else {\n                    setBlur();\n                    currentItem--;\n                    setFocus();\n                }\n            };\n            var goDown = function() {\n                if (currentItem >= items.length - 1) {\n                    return;\n                } else {\n                    setBlur();\n                    currentItem++;\n                    setFocus();\n                }\n            };\n            var selectItem = function() {\n                var event = new Event('click', {bubbles: true});\n                items[currentItem].dispatchEvent(event);\n\n            };\n            var hideAll = function() {\n                container.innerHTML = '';\n                container.classList.add('d-none');\n                currentItem = -1;\n                document.removeEventListener('click', closeBlockResult);\n                document.removeEventListener('keydown', keyCodeHandler);\n            };\n\n            var keyCodeHandler = function(e) {\n                switch (e.keyCode) {\n                    case 38: // Arrow up.\n                        goUp();\n                        break;\n                    case 40: // Arrow down.\n                        goDown();\n                        break;\n                    case 13: // Enter.\n                        selectItem();\n                        break;\n                    case 27: // Esc.\n                        hideAll();\n                        break;\n                }\n            };\n\n            var closeBlockResult = function(e) {\n                if (container.contains(e.target) || (e.path !== undefined && e.path.indexOf(tagWrapper) !== -1)) {\n                    return;\n                }\n                hideAll();\n            };\n\n            document.addEventListener('click', closeBlockResult);\n            document.addEventListener('keydown', keyCodeHandler);\n        },\n\n        showSearchResult: function(response) {\n            this.resultBlock.innerHTML = '';\n\n            var teachers = JSON.parse(response);\n\n            teachers.forEach(function(teacher) {\n                var unit = document.createElement('li');\n                unit.dataset.teacherid = teacher.teacher_id;\n                unit.dataset.teachername = teacher.teacher_name;\n                unit.dataset.handler = 'addTag';\n                unit.classList.add('btn', 'btn-secondary', 'd-flex', 'mb-1');\n                unit.innerHTML = '<div class = \"sw-img\" >' +\n                    '<img src = \"' + M.cfg.wwwroot + teacher.teacher_url + '\" alt = \"\">' +\n                    '</div><span class = \"pl-2\">' + teacher.teacher_name + '</span>';\n                if (this.tagWrapper.querySelector('.btn[data-id=\"' + teacher.teacher_id + '\"]')) {\n                    unit.classList.add('active');\n                }\n                this.resultBlock.classList.remove('d-none');\n                this.resultBlock.appendChild(unit);\n            }.bind(this));\n\n            this.keySelect(this.resultBlock);\n        },\n\n        autocompleteTeachers: function(target) {\n            var inputValue = target.value;\n\n            // Close result block.\n            this.resultBlock.classList.add('d-none');\n\n            // If (!this.resultBlock.childElementCount && !inputValue) {\n            //     this.resultBlock.classList.add('d-none');\n            // }\n\n            if (inputValue.length >= this.numOfSings) {\n                Ajax.call([{\n                    methodname: 'community_sharewith_autocomplete_teachers',\n                    args: {\n                        searchstring: inputValue\n                    },\n                    done: this.showSearchResult.bind(this),\n                    fail: Notification.exception\n                }]);\n            }\n        },\n\n        submitTeachers: function() {\n            var chosenBlocks = $(this.tagWrapper).find('.btn:not(.example)');\n            var teachersId = [];\n            var coursesId = [];\n\n            chosenBlocks.each(function() {\n                teachersId.push($(this).attr('data-teacherid'));\n            });\n\n            // Validate.\n            if (teachersId.length === 0) {\n                $('#error_share_to_teacher').show();\n                return;\n            }\n            modal.addBtnSpinner();\n            var message = $(\"#message_for_teacher\").val();\n            var parseResponse = function(response) {\n                var template = modal.template.error,\n                    context = {\n                        title: M.util.get_string('eventcopytoteacher', 'community_sharewith'),\n                        text: M.util.get_string('system_error_contact_administrator', 'community_sharewith'),\n                    };\n                if (response) {\n                    template = modal.template.confirm;\n                    context.text = M.util.get_string('succesfullyshared', 'community_sharewith');\n                }\n                modal.render(template, context);\n            };\n\n            Ajax.call([{\n                methodname: 'community_sharewith_submit_teachers',\n                args: {\n                    activityid: Number(St.cmid),\n                    courseid: Number(St.getCurrentCourse()),\n                    teachersid: JSON.stringify(teachersId),\n                    coursesid: JSON.stringify(coursesId),\n                    message: message,\n                    sequence: JSON.stringify(St.activityChain)\n                },\n                done: parseResponse,\n                fail: Notification.exception\n            }]);\n\n        },\n\n        addTag: function(target) {\n            var teacherid = target.dataset.teacherid,\n                tag = $(this.tagWrapper).find('[data-teacherid=' + teacherid + ']');\n\n            if (tag.length) {\n                this.removeTag(tag[0]);\n                return;\n            }\n\n            var teacherTag = $(this.tagWrapper).find('.example').clone();\n            teacherTag.attr('data-teacherid', teacherid);\n            teacherTag.append('<span>' + target.dataset.teachername + '</span>');\n            teacherTag.removeClass('example d-none');\n\n            target.classList.add('active');\n            $(this.tagWrapper).append(teacherTag);\n            this.input.value = '';\n\n            // Close result block.\n            this.resultBlock.classList.add('d-none');\n        },\n\n        removeTag: function(target) {\n            var teacherid = target.dataset.teacherid;\n            $(this.resultBlock).find('[data-teacherid=' + teacherid + ']')\n                .removeClass('active');\n            $(target).remove();\n        },\n    };\n});\n"],"names":["define","$","Ajax","Notification","modal","St","resultBlock","tagWrapper","input","numOfSings","init","root","modalWrapper","addEventListener","e","target","contains","dataset","handler","addTag","removeTag","submitTeachers","shareActivity","parentNode","bind","this","autocompleteTeachers","self","call","methodname","args","activityid","Number","cmid","courseid","getCurrentCourse","done","response","context","JSON","parse","render","template","shareteacher","document","querySelector","fail","exception","keySelect","container","currentItem","items","Array","from","children","forEach","item","tabIndex","onmouseover","focus","index","onfocus","setBlur","blur","setFocus","hideAll","innerHTML","classList","add","removeEventListener","closeBlockResult","keyCodeHandler","keyCode","length","event","Event","bubbles","dispatchEvent","undefined","path","indexOf","showSearchResult","teacher","unit","createElement","teacherid","teacher_id","teachername","teacher_name","M","cfg","wwwroot","teacher_url","remove","appendChild","inputValue","value","searchstring","chosenBlocks","find","teachersId","each","push","attr","addBtnSpinner","message","val","teachersid","stringify","coursesid","sequence","activityChain","error","title","util","get_string","text","confirm","show","tag","teacherTag","clone","append","removeClass"],"mappings":"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"}