/**
 * Javascript controller for the "Actions" panel at the bottom of the page.
 *
 * @module     community_sharewith/sharewithteacher
 * @package
 * @copyright  2018 Devlion <info@devlion.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since      3.6
 */
define("community_sharewith/sharewithteacher",["jquery","core/ajax","core/notification","community_sharewith/modal","community_sharewith/storage"],(function($,Ajax,Notification,modal,St){return{resultBlock:"",tagWrapper:"",input:"",numOfSings:3,init:function(){var root=modal.modalWrapper;root.addEventListener("click",function(e){for(var target=e.target;root.contains(target);){switch(target.dataset.handler){case"addTag":this.addTag(target);break;case"removeTag":this.removeTag(target);break;case"sendLinkToTeachers":this.submitTeachers();break;case"shareActivity":this.shareActivity()}target=target.parentNode}}.bind(this)),root.addEventListener("input",function(e){for(var target=e.target;root.contains(target);){if("selectTeacher"===target.dataset.handler)this.autocompleteTeachers(target);target=target.parentNode}}.bind(this))},shareActivity:function(){var self=this;Ajax.call([{methodname:"community_sharewith_get_teachers",args:{activityid:Number(St.cmid),courseid:Number(St.getCurrentCourse())},done:function(response){var context=JSON.parse(response);modal.render(modal.template.shareteacher,context).done((function(){self.resultBlock=document.querySelector(".result-block"),self.tagWrapper=document.querySelector(".tag-wrapper"),self.input=document.querySelector('input[data-handler = "selectTeacher"]')}))},fail:Notification.exception}])},keySelect:function(container){var currentItem=0,tagWrapper=document.querySelector(".tag-wrapper"),items=Array.from(container.children);items.forEach((function(item){item.tabIndex=0})),container.onmouseover=function(e){e.target.focus(),items.forEach((function(item,index){item.onfocus=function(){currentItem=index}}))};var setBlur=function(){items[currentItem].blur()},setFocus=function(){items[currentItem].focus()},hideAll=function(){container.innerHTML="",container.classList.add("d-none"),currentItem=-1,document.removeEventListener("click",closeBlockResult),document.removeEventListener("keydown",keyCodeHandler)},keyCodeHandler=function(e){switch(e.keyCode){case 38:currentItem<=0||(setBlur(),currentItem--,setFocus());break;case 40:currentItem>=items.length-1||(setBlur(),currentItem++,setFocus());break;case 13:event=new Event("click",{bubbles:!0}),items[currentItem].dispatchEvent(event);break;case 27:hideAll()}var event},closeBlockResult=function(e){container.contains(e.target)||void 0!==e.path&&-1!==e.path.indexOf(tagWrapper)||hideAll()};document.addEventListener("click",closeBlockResult),document.addEventListener("keydown",keyCodeHandler)},showSearchResult:function(response){this.resultBlock.innerHTML="",JSON.parse(response).forEach(function(teacher){var unit=document.createElement("li");unit.dataset.teacherid=teacher.teacher_id,unit.dataset.teachername=teacher.teacher_name,unit.dataset.handler="addTag",unit.classList.add("btn","btn-secondary","d-flex","mb-1"),unit.innerHTML='<div class = "sw-img" ><img src = "'+M.cfg.wwwroot+teacher.teacher_url+'" alt = ""></div><span class = "pl-2">'+teacher.teacher_name+"</span>",this.tagWrapper.querySelector('.btn[data-id="'+teacher.teacher_id+'"]')&&unit.classList.add("active"),this.resultBlock.classList.remove("d-none"),this.resultBlock.appendChild(unit)}.bind(this)),this.keySelect(this.resultBlock)},autocompleteTeachers:function(target){var inputValue=target.value;this.resultBlock.classList.add("d-none"),inputValue.length>=this.numOfSings&&Ajax.call([{methodname:"community_sharewith_autocomplete_teachers",args:{searchstring:inputValue},done:this.showSearchResult.bind(this),fail:Notification.exception}])},submitTeachers:function(){var chosenBlocks=$(this.tagWrapper).find(".btn:not(.example)"),teachersId=[];if(chosenBlocks.each((function(){teachersId.push($(this).attr("data-teacherid"))})),0!==teachersId.length){modal.addBtnSpinner();var message=$("#message_for_teacher").val();Ajax.call([{methodname:"community_sharewith_submit_teachers",args:{activityid:Number(St.cmid),courseid:Number(St.getCurrentCourse()),teachersid:JSON.stringify(teachersId),coursesid:JSON.stringify([]),message:message,sequence:JSON.stringify(St.activityChain)},done:function(response){var template=modal.template.error,context={title:M.util.get_string("eventcopytoteacher","community_sharewith"),text:M.util.get_string("system_error_contact_administrator","community_sharewith")};response&&(template=modal.template.confirm,context.text=M.util.get_string("succesfullyshared","community_sharewith")),modal.render(template,context)},fail:Notification.exception}])}else $("#error_share_to_teacher").show()},addTag:function(target){var teacherid=target.dataset.teacherid,tag=$(this.tagWrapper).find("[data-teacherid="+teacherid+"]");if(tag.length)this.removeTag(tag[0]);else{var teacherTag=$(this.tagWrapper).find(".example").clone();teacherTag.attr("data-teacherid",teacherid),teacherTag.append("<span>"+target.dataset.teachername+"</span>"),teacherTag.removeClass("example d-none"),target.classList.add("active"),$(this.tagWrapper).append(teacherTag),this.input.value="",this.resultBlock.classList.add("d-none")}},removeTag:function(target){var teacherid=target.dataset.teacherid;$(this.resultBlock).find("[data-teacherid="+teacherid+"]").removeClass("active"),$(target).remove()}}}));

//# sourceMappingURL=sharewithteacher.min.js.map