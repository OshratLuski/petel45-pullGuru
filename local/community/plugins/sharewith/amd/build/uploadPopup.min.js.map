{"version":3,"file":"uploadPopup.min.js","sources":["../src/uploadPopup.js"],"sourcesContent":["/* eslint-disable require-jsdoc */\r\ndefine([\r\n    'jquery',\r\n    'core/ajax',\r\n    'core/str',\r\n    'core/templates',\r\n    'core/notification',\r\n    'community_sharewith/modal',\r\n    'community_sharewith/storage',\r\n    'core/modal_factory',\r\n    'core/fragment',\r\n    'jqueryui',\r\n\r\n], function($, Ajax, str, Templates, Notification, modal, St, ModalFactory, Fragment) {\r\n\r\n    return /** @alias module:community_sharewith/sendToCatalog */ {\r\n\r\n        init: function(uniqueid) {\r\n            var form = $('#sharing_activities_form_' + uniqueid),\r\n                self = this;\r\n\r\n            form.on('keydown', 'input[type=\"text\"]', function(e) {\r\n                if (e.keyCode === 13) {\r\n                    e.preventDefault();\r\n                }\r\n            });\r\n\r\n            form.delegate('[data-descr=\"addtag\"]', 'keydown', function(e) {\r\n                if (e.keyCode === 13 && $(this).val()) {\r\n                    var tag = $('<div class = \"tags-item\">' + $(this).val() +\r\n                        '<input type = \"hidden\" name = \"tags[]\" value = \"' + $(this).val() + '\"></div>');\r\n                    tag.css(\"background-color\", self.getRandColor());\r\n                    tag.appendTo($(this).parent());\r\n                    tag.on('click', function() {\r\n                        $(this).remove();\r\n                    });\r\n                    $(this).val('');\r\n                }\r\n            });\r\n\r\n            form.find('.uploadactivitysubmit').click(function(event) {\r\n                self.uploadActivity(event, form);\r\n            });\r\n\r\n            form.find('.uploadactivityclose').click(function(event) {\r\n\r\n                // Close modal factory popup.\r\n                self.closeModalFactory(form);\r\n            });\r\n\r\n        },\r\n\r\n        uploadActivity: function(e, form) {\r\n            let self = this;\r\n\r\n            e.preventDefault();\r\n\r\n            // Remove errors.\r\n            form.find('.invalid-feedback').hide();\r\n\r\n            self.addBtnSpinner(form);\r\n\r\n            var serializedForm = form.serializeArray(),\r\n                data = {};\r\n\r\n            serializedForm.forEach(function(item) {\r\n                data[item.name] = data[item.name] ? data[item.name] + ',' + item.value : item.value;\r\n            });\r\n\r\n            // Serialized selected sections.\r\n            let selectedsections = [];\r\n            form.find('.selected-section-block').each(function() {\r\n                if (!$(this).hasClass('hidden')) {\r\n                    selectedsections.push({\r\n                        'cat_id': $(this).data(\"cat_id\"),\r\n                        'course_id': $(this).data(\"course_id\"),\r\n                        'section_id': $(this).data(\"section_id\"),\r\n                    });\r\n                }\r\n            });\r\n\r\n            data.selected_sections = selectedsections;\r\n\r\n            // Serialized selected competencies.\r\n            let selectedcompetencies = [];\r\n            form.find('.selected-competency-block').each(function() {\r\n                if (!$(this).hasClass('hidden')) {\r\n                    selectedcompetencies.push({\r\n                        'competency_id': $(this).data(\"comp_id\"),\r\n                        'section_id': $(this).data(\"section_id\"),\r\n                    });\r\n                }\r\n            });\r\n\r\n            data.selected_competencies = selectedcompetencies;\r\n\r\n            var parseResponse = function(response) {\r\n                if (response.result) {\r\n\r\n                    if (!response.validation) {\r\n                        let firstNameError = '';\r\n                        let errors = JSON.parse(response.errors);\r\n                        $.each(errors, function(index, value) {\r\n                            if (index === 0) {\r\n                                firstNameError = value;\r\n                            }\r\n                            form.find('.error-' + value).show();\r\n                        });\r\n                        // Scroll to first error.\r\n                        var parentModal = form.closest('.modal-body');\r\n                        var uploadActivityOffset = +parentModal.find('.uploadactivity').offset().top * (-1);\r\n                        var targetOffset = parentModal.find('.error-' + firstNameError).closest('.form-group').offset().top * (-1);\r\n                        var result = uploadActivityOffset - targetOffset;\r\n                        parentModal.closest('.modal-body').animate({scrollTop: result}, 500);\r\n\r\n                        self.removeBtnSpinner(form);\r\n                        return;\r\n                    } else {\r\n\r\n                        // Close modal factory popup.\r\n                        self.closeModalFactory(form);\r\n\r\n                        let title = M.util.get_string('eventactivityupload', 'community_sharewith');\r\n                        str.get_string('activity_upload_to_mr', 'community_sharewith', data).done(function(string) {\r\n                            Templates.render('community_sharewith/elements/information-popup', {\r\n                                string: string,\r\n                                rootLink: M.cfg.wwwroot\r\n                            })\r\n                                .done(function(html, js) {\r\n                                    self.informationPopup(title, html);\r\n                                })\r\n                                .fail(Notification.exception);\r\n                        });\r\n                    }\r\n                } else {\r\n\r\n                    // Close modal factory popup.\r\n                    self.closeModalFactory(form);\r\n\r\n                    let title = M.util.get_string('error', 'community_sharewith');\r\n                    let text = M.util.get_string('system_error_contact_administrator', 'community_sharewith');\r\n                    self.informationPopup(title, text);\r\n                }\r\n            };\r\n\r\n            // Chain.\r\n            data.chain = St.activityChain;\r\n\r\n            Ajax.call([{\r\n                methodname: 'community_sharewith_submit_upload_activity',\r\n                args: {\r\n                    data: JSON.stringify(data)\r\n                },\r\n                done: parseResponse,\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        getRandColor: function() {\r\n            var color = Math.floor(Math.random() * Math.pow(256, 3)).toString(16);\r\n            while (color.length < 6) {\r\n                color = \"0\" + color;\r\n            }\r\n            return \"#\" + color;\r\n        },\r\n\r\n        informationPopup: function(title, html) {\r\n            var modalPromise = ModalFactory.create({\r\n                type: ModalFactory.types.ALERT,\r\n                title: title,\r\n                body: html\r\n            });\r\n\r\n            $.when(modalPromise).then(function(fmodal) {\r\n                fmodal.show();\r\n                return fmodal;\r\n            }).fail(Notification.exception);\r\n        },\r\n\r\n        closeModalFactory: function(form) {\r\n            form.parent().parent().parent().find('.btn-close').click();\r\n        },\r\n\r\n        /**\r\n         * Show spinner.\r\n         *\r\n         * @param form\r\n         * @method addSpinner\r\n         */\r\n        addBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('d-none');\r\n            form.find('.modalspinner').addClass('loading');\r\n            form.find('.modalspinner').parent().prop('disabled', true);\r\n        },\r\n\r\n        /**\r\n         * Remove spinner.\r\n         *\r\n         * @param form\r\n         * @method addSpinner\r\n         */\r\n        removeBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('loading');\r\n            form.find('.modalspinner').addClass('d-none');\r\n            form.find('.modalspinner').parent().prop('disabled', false);\r\n        },\r\n    };\r\n});\r\n"],"names":["define","$","Ajax","str","Templates","Notification","modal","St","ModalFactory","Fragment","init","uniqueid","form","self","this","on","e","keyCode","preventDefault","delegate","val","tag","css","getRandColor","appendTo","parent","remove","find","click","event","uploadActivity","closeModalFactory","hide","addBtnSpinner","serializedForm","serializeArray","data","forEach","item","name","value","selectedsections","each","hasClass","push","cat_id","course_id","section_id","selected_sections","selectedcompetencies","competency_id","selected_competencies","chain","activityChain","call","methodname","args","JSON","stringify","done","response","result","validation","firstNameError","errors","parse","index","show","parentModal","closest","offset","top","animate","scrollTop","removeBtnSpinner","title","M","util","get_string","string","render","rootLink","cfg","wwwroot","html","js","informationPopup","fail","exception","text","color","Math","floor","random","pow","toString","length","modalPromise","create","type","types","ALERT","body","when","then","fmodal","removeClass","addClass","prop"],"mappings":"AACAA,yCAAO,CACH,SACA,YACA,WACA,iBACA,oBACA,4BACA,8BACA,qBACA,gBACA,aAED,SAASC,EAAGC,KAAMC,IAAKC,UAAWC,aAAcC,MAAOC,GAAIC,aAAcC,UAExE,MAA8D,CAE1DC,KAAM,SAASC,UACX,IAAIC,KAAOX,EAAE,4BAA8BU,UACvCE,KAAOC,KAEXF,KAAKG,GAAG,UAAW,sBAAsB,SAASC,GAC5B,KAAdA,EAAEC,SACFD,EAAEE,gBAEV,IAEAN,KAAKO,SAAS,wBAAyB,WAAW,SAASH,GACvD,GAAkB,KAAdA,EAAEC,SAAkBhB,EAAEa,MAAMM,MAAO,CACnC,IAAIC,IAAMpB,EAAE,4BAA8BA,EAAEa,MAAMM,MAC9C,mDAAqDnB,EAAEa,MAAMM,MAAQ,YACzEC,IAAIC,IAAI,mBAAoBT,KAAKU,gBACjCF,IAAIG,SAASvB,EAAEa,MAAMW,UACrBJ,IAAIN,GAAG,SAAS,WACZd,EAAEa,MAAMY,QACZ,IACAzB,EAAEa,MAAMM,IAAI,GAChB,CACJ,IAEAR,KAAKe,KAAK,yBAAyBC,OAAM,SAASC,OAC9ChB,KAAKiB,eAAeD,MAAOjB,KAC/B,IAEAA,KAAKe,KAAK,wBAAwBC,OAAM,SAASC,OAG7ChB,KAAKkB,kBAAkBnB,KAC3B,GAEH,EAEDkB,eAAgB,SAASd,EAAGJ,MACxB,IAAIC,KAAOC,KAEXE,EAAEE,iBAGFN,KAAKe,KAAK,qBAAqBK,OAE/BnB,KAAKoB,cAAcrB,MAEnB,IAAIsB,eAAiBtB,KAAKuB,iBACtBC,KAAO,CAAA,EAEXF,eAAeG,SAAQ,SAASC,MAC5BF,KAAKE,KAAKC,MAAQH,KAAKE,KAAKC,MAAQH,KAAKE,KAAKC,MAAQ,IAAMD,KAAKE,MAAQF,KAAKE,KAClF,IAGA,IAAIC,iBAAmB,GACvB7B,KAAKe,KAAK,2BAA2Be,MAAK,WACjCzC,EAAEa,MAAM6B,SAAS,WAClBF,iBAAiBG,KAAK,CAClBC,OAAU5C,EAAEa,MAAMsB,KAAK,UACvBU,UAAa7C,EAAEa,MAAMsB,KAAK,aAC1BW,WAAc9C,EAAEa,MAAMsB,KAAK,eAGvC,IAEAA,KAAKY,kBAAoBP,iBAGzB,IAAIQ,qBAAuB,GAC3BrC,KAAKe,KAAK,8BAA8Be,MAAK,WACpCzC,EAAEa,MAAM6B,SAAS,WAClBM,qBAAqBL,KAAK,CACtBM,cAAiBjD,EAAEa,MAAMsB,KAAK,WAC9BW,WAAc9C,EAAEa,MAAMsB,KAAK,eAGvC,IAEAA,KAAKe,sBAAwBF,qBAoD7Bb,KAAKgB,MAAQ7C,GAAG8C,cAEhBnD,KAAKoD,KAAK,CAAC,CACPC,WAAY,6CACZC,KAAM,CACFpB,KAAMqB,KAAKC,UAAUtB,OAEzBuB,KAzDgB,SAASC,UACzB,GAAIA,SAASC,OAAQ,CAEjB,IAAKD,SAASE,WAAY,CACtB,IAAIC,eAAiB,GACjBC,OAASP,KAAKQ,MAAML,SAASI,QACjC/D,EAAEyC,KAAKsB,QAAQ,SAASE,MAAO1B,OACb,IAAV0B,QACAH,eAAiBvB,OAErB5B,KAAKe,KAAK,UAAYa,OAAO2B,MACjC,IAEA,IAAIC,YAAcxD,KAAKyD,QAAQ,eAG3BR,QAF6E,GAArDO,YAAYzC,KAAK,mBAAmB2C,SAASC,MAC+B,EAArFH,YAAYzC,KAAK,UAAYoC,gBAAgBM,QAAQ,eAAeC,SAASC,IAKhG,OAHAH,YAAYC,QAAQ,eAAeG,QAAQ,CAACC,UAAWZ,QAAS,UAEhEhD,KAAK6D,iBAAiB9D,KAE1B,CAAO,CAGHC,KAAKkB,kBAAkBnB,MAEvB,IAAI+D,MAAQC,EAAEC,KAAKC,WAAW,sBAAuB,uBACrD3E,IAAI2E,WAAW,wBAAyB,sBAAuB1C,MAAMuB,MAAK,SAASoB,QAC/E3E,UAAU4E,OAAO,iDAAkD,CAC/DD,OAAQA,OACRE,SAAUL,EAAEM,IAAIC,UAEfxB,MAAK,SAASyB,KAAMC,IACjBxE,KAAKyE,iBAAiBX,MAAOS,KAChC,IACAG,KAAKlF,aAAamF,UAC3B,GACJ,CACJ,KAAO,CAGH3E,KAAKkB,kBAAkBnB,MAEvB,IAAI+D,MAAQC,EAAEC,KAAKC,WAAW,QAAS,uBACnCW,KAAOb,EAAEC,KAAKC,WAAW,qCAAsC,uBACnEjE,KAAKyE,iBAAiBX,MAAOc,KACjC,GAYAF,KAAMlF,aAAamF,YAE1B,EAEDjE,aAAc,WAEV,IADA,IAAImE,MAAQC,KAAKC,MAAMD,KAAKE,SAAWF,KAAKG,IAAI,IAAK,IAAIC,SAAS,IAC3DL,MAAMM,OAAS,GAClBN,MAAQ,IAAMA,MAElB,MAAO,IAAMA,KAChB,EAEDJ,iBAAkB,SAASX,MAAOS,MAC9B,IAAIa,aAAezF,aAAa0F,OAAO,CACnCC,KAAM3F,aAAa4F,MAAMC,MACzB1B,MAAOA,MACP2B,KAAMlB,OAGVnF,EAAEsG,KAAKN,cAAcO,MAAK,SAASC,QAE/B,OADAA,OAAOtC,OACAsC,MACV,IAAElB,KAAKlF,aAAamF,UACxB,EAEDzD,kBAAmB,SAASnB,MACxBA,KAAKa,SAASA,SAASA,SAASE,KAAK,cAAcC,OACtD,EAQDK,cAAe,SAASrB,MACpBA,KAAKe,KAAK,iBAAiB+E,YAAY,UACvC9F,KAAKe,KAAK,iBAAiBgF,SAAS,WACpC/F,KAAKe,KAAK,iBAAiBF,SAASmF,KAAK,YAAY,EACxD,EAQDlC,iBAAkB,SAAS9D,MACvBA,KAAKe,KAAK,iBAAiB+E,YAAY,WACvC9F,KAAKe,KAAK,iBAAiBgF,SAAS,UACpC/F,KAAKe,KAAK,iBAAiBF,SAASmF,KAAK,YAAY,EACzD,EAER"}