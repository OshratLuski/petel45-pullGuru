/**
 * Javascript controller for the "Actions" panel at the bottom of the page.
 *
 * @module     community_sharewith/copyactivity
 * @package
 * @copyright  2018 Devlion <info@devlion.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since      3.6
 */
define("community_sharewith/copyactivity",["jquery","core/ajax","core/notification","community_sharewith/modal","community_sharewith/storage"],(function($,Ajax,Notification,modal,St){return{cmid:null,firstCmid:null,sectionid:null,activityChain:[],flagCopyFromMessage:0,messageId:0,init:function(){var root=document.querySelector("body");root.addEventListener("click",function(e){for(var target=e.target;root.contains(target);){switch(target.dataset.handler){case"selectCourseForSection":St.hassubsections=$(target).closest("li.section").hasClass("hassubsections")||$(target).closest("li.tile").hasClass("hassubsections"),St.hassubsections?this.subOrNot(target):this.selectCourseForSection(target);break;case"copyLinkSection":let courseid=$(target).data("courseid"),sectionid=$(target).data("sectionid");const url=M.cfg.wwwroot+"/course/view.php?id="+courseid+"&sectionid="+sectionid;let temp=$("<input>");$("body").append(temp),temp.val(url).select(),document.execCommand("copy"),temp.remove();let title=M.util.get_string("copylinksectionsuccess","community_sharewith");alert(title);break;case"selectCourseForSectionSub":this.selectCourseForSectionSub(target);break;case"copySectionToCourse":this.copySectionToCourse();break;case"openDialog":this.openDialog(target);break;case"saveChain":this.saveChain(target);break;case"selectCourse":this.flagCopyFromMessage=0,this.messageId=0,this.selectCourse(target);break;case"selectCourseForNotification":this.flagCopyFromMessage=1,this.messageId=target.dataset.message_id,this.selectCourseForNotification(target);break;case"selectSection":this.selectSection();break;case"copyActivityToCourse":this.copyActivityToCourse()}target=target.parentNode}}.bind(this))},selectCourseForSection:function(target){St.initState(),St.sectionid=$(target).data("sectionid");St.sectionid||Ajax.call([{methodname:"community_sharewith_get_sectionid",args:{courseid:Number(St.getCurrentCourse()),firstcmid:$(target).data("firstcmid")},done:function(response){St.sectionid=response.sectionid?response.sectionid:null},fail:Notification.exception}]),Ajax.call([{methodname:"community_sharewith_get_courses",args:{},done:function(response){var context={copySection:!0,courses:JSON.parse(response.courses),hidebtn:!0,copysub:St.copysub},template=modal.template.copyinstance;response.result||(context.text=M.util.get_string("no_matching_courses_found","community_sharewith"),context.isAmit=!0,template=modal.template.empty),modal.render(template,context).done(modal.triggerBtn.click())},fail:Notification.exception}])},selectCourseForSectionSub:function(target){St.initState(),St.sectionid=$(target).data("sectionid"),St.copysub=$(target).data("copysub");St.sectionid||Ajax.call([{methodname:"community_sharewith_get_sectionid",args:{courseid:Number(St.getCurrentCourse()),firstcmid:$(target).data("firstcmid")},done:function(response){St.sectionid=response.sectionid?response.sectionid:null},fail:Notification.exception}]),Ajax.call([{methodname:"community_sharewith_get_courses",args:{},done:function(response){var context={copySection:!0,courses:JSON.parse(response.courses),hidebtn:!0,copysub:St.copysub},template=modal.template.copyinstance;response.result||(context.text=M.util.get_string("no_matching_courses_found","community_sharewith"),context.isAmit=!0,template=modal.template.empty),modal.render(template,context)},fail:Notification.exception}])},subOrNot:function(target){var context={title:M.util.get_string("settingssectionscopy","community_sharewith"),text:M.util.get_string("copy_all_sub","community_sharewith"),sectionid:$(target).data("sectionid")},template=modal.template.subornot;modal.render(template,context).done(modal.triggerBtn.click())},copySectionToCourse:function(){var courseid=$(modal.modalContent).find(":selected").data("courseid");modal.addBtnSpinner();Ajax.call([{methodname:"community_sharewith_add_sharewith_task",args:{courseid:Number(courseid),sourcecourseid:Number(St.getCurrentCourse()),sourcesectionid:Number(St.sectionid),type:"sectioncopy",copysub:!0},done:function(response){var template=modal.template.error,context={title:M.util.get_string("eventsectioncopy","community_sharewith"),text:M.util.get_string("system_error_contact_administrator","community_sharewith"),hidebtnback:!0};response.result&&(template=modal.template.confirm,context.text=M.util.get_string("section_copied_to_course","community_sharewith")),modal.render(template,context).done((()=>{$("#modalSharewith .modal-body span").addClass("px-3 text-center mx-auto")}))},fail:Notification.exception}])},openDialog:function(target){St.initState(),St.cmlink=$(target).data("cmlink"),St.cmid=$(target).data("cmid"),St.amit=!!$(target).data("amit"),St.sequence=!!$(target).data("sequence"),St.haveviewlink=!0;var methodname="community_sharewith_check_cm_status",data={cmid:St.cmid},context={amit:St.amit},template=modal.template.selector;St.amit&&(methodname="community_sharewith_get_amit_teacher",data={cmid:St.cmid,courseid:St.getCurrentCourse()});Ajax.call([{methodname:methodname,args:data,done:function(data){"chain"===data.cmstatus?(context=JSON.parse(data.data),template=modal.template.chain):data.isamit?context.amit=JSON.parse(data.amit):"wrongquizcategory"===data.cmstatus&&(template=modal.template.error,context.text=data.data,context.title=M.util.get_string("eventactivitycopy","community_sharewith")),""===data.cmstatus&&(context.haveviewlink=data.haveviewlink,St.haveviewlink=data.haveviewlink),modal.render(template,context).done(modal.triggerBtn.click())},fail:Notification.exception}])},saveChain:function(target){$.each($("input[name='cmid[]']:checked"),(function(){St.activityChain.push(Number($(this).val()))})),St.sequence?this.selectCourse(target):modal.render(modal.template.selector,{})},selectCourse:function(target){var self=this;Ajax.call([{methodname:"community_sharewith_get_courses",args:{},done:function(response){var context={courses:JSON.parse(response.courses),copyActivity:!0};if(!context.courses.length)return context.text=M.util.get_string("no_matching_courses_found","community_sharewith"),void modal.render(modal.template.empty,context);target.dataset.activitysharing?(St.cmid=target.dataset.activitysharing,context.hidebtn=!0,modal.render(modal.template.copyinstance,context).done(modal.triggerBtn.click()).done(self.selectSection)):modal.render(modal.template.copyinstance,context).done(self.selectSection)},fail:Notification.exception}])},selectCourseForNotification:function(target){var self=this;Ajax.call([{methodname:"community_sharewith_get_courses",args:{},done:function(response){var context={courses:JSON.parse(response.courses),copyActivity:!0};target.dataset.activitysharing?(St.cmid=target.dataset.activitysharing,context.hidebtn=!0,modal.render(modal.template.copyinstance,context).done(modal.triggerBtn.click()).done(self.selectSection)):modal.render(modal.template.copyinstance,context).done(self.selectSection)},fail:Notification.exception}])},selectSection:function(){var modalContent=$(modal.modalContent),courseid=modalContent.find(":selected").attr("data-courseid");courseid||(courseid=St.getCurrentCourse());Ajax.call([{methodname:"community_sharewith_get_sections",args:{courseid:Number(courseid)},done:function(response){var sections=JSON.parse(response.sections);modalContent.find(".sections").html(""),sections.forEach((function(section){modalContent.find(".sections").append($("<option data-sectionid ="+section.section_id+">"+section.section_name+"</option>"))}))},fail:Notification.exception}])},copyActivityToCourse:function(){let self=this;var modalContent=$(modal.modalContent),courseid=modalContent.find(".courses option:selected").attr("data-courseid"),sectionid=modalContent.find(".sections option:selected").attr("data-sectionid");modal.addBtnSpinner();Ajax.call([{methodname:"community_sharewith_add_sharewith_task",args:{courseid:Number(courseid),sourcecourseid:Number(St.getCurrentCourse()),sectionid:Number(sectionid),sourceactivityid:Number(St.cmid),type:"activitycopy",chain:JSON.stringify(St.activityChain),messageid:self.messageId},done:function(response){var context={title:M.util.get_string("eventdublicatetoteacher","community_sharewith")},template=modal.template.error;switch(response.result){case 0:context.text=M.util.get_string("system_error_contact_administrator","community_sharewith");break;case 1:context.text=M.util.get_string("error_coursecopy","community_sharewith");break;case 2:context.text=M.util.get_string("error_sectioncopy","community_sharewith");break;case 3:context.text=M.util.get_string("error_activitycopy","community_sharewith");break;case 4:context.text=M.util.get_string("error_permission_allow_copy","community_sharewith");break;case 10:if(1===self.flagCopyFromMessage){context.text=M.util.get_string("activity_copied_to_course","community_sharewith");let a={link:M.cfg.wwwroot+"/user/profile.php?id="+response.userid,userfirstname:response.userfirstname,userlastname:response.userlastname};context.text2=M.util.get_string("activity_copied_to_course_from_message","community_sharewith",a),context.userid=response.userid,context.modname=response.modname,context.coursename=response.coursename,template=modal.template.confirm2}else context.text=M.util.get_string("activity_copied_to_course","community_sharewith"),template=modal.template.confirm}modal.render(template,context)},fail:Notification.exception}])}}}));

//# sourceMappingURL=copyactivity.min.js.map