{"version":3,"file":"uploadPopupPage2.min.js","sources":["../src/uploadPopupPage2.js"],"sourcesContent":["/* eslint-disable require-jsdoc */\r\ndefine([\r\n    'community_sharesequence/main',\r\n    'jquery',\r\n    'core/ajax',\r\n    'core/str',\r\n    'core/templates',\r\n    'core/notification',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/fragment',\r\n    'jqueryui',\r\n\r\n], function(Main, $, Ajax, Str, Templates, Notification, ModalFactory, ModalEvents, Fragment) {\r\n\r\n    return {\r\n\r\n        init: function(uniqueid) {\r\n            var form = $('#sharing_sequence_form_' + uniqueid),\r\n                self = this;\r\n\r\n            // Submit form.\r\n            form.find('.uploadsequencesubmit').click(function(event) {\r\n                self.uploadSequence(event, form, uniqueid);\r\n            });\r\n\r\n            // Close modal factory popup.\r\n            form.find('.uploadsequenceclose').click(function() {\r\n                self.closeModalFactory(form);\r\n            });\r\n\r\n            // Back to page 1.\r\n            form.find('.backtoform1').click(function() {\r\n\r\n                var serializedForm = form.serializeArray(),\r\n                    data = {};\r\n\r\n                serializedForm.forEach(function(item) {\r\n                    data[item.name] = data[item.name] ? data[item.name] + ',' + item.value : item.value;\r\n                });\r\n\r\n                self.closeModalFactory(form);\r\n                Main.init_page_1(data);\r\n            });\r\n\r\n        },\r\n\r\n        uploadSequence: function(e, form, uniqueid) {\r\n\r\n            // Functions.\r\n            var checkAvailability = function(activities, data) {\r\n\r\n                Ajax.call([{\r\n                    methodname: 'community_sharesequence_check_availability',\r\n                    args: {\r\n                        activities: JSON.stringify(activities)\r\n                    },\r\n                    done: function(result) {\r\n                        result = JSON.parse(result.result);\r\n\r\n                        if (result.status === true) {\r\n                            self.removeBtnSpinner(form);\r\n\r\n                            Str.get_strings([\r\n                                {key: 'popupcheckavailabilitytitle', component: 'community_sharesequence'},\r\n                                {key: 'popupcheckavailabilitycontent', component: 'community_sharesequence'},\r\n                                {key: 'popupcheckavailabilitybuttonsave', component: 'community_sharesequence'},\r\n                            ]).done(function(strings) {\r\n\r\n                                let body = strings[1];\r\n                                $.each(result.activities, function(index, value) {\r\n                                    body += '<br>' + value;\r\n                                });\r\n\r\n                                var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\r\n                                $.when(modalPromise).then(function(modal) {\r\n                                    modal.setTitle(strings[0]);\r\n                                    modal.setBody(body);\r\n                                    modal.setSaveButtonText(strings[2]);\r\n                                    modal.getRoot().on(ModalEvents.save, function() {\r\n                                        self.addBtnSpinner(form);\r\n                                        createSequence(activities, data);\r\n                                    });\r\n                                    modal.show();\r\n                                    return modal;\r\n                                }).fail(Notification.exception);\r\n                            });\r\n                        } else {\r\n                            createSequence(activities, data);\r\n                        }\r\n                    }.bind(this),\r\n                    fail: Notification.exception\r\n                }]);\r\n            }\r\n\r\n            var parseResponse = function(response) {\r\n                if (response.result) {\r\n                    Str.get_strings([\r\n                        {key: 'popupmessagesuccesstitle', component: 'community_sharesequence'},\r\n                        {key: 'popupmessagesuccesscontent', component: 'community_sharesequence'},\r\n                    ]).done(function(strings) {\r\n                        // Close modal factory popup.\r\n                        self.closeModalFactory(form);\r\n\r\n                        let title = strings[0];\r\n                        let text = strings[1];\r\n                        self.informationPopup(title, text);\r\n                    })\r\n                } else {\r\n                    // Close modal factory popup.\r\n                    self.closeModalFactory(form);\r\n\r\n                    let title = M.util.get_string('error', 'community_sharesequence');\r\n                    let text = M.util.get_string('system_error_contact_administrator', 'community_sharesequence');\r\n                    self.informationPopup(title, text);\r\n                }\r\n            };\r\n\r\n            var createSequence = function(activities, data) {\r\n                Ajax.call([{\r\n                    methodname: 'community_sharesequence_submit_sequence_page_2',\r\n                    args: {\r\n                        activities: JSON.stringify(activities),\r\n                        data: JSON.stringify(data)\r\n                    },\r\n                    done: parseResponse,\r\n                    fail: Notification.exception\r\n                }]);\r\n            }\r\n\r\n            let self = this;\r\n            e.preventDefault();\r\n\r\n            // Remove errors.\r\n            form.find('.sequence-item-list-alert').hide();\r\n            self.addBtnSpinner(form);\r\n\r\n            let activities = this.getDataFormSequences(uniqueid);\r\n            var serializedForm = form.serializeArray();\r\n\r\n            let t = {};\r\n            serializedForm.forEach(function(item) {\r\n                t[item.name] = t[item.name] ? t[item.name] + ',' + item.value : item.value;\r\n            });\r\n\r\n            let data = t.default_data;\r\n\r\n            if (activities.length !== 0) {\r\n                checkAvailability(activities, data);\r\n            } else {\r\n                form.find('.sequence-item-list-alert').show();\r\n                self.removeBtnSpinner(form);\r\n            }\r\n        },\r\n\r\n        informationPopup: function(title, html) {\r\n            var modalPromise = ModalFactory.create({\r\n                type: ModalFactory.types.ALERT,\r\n                title: title,\r\n                body: html\r\n            });\r\n\r\n            $.when(modalPromise).then(function(fmodal) {\r\n                fmodal.show();\r\n                return fmodal;\r\n            }).fail(Notification.exception);\r\n        },\r\n\r\n        closeModalFactory: function(form) {\r\n            form.parent().parent().parent().find('.btn-close').click();\r\n        },\r\n\r\n        /**\r\n         * Show spinner.\r\n         *\r\n         * @method addSpinner\r\n         */\r\n        addBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('d-none');\r\n            form.find('.modalspinner').addClass('loading');\r\n            form.find('.modalspinner').parent().prop('disabled', true);\r\n        },\r\n\r\n        /**\r\n         * Remove spinner.\r\n         *\r\n         * @method addSpinner\r\n         */\r\n        removeBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('loading');\r\n            form.find('.modalspinner').addClass('d-none');\r\n            form.find('.modalspinner').parent().prop('disabled', false);\r\n        },\r\n        getDataFormSequences: function(uniqueid) {\r\n\r\n            let data = [];\r\n            let sequences = $('#sequence-item-list-' + uniqueid).find('li.sequence-item');\r\n\r\n            sequences.each((index, el) => {\r\n                let elData = {};\r\n                let cmid = $(el).find('input').data('cmid').split('-')[0];\r\n                elData.name = $(el).find('input').val();\r\n                elData.cmid = cmid;\r\n                elData.index = $(el).find('input').data('index');\r\n                data.push(elData);\r\n            });\r\n\r\n            return data;\r\n        },\r\n    };\r\n});\r\n"],"names":["define","Main","$","Ajax","Str","Templates","Notification","ModalFactory","ModalEvents","Fragment","init","uniqueid","form","self","this","find","click","event","uploadSequence","closeModalFactory","serializedForm","serializeArray","data","forEach","item","name","value","init_page_1","e","parseResponse","response","result","get_strings","key","component","done","strings","title","text","informationPopup","M","util","get_string","createSequence","activities","call","methodname","args","JSON","stringify","fail","exception","preventDefault","hide","addBtnSpinner","getDataFormSequences","t","default_data","length","parse","status","removeBtnSpinner","body","each","index","modalPromise","create","type","types","SAVE_CANCEL","when","then","modal","setTitle","setBody","setSaveButtonText","getRoot","on","save","show","bind","checkAvailability","html","ALERT","fmodal","parent","removeClass","addClass","prop","el","elData","cmid","split","val","push"],"mappings":"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"}