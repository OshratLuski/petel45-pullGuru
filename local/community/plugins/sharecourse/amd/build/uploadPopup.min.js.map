{"version":3,"file":"uploadPopup.min.js","sources":["../src/uploadPopup.js"],"sourcesContent":["define([\r\n    'jquery',\r\n    'core/ajax',\r\n    'core/str',\r\n    'core/templates',\r\n    'core/notification',\r\n    'core/modal_factory',\r\n    'core/fragment',\r\n    'jqueryui',\r\n\r\n], function ($, Ajax, str, Templates, Notification, ModalFactory, Fragment) {\r\n\r\n    return{\r\n\r\n        init: function(uniqueid) {\r\n            var form = $('#sharing_courses_form_' + uniqueid),\r\n                self = this;\r\n\r\n            form.on('keydown', 'input[type=\"text\"]', function(e) {\r\n                if (e.keyCode === 13) {\r\n                    e.preventDefault();\r\n                }\r\n            });\r\n\r\n            form.delegate('[data-descr=\"addtag\"]', 'keydown', function(e) {\r\n                if (e.keyCode === 13 && $(this).val()) {\r\n                    var tag = $('<div class = \"tags-item\">' + $(this).val() +\r\n                        '<input type = \"hidden\" name = \"tags[]\" value = \"' + $(this).val() + '\"></div>');\r\n                    tag.css(\"background-color\", self.getRandColor());\r\n                    tag.appendTo($(this).parent());\r\n                    tag.on('click', function() {\r\n                        $(this).remove();\r\n                    });\r\n                    $(this).val('');\r\n                }\r\n            });\r\n\r\n            form.find('.uploadcoursesubmit').click(function(event) {\r\n                self.uploadCourse(event, form);\r\n            });\r\n\r\n            form.find('.uploadcourseclose').click(function() {\r\n\r\n                // Close modal factory popup.\r\n                self.closeModalFactory(form);\r\n            });\r\n\r\n        },\r\n\r\n        uploadCourse: function(e, form) {\r\n            let self = this;\r\n\r\n            e.preventDefault();\r\n\r\n            // Remove errors.\r\n            form.find('.invalid-feedback').hide();\r\n\r\n            self.addBtnSpinner(form);\r\n\r\n            var serializedForm = form.serializeArray(),\r\n                data = {};\r\n\r\n            serializedForm.forEach(function(item) {\r\n                data[item.name] = data[item.name] ? data[item.name] + ',' + item.value : item.value;\r\n            });\r\n\r\n            // Serialized selected courses.\r\n            let selectedcourses = [];\r\n            form.find('.treeview span').each(function() {\r\n\r\n                let courseid = $(this).data('courseid');\r\n                let checked = $(this).attr('check-value');\r\n\r\n                if (courseid !== undefined && checked === '1') {\r\n                    selectedcourses.push({\r\n                        'course_id': courseid,\r\n                    });\r\n                }\r\n            });\r\n\r\n            data['selected_courses'] = selectedcourses;\r\n\r\n            var parseResponse = function(response) {\r\n                if (response.result) {\r\n\r\n                    if (!response.validation) {\r\n                        let firstNameError = '';\r\n                        let errors = JSON.parse(response.errors);\r\n                        $.each(errors, function(index, value) {\r\n                            if (index === 0) {\r\n                                firstNameError = value;\r\n                            }\r\n                            form.find('.error-' + value).show();\r\n                        });\r\n                        // Scroll to first error.\r\n                        var parentModal = form.closest('.modal-body');\r\n                        var uploadActivityOffset = +parentModal.find('.uploadcourse').offset().top * (-1);\r\n                        var targetOffset = parentModal.find('.error-' + firstNameError).closest('.form-group').offset().top * (-1);\r\n                        var result = uploadActivityOffset - targetOffset;\r\n                        parentModal.closest('.modal-body').animate({scrollTop: result}, 500);\r\n\r\n                        self.removeBtnSpinner(form);\r\n                        return;\r\n                    } else {\r\n\r\n                        // Close modal factory popup.\r\n                        self.closeModalFactory(form);\r\n\r\n                        if (data.typeshare === '1') {\r\n                            str.get_string('eventcourseupload', 'community_sharecourse').done(function(title) {\r\n                                str.get_string('course_upload_to_mr', 'community_sharecourse', data).done(function(string) {\r\n                                    Templates.render('community_sharecourse/elements/information-popup',\r\n                                        {string: string, rootLink: M.cfg.wwwroot})\r\n                                        .done(function(html, js) {\r\n                                            self.informationPopup(title, html);\r\n                                        })\r\n                                        .fail(Notification.exception);\r\n                                });\r\n                            });\r\n                        } else {\r\n                            // Redirect.\r\n                            window.location.replace(M.cfg.wwwroot + '/course/view.php?id=' + data.courseid);\r\n                        }\r\n                    }\r\n                } else {\r\n\r\n                    // Close modal factory popup.\r\n                    self.closeModalFactory(form);\r\n\r\n                    let title = M.util.get_string('error', 'community_sharequestion');\r\n                    let text = M.util.get_string('system_error_contact_administrator', 'community_sharequestion');\r\n                    self.informationPopup(title, text);\r\n                }\r\n            };\r\n\r\n            Ajax.call([{\r\n                methodname: 'community_sharecourse_submit_upload_course',\r\n                args: {\r\n                    data: JSON.stringify(data)\r\n                },\r\n                done: parseResponse,\r\n                fail: Notification.exception\r\n            }]);\r\n        },\r\n\r\n        getRandColor: function() {\r\n            var color = Math.floor(Math.random() * Math.pow(256, 3)).toString(16);\r\n            while (color.length < 6) {\r\n                color = \"0\" + color;\r\n            }\r\n            return \"#\" + color;\r\n        },\r\n\r\n        informationPopup: function(title, html) {\r\n            var modalPromise = ModalFactory.create({\r\n                type: ModalFactory.types.ALERT,\r\n                title: title,\r\n                body: html\r\n            });\r\n\r\n            $.when(modalPromise).then(function(fmodal) {\r\n                fmodal.show();\r\n                return fmodal;\r\n            }).fail(Notification.exception);\r\n        },\r\n\r\n        closeModalFactory: function(form) {\r\n            form.parent().parent().parent().find('.btn-close').click();\r\n        },\r\n\r\n        /**\r\n         * Show spinner.\r\n         *\r\n         * @method addSpinner\r\n         */\r\n        addBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('d-none');\r\n            form.find('.modalspinner').addClass('loading');\r\n            form.find('.modalspinner').parent().prop('disabled', true);\r\n        },\r\n\r\n        /**\r\n         * Remove spinner.\r\n         *\r\n         * @method addSpinner\r\n         */\r\n        removeBtnSpinner: function(form) {\r\n            form.find('.modalspinner').removeClass('loading');\r\n            form.find('.modalspinner').addClass('d-none');\r\n            form.find('.modalspinner').parent().prop('disabled', false);\r\n        },\r\n    };\r\n});\r\n"],"names":["define","$","Ajax","str","Templates","Notification","ModalFactory","Fragment","init","uniqueid","form","self","this","on","e","keyCode","preventDefault","delegate","val","tag","css","getRandColor","appendTo","parent","remove","find","click","event","uploadCourse","closeModalFactory","hide","addBtnSpinner","serializedForm","serializeArray","data","forEach","item","name","value","selectedcourses","each","courseid","checked","attr","undefined","push","course_id","call","methodname","args","JSON","stringify","done","response","result","validation","firstNameError","errors","parse","index","show","parentModal","closest","offset","top","animate","scrollTop","removeBtnSpinner","typeshare","get_string","title","string","render","rootLink","M","cfg","wwwroot","html","js","informationPopup","fail","exception","window","location","replace","util","text","color","Math","floor","random","pow","toString","length","modalPromise","create","type","types","ALERT","body","when","then","fmodal","removeClass","addClass","prop"],"mappings":"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"}