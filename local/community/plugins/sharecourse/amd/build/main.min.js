define("community_sharecourse/main",["jquery","core/yui","core/str","core/modal_factory","core/modal_events","core/ajax","core/templates","core/notification","core/fragment","community_sharequestion/sendtoteacher","community_sharecourse/select2"],(function($,Y,Str,ModalFactory,ModalEvents,Ajax,Templates,Notification,Fragment,SendToTeacher){M.cfg.sesskey;function open_selector(){let currentcourseid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,currentcoursecontext=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,type=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,self=this;if(null!=currentcourseid&&(this.currentcourseid=currentcourseid),null!=currentcoursecontext&&(this.currentcoursecontext=currentcoursecontext),void 0===self.context_template)if("admin-all"===type)self.large=!0,self.context_template={courseupload:!0,copycoursetoteacher:!0,sharecoursecommunity:!0,copycoursetocategory:!0,sharecoursepombim:!0};else self.large=!1,self.context_template={courseupload:!1,copycoursetoteacher:!0,sharecoursecommunity:!0,copycoursetocategory:!0,sharecoursepombim:!0};Str.get_strings([{key:"menupopuptitle",component:"community_sharecourse"},{key:"cancel",component:"community_sharecourse"}]).done((function(strings){Templates.render("community_sharecourse/selector",self.context_template).done((function(html){var modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,large:self.large,title:strings[0],body:html});$.when(modalPromise).then((function(modal){return modal.setButtonText("cancel",strings[1]),modal.getRoot()[0].classList.add("sharemodal"),modal.getRoot()[0].classList.add("sharecoursemodal"),modal.getRoot().find(".modal-dialog").addClass("modal-dialog-centered"),modal.show(),modal.body.find("button").on("click",(function(e){switch(e.stopPropagation(),e.currentTarget.dataset.handler){case"uploadCourseToCatalog":self.flag_background_enable=!0,modal.destroy(),open_fragment(!1);break;case"copyCourseToMyCategory":self.flag_background_enable=!0,modal.destroy(),$(".modal-backdrop.in").removeClass("show"),$(".modal-backdrop.in").addClass("hide"),open_course_copy(self.currentcourseid);break;case"copyCourseToTeacher":self.flag_background_enable=!0,modal.destroy(),$(".modal-backdrop.in").removeClass("show"),$(".modal-backdrop.in").addClass("hide"),function(){let self=this;0!==this.currentcourseid.length&&Str.get_strings([{key:"copycoursetoteacher",component:"community_sharecourse"},{key:"send",component:"community_sharecourse"},{key:"back",component:"community_sharecourse"},{key:"copycoursesuccess",component:"community_sharecourse"}]).done((function(strings){Ajax.call([{methodname:"community_sharequestion_copy_to_teacher_html",args:{currentcourseid:self.currentcourseid,questionids:JSON.stringify([])},done:function(response){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:response}).done((function(modal){modal.setSaveButtonText(strings[1]),modal.setButtonText("cancel",strings[2]),$(modal.body).closest(".modal-content").addClass("share-with-teacher-modal"),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0,modal.body.find(".error-teachers").hide();var message=modal.body.find('[data-handler="messageForTeacher"]').val(),teachersId=[];modal.body.find(".tag-wrapper [data-teacherid]").each((function(){teachersId.push($(this).attr("data-teacherid"))}));var errors=[];teachersId.length||errors.push("No users"),0===errors.length?Ajax.call([{methodname:"community_sharecourse_submit_teachers",args:{courseid:self.currentcourseid,teachersid:JSON.stringify(teachersId),message:message},done:function(response){JSON.parse(response).result&&(modal.destroy(),open_success_popup(strings[0],strings[3]))},fail:Notification.exception}]):(self.flag_background_enable=!1,modal.body.find(".error-teachers").show())})),modal.getRoot().on(ModalEvents.cancel,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1,SendToTeacher.init(modal)})),modal.show()}))},fail:Notification.exception}])}))}();break;case"shareCourseCommunity":self.flag_background_enable=!0,modal.destroy(),$(".modal-backdrop.in").removeClass("show"),$(".modal-backdrop.in").addClass("hide"),function(){let self=this;0!==this.currentcourseid.length&&Str.get_strings([{key:"sharecommunityteachers",component:"community_sharecourse"},{key:"share",component:"community_sharecourse"},{key:"back",component:"community_sharecourse"},{key:"copycoursesuccess",component:"community_sharecourse"}]).done((function(strings){Ajax.call([{methodname:"community_sharewith_get_community",args:{activityid:1,courseid:self.currentcourseid},done:function(response){let data=JSON.parse(response);Templates.render("community_sharecourse/sharecommunity",data).done((function(html,js){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:html}).done((function(modal){modal.setSaveButtonText(strings[1]),modal.setButtonText("cancel",strings[2]),$(modal.body).closest(".modal-content").addClass("share-with-teacher-modal"),0===data.courses_enable&&$(modal.footer).find('[data-action="save"]').hide(),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0,modal.body.find("#error_share_to_community").hide();var message=modal.body.find("#message_for_teacher").val();let errors=[];0===modal.body.find("#community_courses").val().length&&(errors.push("No course"),modal.body.find("#error_share_to_community").show()),0===errors.length?Ajax.call([{methodname:"community_sharecourse_submit_teachers",args:{courseid:self.currentcourseid,teachersid:JSON.stringify([]),message:message},done:function(response){JSON.parse(response).result&&(modal.destroy(),open_success_popup(strings[0],strings[3]))},fail:Notification.exception}]):(self.flag_background_enable=!1,modal.body.find(".error-teachers").show())})),modal.getRoot().on(ModalEvents.cancel,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1;var dropdownParent=modal.body.find(".smartselect2").closest(".select-wrapper");modal.body.find(".smartselect2").select2({dropdownAutoWidth:!0,dropdownParent:dropdownParent})})),modal.show()}))}))},fail:Notification.exception}])}))}();break;case"shareCoursePombim":self.flag_background_enable=!0,modal.destroy(),$(".modal-backdrop.in").removeClass("show"),$(".modal-backdrop.in").addClass("hide"),function(){let self=this;0!==this.currentcourseid.length&&Str.get_strings([{key:"titlesharecoursepombim",component:"community_sharecourse"},{key:"approval",component:"community_sharecourse"}]).done((function(strings){let data={};Templates.render("community_sharecourse/sharesocial",data).done((function(html,js){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:html}).done((function(modal){modal.setSaveButtonText(strings[1]),$(modal.body).closest(".modal-content").addClass("share-with-teacher-modal"),modal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),self.flag_background_enable=!0;let ifcopy=!1,form=modal.getRoot().find("#popup_share_courses_pombim");$(form).find("input:checked").each(((count,obj)=>{"ifcopy"===$(obj).attr("name")&&(ifcopy=!0)})),Ajax.call([{methodname:"community_social_share_corse_pombim",args:{courseid:self.currentcourseid,ifcopy:ifcopy},done:function(response){modal.destroy()},fail:Notification.exception}])})),modal.getRoot().on(ModalEvents.hidden,(function(e){modal.destroy()})),modal.show()}))}))}))}()}})),modal.getRoot().on(ModalEvents.hidden,(function(e){1==self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal})).fail(Notification.exception)})).fail(Notification.exception)}))}function open_fragment(typeshare){let self=this;Str.get_strings([{key:"share_course_catalog_title",component:"community_sharecourse"}]).done((function(strings){var params,modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:(params={courseid:self.currentcourseid,typeshare:typeshare},Fragment.loadFragment("community_sharecourse","upload_course_to_catalog",self.currentcoursecontext,params))});$.when(modalPromise).then((function(fmodal){fmodal.setLarge();var root=fmodal.getRoot();return root.on(ModalEvents.bodyRendered,(function(){root.find(".modal-body").animate({scrollTop:0},0),setTimeout((function(){root.find("input:not([type=hidden])").first().focus()}),300)})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)}))}function open_success_popup(title,html){let self=this;Str.get_strings([{key:"back",component:"community_sharecourse"},{key:"end",component:"community_sharecourse"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:html});$.when(modalPromise).then((function(modal){return modal.setSaveButtonText(strings[0]),modal.setButtonText("cancel",strings[1]),modal.show(),modal.getRoot().on(ModalEvents.save,(function(e){self.flag_background_enable=!0,open_selector()})),modal.getRoot().on(ModalEvents.hidden,(function(e){!0===self.flag_background_enable?($(".modal-backdrop").removeClass("hide"),$(".modal-backdrop").addClass("show")):($(".modal-backdrop").removeClass("show"),$(".modal-backdrop").addClass("hide"))})),modal.getRoot().on(ModalEvents.shown,(function(e){self.flag_background_enable=!1})),modal})).fail(Notification.exception)}))}function open_course_copy(currentcourseid){var renderPopupCopyCourse=function(response,typeshare){var context={showAllCategories:response.isadmin,categories:JSON.parse(response.categories),teachercatid:JSON.parse(response.teachercatid)};Templates.render("community_sharecourse/copy_to_category",context).done((function(html,js){Str.get_strings([{key:"selectioncategories",component:"community_sharecourse"}]).done((function(strings){ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:html}).done((function(modal){modal.getRoot().find(".modal-dialog").addClass("copy-course-to-my-category-modal"),modal.setLarge(),modal.getRoot().on(ModalEvents.shown,(function(e){var dropdownParent=modal.body.find(".smartselect2").closest(".select-wrapper");modal.body.find(".smartselect2").select2({dropdownAutoWidth:!0,dropdownParent:dropdownParent})})),modal.getRoot().find("button.close-button").on("click",(function(e){modal.destroy()})),modal.getRoot().find("button.success-button").on("click",(function(e){let categoryid=modal.getRoot().find(":selected").attr("data-categoryid"),type="";type=typeshare?"coursecopy_share":"coursecopy",Ajax.call([{methodname:"community_sharecourse_add_sharecourse_task",args:{sourcecourseid:Number(currentcourseid),categoryid:Number(categoryid),type:type},done:function(response){modal.destroy(),Str.get_strings([{key:"eventcoursecopy",component:"community_sharecourse"},{key:"course_copied_to_category",component:"community_sharecourse"},{key:"finish",component:"community_sharecourse"}]).done((function(strings){ModalFactory.create({type:ModalFactory.types.ALERT,title:strings[0],body:strings[1]}).done((function(modal){modal.setButtonText("cancel",strings[2]),modal.show()}))}))},fail:Notification.exception}])})),modal.show()}))}))})).fail(Notification.exception)};Ajax.call([{methodname:"community_sharecourse_popup_copy_course",args:{courseid:Number(currentcourseid)},done:function(response){return!0===response.typeshare?Str.get_strings([{key:"coursereuploadtocatalog",component:"community_sharecourse"},{key:"couse_copied_from_catalog",component:"community_sharecourse"},{key:"disablepopupsubmit",component:"community_sharecourse"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:strings[1]});$.when(modalPromise).then((function(fmodal){return fmodal.setSaveButtonText(strings[2]),fmodal.getRoot().on(ModalEvents.save,(function(e){open_fragment(!0)})),fmodal.getRoot().on(ModalEvents.cancel,(function(e){renderPopupCopyCourse(response,!1)})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)})):renderPopupCopyCourse(response,!1),!0},fail:Notification.exception}])}return{init:function(currentcourseid,currentcoursecontext,visiblebuttons){$(".btn-share-course").on("click",(function(e){open_selector(currentcourseid,currentcoursecontext,visiblebuttons)})),$(".btn-disable-share-course").on("click",(function(e){Str.get_strings([{key:"disablepopuptitle",component:"community_sharecourse"},{key:"disablepopupbody",component:"community_sharecourse"},{key:"disablepopupsubmit",component:"community_sharecourse"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:strings[1]});$.when(modalPromise).then((function(modal){return modal.setSaveButtonText(strings[2]),modal.show(),modal.getRoot().on(ModalEvents.save,(function(e){Ajax.call([{methodname:"community_sharecourse_unshare_course",args:{courseid:currentcourseid},done:function(response){window.location.replace(M.cfg.wwwroot+"/course/view.php?id="+currentcourseid)},fail:Notification.exception}])})),modal})).fail(Notification.exception)}))}))},message_edit_init:function(currentcourseid,currentcoursecontext){$("body").on("click",(function(e){if("copyCourseFromMessage"===$(e.target).data("handler")){open_course_copy($(e.target).data("courseid"))}}))},download_from_catalog:function(courseid){open_course_copy(courseid)}}}));

//# sourceMappingURL=main.min.js.map