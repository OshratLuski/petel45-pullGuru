/**
 * Javascript main event handler.
 *
 * @module     local_quizpreset/preset
 * @package
 * @copyright  2019 Devlionco <info@devlion.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since      3.6
 */
define("local_quizpreset/preset",["jquery","core/templates","core/ajax","core/str","core/notification","core/modal_factory","core/modal_events","core/fragment","local_quizpreset/userexposure","local_quizpreset/loading"],(function($,Templates,Ajax,Str,Notification,ModalFactory,ModalEvents,Fragment,Userexposure,loadingIcon){var cmid="",pageState="",Selector_TYPE_SELECTOR_ANCOR1="#region-main .mform .collapsible-actions",Selector_TYPE_SELECTOR_ANCOR2="#region-main .quizinfo",Selector_BUTTON_EXPAND=".collapsible-actions",Selector_BUTTON_VIEWALL_ANCOR="#fgroup_id_buttonar",Selector_BUTTON_SUBMIT="#fgroup_id_buttonar #id_submitbutton",Selector_BUTTON_SUBMIT2="#fgroup_id_buttonar #id_submitbutton2",Selector_BUTTON_NEWSUBMIT="#fgroup_id_buttonar #new_id_submitbutton",Selector_BUTTON_NEWSUBMIT2="#fgroup_id_buttonar #new_id_submitbutton2",Selector_QUIZ_CMID='input[name="cmid"]',Selector_QUIZ_CMID2="#local-quizpreset-cmid",Selector_QUIZ_CMID3='input[name="coursemodule"]',Class_NEW_PREFIX="new_";$(Selector_QUIZ_CMID).length?cmid=$(Selector_QUIZ_CMID).val():$(Selector_QUIZ_CMID2).length?cmid=$(Selector_QUIZ_CMID2).val():$(Selector_QUIZ_CMID3).length&&(cmid=$(Selector_QUIZ_CMID3).val());var preconfigurePage=function(response){$(Selector_BUTTON_EXPAND).hide(),$(".quiz-bottom-bar").remove(),Templates.render("local_quizpreset/view_all_button",response).done((function(html){$(Selector_BUTTON_VIEWALL_ANCOR).before(html)}));var newSubmit=$(Selector_BUTTON_SUBMIT).clone().insertAfter(Selector_BUTTON_SUBMIT);newSubmit.attr("id",Class_NEW_PREFIX+newSubmit.attr("id")),newSubmit.attr("name",Class_NEW_PREFIX+newSubmit.attr("name")),newSubmit.attr("type","button"),$(Selector_BUTTON_SUBMIT).hide();var saveData=function(callback){var defaulttype_for_save=$("#defaulttype_for_save").val(),viewall_for_save=$("#viewall_for_save").val();Ajax.call([{methodname:"local_quizpreset_savedata",args:{cmid:Number(cmid),pagestate:pageState,type:Number(defaulttype_for_save),viewall:Number(viewall_for_save)},done:function(){callback&&callback()},fail:Notification.exception}])},submitQuiz1=function(){$(Selector_BUTTON_SUBMIT).click()},submitQuiz2=function(){$(Selector_BUTTON_SUBMIT2).click()},newSubmit2=$(Selector_BUTTON_SUBMIT2).clone().insertAfter(Selector_BUTTON_SUBMIT2);newSubmit2.attr("id",Class_NEW_PREFIX+newSubmit2.attr("id")),newSubmit2.attr("name",Class_NEW_PREFIX+newSubmit2.attr("name")),newSubmit2.attr("type","button"),$(Selector_BUTTON_SUBMIT2).hide(),$(document).on("click",Selector_BUTTON_NEWSUBMIT,(function(){saveData(submitQuiz1)})),$(document).on("click",Selector_BUTTON_NEWSUBMIT2,(function(){saveData(submitQuiz2)}))},expandedFieldset=function(response){"view"!==response.details.pagestate&&($.each(response.expanded,(function(key,value){value||$("#"+key).hide()})),"chemistry"===response.details.instancename&&$("#id_teacherremarks").parents(".form-group").hide(),response.details.viewdescription||($("#id_introeditor").parents(".form-group").hide(),$("#id_showdescription").parents(".form-group").hide()))},fillByType=function(name,val){var type=$("#id_"+name).prop("type");"text"!==type&&"select-one"!==type||$("#id_"+name).val(val),"checkbox"===type&&(1===val||!0===val?$("#id_"+name).prop("checked",!0):$("#id_"+name).prop("checked",!1))},fillValues=function(response){$("form").submit((function(e){$("div").find("[data-groupname='duringoptionsgrp']").find("input").each((function(index){$(this).is(":disabled")&&$(this).is(":checked")&&$(this).prop("disabled",!1)})),$("div").find("[data-groupname='immediatelyoptionsgrp']").find("input").each((function(index){$(this).is(":disabled")&&$(this).is(":checked")&&$(this).prop("disabled",!1)})),$("div").find("[data-groupname='openoptionsgrp']").find("input").each((function(index){$(this).is(":disabled")&&$(this).is(":checked")&&$(this).prop("disabled",!1)})),$("div").find("[data-groupname='closedoptionsgrp']").find("input").each((function(index){$(this).is(":disabled")&&$(this).is(":checked")&&$(this).prop("disabled",!1)}))})),"view"!==response.details.pagestate&&(!0!==response.details.ifchangestate&&"new"!==response.details.pagestate||$.each(response.values,(function(key,value){"area_checkboxes"!==key?fillByType(key,value):$.each(response.values.area_checkboxes,(function(key2,value2){fillByType(key2,value2)}))})))},fillGlobal=function(response){"view"!==response.details.pagestate&&"update"!==response.details.pagestate&&(fillByType("name",response.global.name),$("#id_teacherremarkseditable").html(response.global.intro))},addTypeSelector=function(){loadingIcon.show();var urlparams={};window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(str,key,value){urlparams[key]=value}));var url=new URL(window.location.href),defaulttype=url.searchParams.get("defaulttype"),viewall=url.searchParams.get("viewall");null===viewall&&(viewall=100),Ajax.call([{methodname:"local_quizpreset_get_pagedata",args:{cmid:Number(cmid),defaulttype:Number(defaulttype),viewall:Number(viewall),pagestate:pageState,urlparams:JSON.stringify(urlparams)},done:function(res){var response=JSON.parse(res);response.selector.items.length>0&&(response.selector.items_enable=!0),Templates.render("local_quizpreset/selector",response).done((function(html,js){let block='<div id="block-quizpreset-selector"></div>';$(Selector_TYPE_SELECTOR_ANCOR1).length?$(Selector_TYPE_SELECTOR_ANCOR1).before(block):$(Selector_TYPE_SELECTOR_ANCOR2).length&&$(Selector_TYPE_SELECTOR_ANCOR2).before(block),Templates.replaceNodeContents("#block-quizpreset-selector",html,js),fillGlobal(response),fillValues(response),preconfigurePage(response),expandedFieldset(response),Userexposure.init(),1===response.details.viewall&&$(".collapsible-actions").show(),$((function(){$('[data-toggle="tooltip"]').tooltip({delay:{show:700,hide:500}})})),loadingIcon.remove()}))},fail:Notification.exception}])},addEventSavePreset=function(){setTimeout((function(){$("#save-my-preset").click((function(){const getBody=function(presetid,cmcontextid){let params={presetid:presetid};return Fragment.loadFragment("local_quizpreset","popup_preset",cmcontextid,params)};let data=function(){let preset=["timeopen","timelimit","overduehandling","graceperiod","gradecat","gradepass","attempts","grademethod","questionsperpage","navmethod","shuffleanswers","preferredbehaviour","canredoquestions","attemptonlast","showuserpicture","decimalpoints","questiondecimalpoints","showblocks","quizpassword","subnet","delay1","delay2","browsersecurity","allowofflineattempts","boundary_repeats","visibleoncoursepage","cmidnumber","groupmode","groupingid","availabilityconditionsjson","completionusegrade","completionexpected"],checkboxes=["attemptduring","correctnessduring","marksduring","specificfeedbackduring","generalfeedbackduring","rightanswerduring","overallfeedbackduring","attemptimmediately","correctnessimmediately","marksimmediately","specificfeedbackimmediately","generalfeedbackimmediately","rightanswerimmediately","overallfeedbackimmediately","attemptopen","correctnessopen","marksopen","specificfeedbackopen","generalfeedbackopen","rightansweropen","overallfeedbackopen","attemptclosed","correctnessclosed","marksclosed","specificfeedbackclosed","generalfeedbackclosed","rightanswerclosed","overallfeedbackclosed"],data=[];for(const x in preset){let value,name=preset[x],obj=$("#id_"+name);value="checkbox"===obj.attr("type")?obj.is(":checked")?1:"":obj.val(),void 0===value&&(value=0),data[name]=value}let data_checkboxes=[];for(const x in checkboxes){let value,name=checkboxes[x],obj=$("#id_"+name);value="checkbox"===obj.attr("type")?obj.is(":checked")?1:"":obj.val(),void 0===value&&(value=0),data_checkboxes[name]=value}return data.area_checkboxes=Object.assign({},data_checkboxes),Object.assign({},data)}(),presetid=$("#presetId").val(),cmcontextid=$("#cmcontextid").val();Str.get_strings([{key:"titlepopuppreset",component:"local_quizpreset"},{key:"save",component:"local_quizpreset"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:getBody(presetid,cmcontextid)});$.when(modalPromise).then((function(fmodal){return fmodal.setSaveButtonText(strings[1]),fmodal.getRoot().on(ModalEvents.save,(function(e){let presetname=fmodal.getRoot().find("#popup_preset_name").val(),teacherdescription=fmodal.getRoot().find("#popup_teacher_description").val(),studentdescription=fmodal.getRoot().find("#popup_student_description").val();Ajax.call([{methodname:"local_quizpreset_savepreset",args:{presetid:Number(presetid),presetname:presetname,teacherdescription:teacherdescription,studentdescription:studentdescription,data:JSON.stringify(data)},done:function(res){fmodal.destroy(),$(".quizpreset-selector-block").remove(),addTypeSelector()},fail:Notification.exception}])})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)}))}))}),1e3)};return{configureAddQuizPage:function(){pageState="new",addTypeSelector()},configureUpdateQuizPage:function(){pageState="update",addTypeSelector()},configureViewQuizPage:function(){pageState="view",function(){loadingIcon.show();var urlparams={};window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(str,key,value){urlparams[key]=value}));var url=new URL(window.location.href),defaulttype=url.searchParams.get("defaulttype"),viewall=url.searchParams.get("viewall");null===viewall&&(viewall=100),Ajax.call([{methodname:"local_quizpreset_get_pagedata",args:{cmid:Number(cmid),defaulttype:Number(defaulttype),viewall:Number(viewall),pagestate:pageState,urlparams:JSON.stringify(urlparams)},done:function(res){var response=JSON.parse(res);response.selector.items.length>0&&(response.selector.items_enable=!1),Templates.render("local_quizpreset/selector",response).done((function(html,js){let block='<div id="block-quizpreset-selector"></div>';$(Selector_TYPE_SELECTOR_ANCOR1).length?$(Selector_TYPE_SELECTOR_ANCOR1).before(block):$(Selector_TYPE_SELECTOR_ANCOR2).length&&$(Selector_TYPE_SELECTOR_ANCOR2).before(block),Templates.replaceNodeContents("#block-quizpreset-selector",html,js),fillGlobal(response),fillValues(response),preconfigurePage(response),expandedFieldset(response),Userexposure.init(),1===response.details.viewall&&$(".collapsible-actions").show(),$((function(){$('[data-toggle="tooltip"]').tooltip({delay:{show:700,hide:500}})})),loadingIcon.remove()}))},fail:Notification.exception}])}()},configureSaveMyPreset:function(){addEventSavePreset()}}}));

//# sourceMappingURL=preset.min.js.map