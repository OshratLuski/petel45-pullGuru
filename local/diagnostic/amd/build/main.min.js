define("local_diagnostic/main",["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/ajax","core/yui","core/notification","local_diagnostic/buuble-animation","local_diagnostic/ufo-filter","local_diagnostic/document-read","local_diagnostic/daterangepicker","local_diagnostic/bootstrap-multiselect"],(function($,Str,ModalFactory,ModalEvents,Templates,Ajax,Y,Notification,BuubleAnimation,ufoFilter){var Diagnostic=function(selector,courseid,adParams){this.courseid=courseid,this.adParams=adParams,this.init(selector)};return Diagnostic.prototype.modal=null,Diagnostic.prototype.courseid=0,Diagnostic.prototype.stage="",Diagnostic.prototype.stage1="",Diagnostic.prototype.stage2="",Diagnostic.prototype.formdata={},Diagnostic.prototype.daterangePlaceholder=!0,Diagnostic.prototype.init=function(selector){var triggers=$(selector);return Str.get_strings([{key:"pluginname",component:"local_diagnostic"},{key:"cancel",component:"local_diagnostic"},{key:"submit",component:"local_diagnostic"}]).then(function(translateArr){return ModalFactory.create({title:translateArr[0],footer:`\n                    <button id="main_cancel" data-dismiss="modal" type="button" class="btn btn-primary m-1">${translateArr[1]}</button><button type="button" id="main_submit" class="btn btn-success btn-save m-1">${translateArr[2]}</button>\n                    `},triggers)}.bind(this)).then(function(modal){return this.modal=modal,modal.root.addClass("popup-local-diagnostic-main-modal"),modal.modal.addClass("popup-local-diagnostic popup-local-diagnostic-main-p"),this.modal.getRoot().on("cancel.daterangepicker",".daterange",{diagnostic:this},(function(e){let dateNow=e.data.diagnostic.dateFormat(new Date);Str.get_string("daterange","local_diagnostic").then((string=>{$(".diagnostic input.daterange").val(string)})),Diagnostic.prototype.daterangePlaceholder=!0;var formData={courseid:e.data.diagnostic.courseid,daterange:`${dateNow} - ${dateNow}`};e.data.diagnostic.getQuizzes(formData)})),this.modal.getRoot().on("apply.daterangepicker",".daterange",{diagnostic:this},(function(e){let startDate=e.data.diagnostic.dateFormat($(this).data("daterangepicker").startDate._d),endDate=e.data.diagnostic.dateFormat($(this).data("daterangepicker").endDate._d);var formData={courseid:e.data.diagnostic.courseid,daterange:`${startDate} - ${endDate}`};Diagnostic.prototype.daterangePlaceholder=!1,e.data.diagnostic.getQuizzes(formData)})),this.modal.getRoot().on(ModalEvents.shown,{diagnostic:this},(async function(e){var formdata={courseid:e.data.diagnostic.courseid};e.data.diagnostic.getQuizzes(formdata),$("div.local-diagnostic-base-block").length?$("div.local-diagnostic-base-block").html(""):$("body .popup-local-diagnostic-main-modal").after('<div class="local-diagnostic-base-block"><div/>'),await Templates.render("local_diagnostic/base",{}).done((function(data){$("body .local-diagnostic-base-block").html(data)}))})),this.modal.getRoot().on(ModalEvents.hidden,function(){void 0!==this.modal.getRoot().find(".daterange").data("daterangepicker")&&this.modal.getRoot().find(".daterange").data("daterangepicker").remove(),this.modal.setBody("")}.bind(this)),this.modal.getRoot().on(ModalEvents.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),this.modal}.bind(this))},Diagnostic.prototype.dateFormat=function(date){var d=new Date(date),month=""+(d.getMonth()+1),day=""+d.getDate(),year=d.getFullYear();return month.length<2&&(month="0"+month),day.length<2&&(day="0"+day),[month,day,year].join("/")},Diagnostic.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),formdata.imageTop=M.util.image_url("a/ufo_t","local_diagnostic"),formdata.imageContent=M.util.image_url("a/ufo_100","local_diagnostic"),formdata.secondarycolor=this.adParams[1].secondarylight,Templates.render("local_diagnostic/popup",formdata)},Diagnostic.prototype.handleFormSubmissionResponse=function(formData,response){if(response.result){let startDate=new Date,endDate=new Date;"daterange"in formData&&(startDate=new Date(formData.daterange.substr(0,10)),endDate=new Date(formData.daterange.substr(13))),this.formdata=response.templatedata;let diag=this;this.getBody(response.templatedata).then((function(result){diag.modal.setBody(result),ufoFilter();const bodyEl=$(".popup-local-diagnostic-main-p .modal-body").first();bodyEl&&bodyEl.addClass("modal-body-main"),diag.modal.getRoot().find(".modal-dialog").removeClass("modal-dialog-scrollable"),diag.modal.getRoot().find(".daterange").daterangepicker({parentEl:".popup-local-diagnostic-main-p .modal-body-main",startDate:startDate,endDate:endDate,locale:{format:"DD MMMM",direction:"daterange-custom"}}),diag.initQuizzes(response.templatedata.sections)}))}else this.modal.hide(),Notification.addNotification({message:response.message,type:"error"})},Diagnostic.prototype.initQuizzes=function(activitiesNow){let diag=this;Str.get_strings([{key:"submittext",component:"local_diagnostic"},{key:"events",component:"local_diagnostic"},{key:"noselection",component:"local_diagnostic"},{key:"daterange",component:"local_diagnostic"},{key:"activities",component:"local_diagnostic"}]).then((function(arr){Diagnostic.prototype.daterangePlaceholder&&$(".diagnostic input.daterange").val(arr[3]),diag.modal.getRoot().find(".cmids").multiselect({enableClickableOptGroups:!0,enableCollapsibleOptGroups:!1,disableIfEmpty:!0,includeSubmitOption:!0,submitText:arr[0],includeSubmitDivider:!0,nonSelectedText:arr[1],buttonWidth:"258px",templates:{popupContainer:'<div class="multiselect-container dropdown-menu">\n                                        <div class="multiselect-container-text">\n                                        </div>\n                                    </div>'},onInitialized:function(){let btnActivities=diag.modal.getRoot().find("button.multiselect");activitiesNow&&0!==activitiesNow.length?btnActivities.removeAttr("disabled"):btnActivities.attr("disabled",!0)},onChange:function(e){if(console.log("CHANGED"),console.log("REGISTER"),!e[0]||!e[0].value)return;let value=e[0].value;var formData={courseid:diag.courseid,cmids:value?[value]:[]};diag.getClusters(formData),diag.modal.getRoot().find(".multiselect-container.dropdown-menu").removeClass("show")},buttonText:function(options,select){return options&&options.length>0&&options[0]&&options[0].firstChild&&options[0].firstChild.data?options[0].firstChild.data:arr[4]},onDropdownShown:function(options,select){let popupEl=$("div.popup-local-diagnostic-main-p div.modal-body");$(".diagnostic .dropdown-menu").css("width",popupEl.width())}})}))},Diagnostic.prototype.getSelectedOptions=function(select){return select.val()},Diagnostic.prototype.handleFormSubmissionFailure=function(stage,data){this.modal.setBody(this.getBody(stage,data))},Diagnostic.prototype.submitFormAjax=function(e){e.preventDefault();let submitbtn=this.modal.getRoot().find("button.btn-primary");submitbtn.attr("disabled",!0);var changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each((function(index,element){element.dispatchEvent(changeEvent)}));var invalid=$.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));if(invalid.length)invalid.first().focus();else{this.modal.getRoot().find('input[type="checkbox"]').each((function(i,checkbox){$(checkbox).is(":checked")?$(checkbox).prop("checked",!0):$(checkbox).prop("checked",!1)}));var formData=this.modal.getRoot().find("form"),objectData={};$.each(formData,(function(){var self=this,json={},push_counters={},patterns={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/};this.build=function(base,key,value){return base[key]=value,base},this.push_counter=function(key){return void 0===push_counters[key]&&(push_counters[key]=0),push_counters[key]++},$.each($(this).serializeArray(),(function(){if(patterns.validate.test(this.name)){for(var k,keys=this.name.match(patterns.key),merge=this.value,reverse_key=this.name;void 0!==(k=keys.pop());)reverse_key=reverse_key.replace(new RegExp("\\["+k+"\\]$"),""),merge=k.match(patterns.push)?self.build([],self.push_counter(reverse_key),merge):self.build({},k,merge);json=$.extend(!0,json,merge)}})),objectData=json}));var submitData={jsonformdata:JSON.stringify(objectData)};Ajax.call([{methodname:"local_diagnostic_submit_"+this.stage+"_form",args:submitData,done:this.handleFormSubmissionResponse.bind(this,submitData),fail:Notification.exception}]),submitbtn.prop("disabled",!1)}},Diagnostic.prototype.getQuizzes=function(submitData){Ajax.call([{methodname:"local_diagnostic_get_quizzes",args:submitData,done:this.handleFormSubmissionResponse.bind(this,submitData),fail:Notification.exception}])},Diagnostic.prototype.getClusters=function(submitData){let self=this,loadingIcon=this.modal.getRoot().find('[data-region="loading-icon-container"]');this.modal.getRoot().find(".svgСharts").html(""),loadingIcon.removeClass("hidden");var request={methodname:"local_diagnostic_get_clusters",args:submitData};Ajax.call([request])[0].done((function(data){if(data.result){loadingIcon.addClass("hidden");let jsondata=JSON.parse(data.json);BuubleAnimation(".svgСharts",jsondata,"div.popup-local-diagnostic",self.adParams,self.courseid,jsondata.attempt,jsondata.mid,jsondata.cmid)}else Notification.addNotification({message:data.message,type:"error"})})).fail(Notification.exception)},Diagnostic.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},Diagnostic.prototype.object_build=function(base,key,value){return base[key]=value,base},Diagnostic.prototype.push_counter=function(key){return void 0===push_counters[key]&&(push_counters[key]=0),push_counters[key]++},{init:function(selector,courseid,adParams){new Diagnostic($(selector),courseid,adParams)}}}));

//# sourceMappingURL=main.min.js.map